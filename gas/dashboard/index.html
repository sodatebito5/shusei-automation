<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>守成クラブ福岡飯塚 ダッシュボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- カスタมCSS（style.htmlをインクルード） -->
  <?!= include('style') ?>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PDF生成用ライブラリ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- jsPDF autoTable プラグイン -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<!-- html2pdf.js（式次第PDF用） -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Google Fonts: Noto Sans JP -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600&display=swap" rel="stylesheet">

<!-- Google Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<!-- GASから埋め込まれた式次第データ -->
<script>
  const EMBEDDED_SHIKIDAI_DATA = <?!= shikidaiData ?>;
</script>

</head>

<body class="text-slate-900">
  <div class="max-w-6xl mx-auto px-4 py-6 space-y-5">
    <!-- ヘッダー -->
    <header class="dashboard-header flex items-center justify-between gap-4 rounded-xl">
      <div>
        <h1 class="dashboard-title text-xl md:text-2xl">
          守成クラブ 福岡飯塚
        </h1>
        <p class="text-xs text-slate-500 mt-0.5">管理ダッシュボード</p>
      </div>
      <!-- 改善リクエストボタン（一時非表示）
      <div class="flex items-center gap-3">
        <button class="request-header-btn" onclick="openRequestModal()" title="改善リクエスト">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        </button>
      </div>
      -->
      <div class="text-right">
        <div class="text-xs text-slate-400 mb-1">対象例会</div>
        <div id="eventName" class="event-badge">-</div>
      </div>
    </header>

    <!-- タブナビゲーション（2段構成） -->
    <div class="tab-nav">
      <!-- メインカテゴリ -->
      <div class="tab-main-row">
        <button class="tab-main-btn active" data-category="data">
          <span class="tab-main-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 4-6"/></svg>
          </span>
          <span>例会データ</span>
        </button>
        <button class="tab-main-btn" data-category="member">
          <span class="tab-main-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </span>
          <span>会員</span>
        </button>
        <button class="tab-main-btn" data-category="operation">
          <span class="tab-main-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          </span>
          <span>例会運営</span>
        </button>
      </div>
      <!-- サブタブ -->
      <div class="tab-sub-row">
        <div class="tab-sub-group active" data-category="data">
          <button class="tab-btn active" data-tab="summary-tab">概要</button>
          <button class="tab-btn" data-tab="attend-tab">出欠</button>
          <button class="tab-btn" data-tab="guest-tab">ゲスト</button>
          <button class="tab-btn" data-tab="other-venue-tab">他会場</button>
          <button class="tab-btn" data-tab="sales-tab">売上</button>
        </div>
        <div class="tab-sub-group" data-category="member">
          <button class="tab-btn" data-tab="team-tab">チーム</button>
          <button class="tab-btn" data-tab="contact-tab">連絡網</button>
          <button class="tab-btn" data-tab="renew-tab">更新</button>
          <button class="tab-btn" data-tab="member-tab">会員管理</button>
        </div>
        <div class="tab-sub-group" data-category="operation">
          <button class="tab-btn" data-tab="prep-tab">事前準備</button>
          <button class="tab-btn" data-tab="eventday-tab">当日</button>
          <button class="tab-btn" data-tab="meeting-tab">会議</button>
          <button class="tab-btn" data-tab="history-tab">履歴</button>
        </div>
      </div>
    </div>

    <!-- タブ中身 -->
    <div class="tab-panels">
      <!-- 📊 概要タブ -->
      <div id="summary-tab" class="tab-panel active">
        <!-- 今月のハイライト（2カラム） -->
<section class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
  <!-- 左カラム：参加関連 -->
  <div class="space-y-4">
    <!-- 参加ハイライト -->
    <div class="hl-attend-card">
      <div class="hl-attend-hero">
        <div class="hl-attend-hero-main">
          <span class="hl-attend-hero-label">参加総人数</span>
          <div class="hl-attend-hero-num">
            <span id="highlightTotalParticipants" class="hl-attend-hero-value">-</span>
            <span class="hl-attend-hero-unit">人</span>
          </div>
        </div>
        <div class="hl-attend-rate-ring" id="attendRateRing">
          <svg viewBox="0 0 80 80" class="hl-attend-rate-svg">
            <circle cx="40" cy="40" r="34" fill="none" stroke="#e2e8f0" stroke-width="6"/>
            <circle cx="40" cy="40" r="34" fill="none" stroke="url(#rateGrad)" stroke-width="6"
                    stroke-linecap="round" stroke-dasharray="213.6" stroke-dashoffset="213.6"
                    id="attendRateCircle" transform="rotate(-90 40 40)"/>
            <defs><linearGradient id="rateGrad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="var(--color-primary)"/>
              <stop offset="100%" stop-color="var(--color-primary-light)"/>
            </linearGradient></defs>
          </svg>
          <div class="hl-attend-rate-text">
            <span id="highlightAttendRate" class="hl-attend-rate-num">-</span>
            <span class="hl-attend-rate-pct">%</span>
          </div>
          <span class="hl-attend-rate-label">参加率</span>
        </div>
      </div>
      <div class="hl-attend-breakdown">
        <div class="hl-attend-seg hl-attend-seg--ok">
          <span class="hl-attend-seg-icon">&#x2714;</span>
          <span class="hl-attend-seg-label">出席</span>
          <span id="attendCount" class="hl-attend-seg-val">-</span>
        </div>
        <div class="hl-attend-seg hl-attend-seg--no">
          <span class="hl-attend-seg-icon">&#x2716;</span>
          <span class="hl-attend-seg-label">欠席</span>
          <span id="absentCount" class="hl-attend-seg-val">-</span>
        </div>
        <div class="hl-attend-seg hl-attend-seg--na">
          <span class="hl-attend-seg-icon">&#x2015;</span>
          <span class="hl-attend-seg-label">未回答</span>
          <span id="noAnswerCount" class="hl-attend-seg-val">-</span>
        </div>
        <div class="hl-attend-seg hl-attend-seg--party">
          <span class="hl-attend-seg-icon">&#x1F37B;</span>
          <span class="hl-attend-seg-label">2部会</span>
          <span id="afterPartyCount" class="hl-attend-seg-val">-</span>
        </div>
        <div class="hl-attend-seg-divider"></div>
        <div class="hl-attend-seg hl-attend-seg--guest">
          <span class="hl-attend-seg-icon">&#x1F464;</span>
          <span class="hl-attend-seg-label">ゲスト</span>
          <span id="highlightGuestCount" class="hl-attend-seg-val">-</span>
        </div>
        <div class="hl-attend-seg hl-attend-seg--other">
          <span class="hl-attend-seg-icon">&#x1F3E2;</span>
          <span class="hl-attend-seg-label">他会場</span>
          <span id="highlightOtherVenue" class="hl-attend-seg-val">-</span>
        </div>
      </div>
      <div class="hl-attend-members">
        <div class="hl-attend-members-left">
          <span class="hl-attend-members-label">稼働会員</span>
          <span id="memberCountMain" class="hl-attend-members-count">-</span>
          <span class="hl-attend-members-unit">人</span>
          <span id="memberDiff" class="hl-attend-members-diff">-</span>
        </div>
        <div class="hl-attend-badges">
          <span class="hl-attend-badge-chip"><span class="badge-icon">🥇</span><span id="goldCount" class="badge-count">-</span></span>
          <span class="hl-attend-badge-chip"><span class="badge-icon">🔴</span><span id="redCount" class="badge-count">-</span></span>
          <span class="hl-attend-badge-chip"><span class="badge-icon">🟢</span><span id="greenCount" class="badge-count">-</span></span>
        </div>
      </div>
    </div>

    <!-- アンケート結果（スマホ時は売上ハイライトの上に表示） -->
    <div class="modern-card" id="surveyResultsCard">
      <div class="modern-card-header">
        <h2 class="modern-card-title">
          <span class="modern-card-title-icon">📋</span>
          アンケート結果
        </h2>
        <span id="surveyEventLabel" class="text-xs text-slate-400"></span>
      </div>

      <!-- 回答率 -->
      <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm text-slate-600">回答率</span>
          <span class="text-sm font-semibold">
            <span id="surveyResponseRate" class="text-teal-600">-</span>%
            <span class="text-slate-400 font-normal ml-1">(<span id="surveyResponseCount">-</span>/<span id="surveySentCount">-</span>名)</span>
          </span>
        </div>
        <div class="w-full bg-slate-200 rounded-full h-2.5">
          <div id="surveyProgressBar" class="bg-teal-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>

      <!-- 満足度（Google口コミ風 横棒グラフ） -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <!-- 例会満足度 -->
        <div class="bg-blue-50 rounded-xl p-3">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-xs text-blue-600 font-medium">例会満足度</span>
            <span id="surveyMeetingScore" class="text-lg font-bold text-blue-700">-</span>
            <span id="surveyMeetingEmoji" class="text-lg">-</span>
          </div>
          <div id="surveyMeetingDistribution" class="space-y-1">
            <!-- JS で棒グラフを生成 -->
          </div>
        </div>
        <!-- 福岡飯塚満足度 -->
        <div class="bg-purple-50 rounded-xl p-3">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-xs text-purple-600 font-medium">福岡飯塚満足度</span>
            <span id="surveyClubScore" class="text-lg font-bold text-purple-700">-</span>
            <span id="surveyClubEmoji" class="text-lg">-</span>
          </div>
          <div id="surveyClubDistribution" class="space-y-1">
            <!-- JS で棒グラフを生成 -->
          </div>
        </div>
      </div>

      <!-- コメントセクション -->
      <div class="space-y-3">
        <!-- 良かった点 -->
        <div id="surveyGoodSection" class="hidden">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-emerald-600">👍</span>
            <span class="text-sm font-semibold text-slate-700">良かった点</span>
            <span id="surveyGoodCount" class="text-xs text-slate-400">(-件)</span>
          </div>
          <div id="surveyGoodComments" class="space-y-1.5 pl-6"></div>
        </div>

        <!-- 改善リクエスト -->
        <div id="surveyImproveSection" class="hidden">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-amber-600">📝</span>
            <span class="text-sm font-semibold text-slate-700">改善リクエスト</span>
            <span id="surveyImproveCount" class="text-xs text-slate-400">(-件)</span>
          </div>
          <div id="surveyImproveComments" class="space-y-1.5 pl-6"></div>
        </div>

        <!-- その他コメント -->
        <div id="surveyOtherSection" class="hidden">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-slate-500">💬</span>
            <span class="text-sm font-semibold text-slate-700">その他コメント</span>
            <span id="surveyOtherCount" class="text-xs text-slate-400">(-件)</span>
          </div>
          <div id="surveyOtherComments" class="space-y-1.5 pl-6"></div>
        </div>

        <!-- コメントなし時のメッセージ -->
        <div id="surveyNoComments" class="text-center text-slate-400 text-sm py-2 hidden">
          コメントはまだありません
        </div>
      </div>

      <!-- ローディング状態 -->
      <div id="surveyLoading" class="text-center text-slate-400 py-4">
        データ取得中...
      </div>

      <!-- データなし状態 -->
      <div id="surveyNoData" class="text-center text-slate-400 py-4 hidden">
        アンケートデータがありません
      </div>
    </div>
  </div>

  <!-- 右カラム：売上ハイライト -->
  <div class="space-y-4">
    <div class="hl-sales-card">
      <div class="hl-sales-title">
        売上ハイライト<span id="salesMonthLabel" class="hl-sales-month-label"></span>
      </div>
      <div class="hl-sales-hero">
        <span class="hl-sales-hero-label">売上合計</span>
        <div class="hl-sales-hero-num">
          <span id="highlightSalesTotal" class="hl-sales-hero-value">-</span>
          <span class="hl-sales-hero-unit">円</span>
        </div>
      </div>
      <div class="hl-sales-metrics">
        <div class="hl-sales-metric">
          <div class="hl-sales-metric-icon hl-sales-metric-icon--reporter">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
          </div>
          <span class="hl-sales-metric-label">報告</span>
          <span id="highlightReporterCount" class="hl-sales-metric-val">-</span>
          <span class="hl-sales-metric-unit">人</span>
        </div>
        <div class="hl-sales-metric">
          <div class="hl-sales-metric-icon hl-sales-metric-icon--meeting">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          </div>
          <span class="hl-sales-metric-label">商談</span>
          <span id="highlightMeetingsCount" class="hl-sales-metric-val">-</span>
          <span class="hl-sales-metric-unit">件</span>
        </div>
        <div class="hl-sales-metric">
          <div class="hl-sales-metric-icon hl-sales-metric-icon--deal">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          </div>
          <span class="hl-sales-metric-label">成約</span>
          <span id="highlightDealCount" class="hl-sales-metric-val">-</span>
          <span class="hl-sales-metric-unit">件</span>
        </div>
      </div>
    </div>
  </div>

</section>

        <!-- 2カラム：ゲスト & 売上 -->
<section class="grid grid-cols-1 md:grid-cols-2 gap-5">
  <!-- 左：ゲスト申請状況 -->
  <div class="modern-card">
    <div class="modern-card-header">
      <h2 class="modern-card-title">
        <span class="modern-card-title-icon">👥</span>
        ゲスト申請状況
      </h2>
      <div id="guestSummary" class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full">-</div>
    </div>
    <table class="modern-table">
      <thead>
        <tr>
          <th>ゲスト名</th>
          <th>紹介者</th>
          <th>承認</th>
        </tr>
      </thead>
      <tbody id="guestListBody">
        <tr>
          <td colspan="3" class="py-3 text-slate-400 text-center">データ取得中...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 右：入会希望業種 -->
  <div class="modern-card">
    <div class="modern-card-header">
      <h2 class="modern-card-title">
        <span class="modern-card-title-icon">📋</span>
        入会希望業種
      </h2>
    </div>
    <div id="industryListBody" class="space-y-2 p-3">
      <div class="text-slate-400 text-center py-3">データ取得中...</div>
    </div>
  </div>

  <!-- 右：売上ランキング（非表示）
  <div class="modern-card">
    <div class="modern-card-header">
      <h2 class="modern-card-title">
        <span class="modern-card-title-icon">🏆</span>
        会員別 売上ランキング
      </h2>
    </div>
    <div id="salesRankingBody" class="space-y-1">
      <div class="text-sm text-slate-400 text-center py-4">データ取得中...</div>
    </div>
  </div>
  -->
</section>

      </div>

      <!-- 出欠タブ -->
      <div id="attend-tab" class="tab-panel">
        <section class="modern-card mt-4">
          <div class="modern-card-header">
            <h2 class="modern-card-title">
              <span class="modern-card-title-icon">✓</span>
              出欠管理
            </h2>
            <div class="flex flex-wrap items-center gap-3">
              <div class="flex flex-wrap gap-3 text-xs">
                <span class="bg-emerald-50 text-emerald-700 px-2 py-1 rounded-full">出席: <span id="attendCountAttend" class="font-semibold">0 名</span></span>
                <span class="bg-red-50 text-red-700 px-2 py-1 rounded-full">欠席: <span id="attendCountAbsent" class="font-semibold">0 名</span></span>
                <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded-full">未回答: <span id="attendCountNoAnswer" class="font-semibold">0 名</span></span>
                <span class="bg-amber-50 text-amber-700 px-2 py-1 rounded-full">2部会: <span id="attendCountAfterParty" class="font-semibold">0 名</span></span>
              </div>
              <button id="reminderManageBtn" onclick="openReminderModal()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition-colors">
                出欠リマインド管理
              </button>
            </div>
          </div>
          <p class="text-xs text-slate-500 mb-4">
            出席・欠席は回答時間の早い順に表示しています。右側にはまだ回答がない会員を表示します。
          </p>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- 出席 -->
            <div class="bg-emerald-50/50 border border-emerald-100 rounded-xl p-4">
              <h3 class="text-sm font-semibold text-emerald-700 mb-3 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                出席
              </h3>
              <div id="attendListAttend" class="grid grid-cols-2 gap-2 text-xs md:text-sm"></div>
            </div>

            <!-- 欠席 -->
            <div class="bg-red-50/50 border border-red-100 rounded-xl p-4">
              <h3 class="text-sm font-semibold text-red-700 mb-3 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                欠席
              </h3>
              <div id="attendListAbsent" class="grid grid-cols-2 gap-2 text-xs md:text-sm"></div>
            </div>

            <!-- 未回答 -->
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
              <h3 class="text-sm font-semibold text-slate-600 mb-3 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                未回答
              </h3>
              <div id="attendListNoAnswer" class="grid grid-cols-2 gap-2 text-xs md:text-sm"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ゲストタブ -->
<div id="guest-tab" class="tab-panel">
  <section class="modern-card mt-4">
    <div class="modern-card-header">
      <h2 class="modern-card-title">
        <span class="modern-card-title-icon">👥</span>
        ゲスト管理
      </h2>
    </div>
    <p class="text-xs text-slate-500 mb-4">
      現在の例会（右上の例会名）に紐づくゲストだけを表示しています。
    </p>

    <div class="overflow-x-auto -mx-4 px-4">
      <table class="modern-table" style="min-width: 900px;">
        <thead>
          <tr>
            <th>氏名</th>
            <th>フリガナ</th>
            <th>会社名</th>
            <th>役職</th>
            <th>紹介者</th>
            <th style="min-width: 200px;">営業内容</th>
          </tr>
        </thead>
        <tbody id="guestDetailBody">
          <tr>
            <td colspan="6" class="py-3 text-slate-400 text-center">
              データ取得中...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>

<!-- 他会場タブ -->
<div id="other-venue-tab" class="tab-panel">
  <section class="modern-card mt-4">
    <div class="modern-card-header">
      <h2 class="modern-card-title">
        <span class="modern-card-title-icon">🏢</span>
        他会場会員
      </h2>
    </div>
    <p class="text-xs text-slate-500 mb-4">
      現在の例会に参加する他会場会員を表示しています。
    </p>

    <div class="overflow-x-auto -mx-4 px-4">
      <table class="modern-table" style="min-width: 900px;">
        <thead>
          <tr>
            <th style="writing-mode: vertical-rl; text-orientation: upright; white-space: nowrap; padding: 8px 4px; letter-spacing: 0.1em;">ブース</th>
            <th>氏名</th>
            <th>フリガナ</th>
            <th>所属</th>
            <th>役割</th>
            <th>会社名</th>
            <th>役職</th>
            <th>紹介者</th>
            <th style="min-width: 200px;">営業内容</th>
          </tr>
        </thead>
        <tbody id="otherVenueDetailBody">
          <tr>
            <td colspan="9" class="py-3 text-slate-400 text-center">
              データ取得中...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>


      <!-- 売上タブ -->
<div id="sales-tab" class="tab-panel">
  <section class="modern-card mt-4">
    <!-- ★個別売上ボタン -->
    <div class="modern-card-header">
      <div>
        <h2 class="modern-card-title">
          <span class="modern-card-title-icon">💰</span>
          売上集計
        </h2>
        <p class="text-xs text-slate-500 mt-1">
          月別の売上推移と累計を表示しています。
        </p>
      </div>
      <button id="individualSalesBtn" onclick="openIndividualSalesModal()" class="px-4 py-2 bg-gradient-to-r from-teal-500 to-teal-600 text-white text-sm rounded-lg hover:from-teal-600 hover:to-teal-700 transition shadow-sm">
        個別売上
      </button>
    </div>

    <!-- ★通常の売上サマリービュー -->
    <div id="salesSummaryView">
      <!-- ★追加：0件含む報告者一覧 -->
      <div id="zeroListSection" class="border border-amber-300 bg-amber-50 rounded-xl p-4 mb-4 hidden">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-amber-600">⚠️</span>
          <span class="text-sm font-semibold text-amber-800">要確認：0件を含む報告</span>
          <span id="zeroListCount" class="text-xs text-amber-600"></span>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-xs md:text-sm border-collapse">
            <thead>
              <tr class="bg-amber-100 text-amber-800">
                <th class="py-1 px-2 text-left border border-amber-200">氏名</th>
                <th class="py-1 px-2 text-center border border-amber-200">商談件数</th>
                <th class="py-1 px-2 text-center border border-amber-200">成約件数</th>
                <th class="py-1 px-2 text-right border border-amber-200">売上金額</th>
              </tr>
            </thead>
            <tbody id="zeroListBody"></tbody>
          </table>
        </div>
      </div>


      <!-- 月別推移グラフ -->
      <div class="border border-slate-200 rounded-xl p-4 mb-4">
        <div class="text-base md:text-lg font-semibold mb-2">
          月別推移（7期目）
        </div>
        <div style="height: 300px;">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>

      <!-- 累計表示（オプション） -->
      <div class="grid grid-cols-2 gap-4">
        <div class="mini-stat-card" style="padding: 1.25rem;">
          <div class="mini-stat-label">累計成約件数</div>
          <div id="totalDealCount" class="stat-value" style="color: var(--color-primary);">-</div>
        </div>
        <div class="mini-stat-card" style="padding: 1.25rem;">
          <div class="mini-stat-label">累計売上金額</div>
          <div id="totalSalesAmount" class="stat-value whitespace-nowrap" style="font-size: 1.25rem; color: var(--color-primary-dark);">-</div>
        </div>
      </div>
    </div>

    <!-- ★個別売上ビュー（パスワード認証後に表示） -->
    <div id="individualSalesView" class="hidden">
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-3">
          <select id="salesMonthSelect" onchange="loadIndividualSalesData()" class="px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">月を選択</option>
          </select>
          <span class="text-sm text-slate-500">の売上報告一覧</span>
        </div>
        <button onclick="hideIndividualSalesView()" class="px-3 py-2 bg-slate-200 text-slate-700 text-sm rounded-lg hover:bg-slate-300 transition">
          ← 戻る
        </button>
      </div>
      <div id="individualSalesData">
        <!-- データがここに描画される -->
      </div>
    </div>
  </section>
</div>

      <!-- 更新タブ -->
<div id="renew-tab" class="tab-panel">
  <section class="modern-card mt-4">
    <div class="modern-card-header">
      <h2 class="modern-card-title">
        <span class="modern-card-title-icon">🔁</span>
        更新予定
      </h2>
    </div>
    <p class="text-xs text-slate-500 mb-4">
      翌月・再来月に更新を迎える会員を表示しています。
    </p>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
      <!-- 来月 -->
      <div class="bg-amber-50/50 border border-amber-100 rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 id="nextMonthLabel" class="text-sm font-semibold text-amber-800 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-amber-500"></span>
            来月更新
          </h3>
          <span id="nextMonthCount" class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full font-medium">0 名</span>
        </div>
        <div id="nextMonthContainer" class="grid grid-cols-2 lg:grid-cols-3 gap-2"></div>
      </div>
      <!-- 再来月 -->
      <div class="bg-blue-50/50 border border-blue-100 rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 id="next2MonthLabel" class="text-sm font-semibold text-blue-800 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
            再来月更新
          </h3>
          <span id="next2MonthCount" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">0 名</span>
        </div>
        <div id="next2MonthContainer" class="grid grid-cols-2 lg:grid-cols-3 gap-2"></div>
      </div>
    </div>
  </section>
</div>


      <!-- チームタブ -->
      <div id="team-tab" class="tab-panel">
        <section class="modern-card mt-4">
          <div class="modern-card-header">
            <h2 class="modern-card-title">
              <span class="modern-card-title-icon">🧩</span>
              チーム構成
            </h2>
          </div>
          <p class="text-xs text-slate-500 mb-4">
            チーム毎にグルーピングしています。どこにも所属してない会員は「未配属」に表示されます。
          </p>
          <div id="teamContainer"
               class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>
      </div>

      <!-- 連絡網タブ -->
      <div id="contact-tab" class="tab-panel">
        <section class="modern-card mt-4">
          <div class="modern-card-header flex justify-between items-center">
            <h2 class="modern-card-title">
              <span class="modern-card-title-icon">📞</span>
              連絡網グループ
            </h2>
            <button onclick="printContactGroups()" class="contact-print-btn">
              🖨️ 印刷プレビュー
            </button>
          </div>
          <div id="contactPrintArea">
            <div class="contact-print-title">連絡網グループ一覧</div>
            <div class="contact-scroll-wrapper">
              <div id="contactGroupsContainer" class="space-y-3">
                <div class="text-center text-slate-500 py-8">読み込み中...</div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ★ 例会事前準備タブ -->
      <div id="prep-tab" class="tab-panel">
        <section class="modern-card mt-4">
          <!-- メニュー画面 -->

<div id="prepMenuSection">
  <div class="modern-card-header">
    <h2 class="modern-card-title">
      <span class="modern-card-title-icon">📋</span>
      例会事前準備
    </h2>
  </div>
  <p class="text-xs text-slate-500 mb-5">
    印刷用の参加者名簿・受付名簿を表示します。
  </p>

  <!-- 参加者名簿 -->
  <div class="mb-5 p-4 bg-slate-50 rounded-xl border border-slate-100">
    <div class="text-sm text-slate-700 font-semibold mb-3 flex items-center gap-2">
      <span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span>
      参加者名簿
    </div>
    <div class="flex flex-wrap gap-2">
      <button
        id="btnLocalRoster"
        data-prep-target="local"
        class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-slate-200 bg-white hover:bg-slate-50 hover:border-slate-300 transition-all shadow-sm"
      >
        福岡飯塚会場
      </button>
      <button
        id="btnOthersRoster"
        data-prep-target="others"
        class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-slate-200 bg-white hover:bg-slate-50 hover:border-slate-300 transition-all shadow-sm"
      >
        他会場・ゲスト
      </button>
    </div>
  </div>

  <!-- 受付名簿 -->
  <div class="mb-5 p-4 bg-teal-50/50 rounded-xl border border-teal-100">
    <div class="text-sm text-teal-800 font-semibold mb-3 flex items-center gap-2">
      <span class="w-1.5 h-1.5 rounded-full bg-teal-500"></span>
      受付名簿
    </div>
    <div class="flex flex-wrap gap-2">
      <button
        id="btnReceptionLocal"
        class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-teal-200 bg-white hover:bg-teal-50 hover:border-teal-300 transition-all shadow-sm text-teal-700"
      >
        福岡飯塚
      </button>
      <button
        id="btnReceptionOthers"
        class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-teal-200 bg-white hover:bg-teal-50 hover:border-teal-300 transition-all shadow-sm text-teal-700"
      >
        他会場・ゲスト
      </button>
    </div>
  </div>

  <!-- 式次第 -->
  <div class="mb-5 p-4 bg-emerald-50/50 rounded-xl border border-emerald-100">
    <div class="text-sm text-emerald-800 font-semibold mb-3 flex items-center gap-2">
      <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
      式次第
    </div>
    <div class="flex flex-wrap gap-2">
      <button
        id="btnShikidaiEdit"
        class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-emerald-200 bg-white hover:bg-emerald-50 hover:border-emerald-300 transition-all shadow-sm text-emerald-700"
      >
        編集
      </button>
      <button
        id="btnShikidaiPreview"
        class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-emerald-200 bg-white hover:bg-emerald-50 hover:border-emerald-300 transition-all shadow-sm text-emerald-700"
      >
        プレビュー
      </button>
      <button
        id="btnUpdateOtherVenue"
        class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-blue-200 bg-white hover:bg-blue-50 hover:border-blue-300 transition-all shadow-sm text-blue-700"
      >
        他会場日程を更新
      </button>
      <button
        id="btnSyncFormToOtherVenue"
        class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-purple-200 bg-white hover:bg-purple-50 hover:border-purple-300 transition-all shadow-sm text-purple-700"
      >
        フォーム回答を同期
      </button>
    </div>
  </div>

  <!-- 自動配席 -->
  <div class="mb-4 p-4 bg-amber-50/50 rounded-xl border border-amber-100">
    <div class="text-sm text-amber-800 font-semibold mb-3 flex items-center gap-2">
      <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
      自動配席
    </div>
    <div class="flex flex-wrap gap-2">
      <a
        href="https://shusei-seat-manager.pages.dev/"
        target="_blank"
        rel="noopener noreferrer"
        class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-amber-200 bg-white hover:bg-amber-50 hover:border-amber-300 transition-all shadow-sm text-amber-700 inline-flex items-center gap-1.5"
      >
        配席アプリを開く
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
      </a>
    </div>
    <p class="text-xs text-slate-400 mt-2">別ウィンドウで配席アプリが開きます</p>
  </div>
</div>
  

          <!-- プレビュー画面 -->
      <div id="prepPreviewSection" class="hidden mt-2">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 id="prepPreviewTitle" class="text-sm font-semibold mb-1"></h2>
            <p class="text-xs text-slate-500">
              ブラウザの印刷機能から、そのまま印刷できます。（1ページ30名固定）
            </p>
          </div>
          <div class="flex gap-2">
            <button
              id="prepBackButton"
              type="button"
              class="text-xs px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100"
            >
              ← 選択に戻る
            </button>
            <button
              id="prepPdfPreviewButton"
              type="button"
              class="text-xs px-3 py-1 rounded-full border border-blue-400 text-blue-600 hover:bg-blue-50 font-medium"
            >
              👁 PDFプレビュー
            </button>
            <button
              id="prepPrintButton"
              type="button"
              class="text-xs px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100"
              >
              📄 PDF保存
              </button>
          </div>
        </div>

    <div id="prepPreviewContainer"></div>
      </div>

     <!-- 式次第編集画面 -->
          <div id="shikidaiEditSection" class="hidden mt-2">
            <div class="bg-white rounded p-4">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-semibold">式次第編集</h2>
                <div class="flex gap-2">
                  <button
                    id="shikidaiSaveButton"
                    type="button"
                    class="px-4 py-2 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                  >
                    💾 保存
                  </button>
                  <button
                    id="shikidaiBackFromEdit"
                    type="button"
                    class="px-4 py-2 border text-xs rounded hover:bg-slate-100"
                  >
                    戻る
                  </button>
                </div>
              </div>

              <!-- 司会進行セクション -->
              <div class="mb-4">
                <h3 class="text-xs font-semibold text-slate-700 mb-2">司会進行</h3>
                <div class="flex gap-4">
                  <div class="flex-1">
                    <label class="block text-xs text-slate-500 mb-1">担当者1</label>
                    <input type="text" id="mcPerson1" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：荒井会員">
                  </div>
                  <div class="flex-1">
                    <label class="block text-xs text-slate-500 mb-1">担当者2</label>
                    <input type="text" id="mcPerson2" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：牛島会員">
                  </div>
                </div>
              </div>

              <!-- タイムテーブル編集 -->
              <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-xs font-semibold text-slate-700">タイムテーブル</h3>
                  <button
                    id="shikidaiAddRowButton"
                    type="button"
                    class="px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600"
                  >
                    ＋ 行追加
                  </button>
                </div>
                <div class="overflow-x-auto">
                  <table class="w-full text-xs border-collapse">
                    <thead>
                      <tr class="bg-slate-100">
                        <th class="border px-2 py-1 w-16">時間</th>
                        <th class="border px-2 py-1">項目</th>
                        <th class="border px-2 py-1 w-24">担当者</th>
                        <th class="border px-2 py-1 w-28">備考</th>
                        <th class="border px-2 py-1 w-16">操作</th>
                      </tr>
                    </thead>
                    <tbody id="shikidaiTimeTableBody">
                      <!-- JSで動的に生成 -->
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- お知らせ編集 -->
              <div>
                <h3 class="text-xs font-semibold text-slate-700 mb-2">お知らせ・案内文</h3>
                <div class="overflow-x-auto">
                  <table class="w-full text-xs border-collapse">
                    <thead>
                      <tr class="bg-slate-100">
                        <th class="border px-2 py-1 w-28">種別</th>
                        <th class="border px-2 py-1">内容</th>
                      </tr>
                    </thead>
                    <tbody id="shikidaiNoticesBody">
                      <!-- JSで動的に生成 -->
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- デバッグ用 -->
              <details class="mt-4">
                <summary class="text-xs text-slate-400 cursor-pointer">デバッグ: 生データ</summary>
                <div id="shikidaiTestResult" class="mt-2 p-2 bg-slate-100 rounded text-xs overflow-auto max-h-40"></div>
              </details>
            </div>
          </div>

          <!-- 式次第プレビュー画面 -->
          <div id="shikidaiPreviewSection" class="hidden mt-2" style="overflow: visible; height: auto; max-height: none;">
            <div class="bg-white rounded p-4" style="overflow: visible; height: auto; max-height: none;">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-semibold">式次第プレビュー</h2>
                <div class="flex gap-2">
                  <button
                    id="shikidaiRefreshButton"
                    type="button"
                    class="px-4 py-2 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                  >
                    🔄 更新
                  </button>
                  <button
                    id="shikidaiPrintButton"
                    type="button"
                    class="px-4 py-2 bg-green-500 text-white text-xs rounded hover:bg-green-600"
                  >
                    📄 PDF保存
                  </button>
                  <button
                    id="shikidaiPreviewBack"
                    type="button"
                    class="px-4 py-2 border text-xs rounded hover:bg-slate-100"
                  >
                    戻る
                  </button>
                </div>
              </div>
              <div id="shikidaiPreviewContent" class="shikidai-wrapper">
                <!-- A4プレビューがここに描画される -->
              </div>
            </div>
          </div>


    </section>
  </div>

   <!-- ★ 例会当日タブ -->
  <div id="eventday-tab" class="tab-panel">
    <!-- メニュー画面 -->
    <section id="eventdayMenuSection" class="modern-card mt-4">
      <div class="modern-card-header">
        <h2 class="modern-card-title">
          <span class="modern-card-title-icon">📅</span>
          例会当日メニュー
        </h2>
      </div>
      <p class="text-xs text-slate-500 mb-4">
        役割分担やチェックイン機能を管理します。
      </p>
      <div class="flex flex-wrap gap-2">
        <button
          id="btnRoleAssignment"
          class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-slate-200 bg-white hover:bg-slate-50 hover:border-slate-300 transition-all shadow-sm"
        >
          役割分担
        </button>
        <button
          id="btnRoleEdit"
          class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-emerald-200 bg-white hover:bg-emerald-50 hover:border-emerald-300 transition-all shadow-sm text-emerald-700"
        >
          役割分担編集
        </button>
        <button
          id="btnSeatingChart"
          class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-blue-200 bg-white hover:bg-blue-50 hover:border-blue-300 transition-all shadow-sm text-blue-700"
        >
          配席表
        </button>
        <button
          id="btnCheckin"
          class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-amber-200 bg-white hover:bg-amber-50 hover:border-amber-300 transition-all shadow-sm text-amber-700"
        >
          チェックイン管理
        </button>
        <button
          id="btnSurveyManage"
          onclick="openSurveyModal()"
          class="prep-menu-btn px-4 py-2.5 text-xs md:text-sm rounded-lg border border-purple-200 bg-white hover:bg-purple-50 hover:border-purple-300 transition-all shadow-sm text-purple-700"
        >
          アンケート送信管理
        </button>
      </div>
    </section>

    <!-- チェックイン管理画面 -->
    <section id="checkinSection" class="hidden bg-white rounded-xl shadow p-3 md:p-4 mt-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm md:text-base font-bold text-slate-800">📋 チェックイン管理</h2>
        <button
          id="checkinBackButton"
          type="button"
          class="text-xs px-3 py-1.5 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100 active:bg-slate-200"
        >
          ← 戻る
        </button>
      </div>

      <!-- サマリー -->
      <div id="checkinSummary" class="grid grid-cols-3 md:grid-cols-5 gap-2 mb-4">
        <div class="mini-stat-card">
          <div class="mini-stat-label">到着</div>
          <div id="checkinArrived" class="mini-stat-value" style="color: #059669;">-/-</div>
        </div>
        <div class="mini-stat-card" style="background: #faf5ff;">
          <div class="mini-stat-label">キャンセル</div>
          <div id="checkinCancelled" class="mini-stat-value" style="color: #9333ea;">-</div>
        </div>
        <div class="mini-stat-card" style="background: #eff6ff;">
          <div class="mini-stat-label">バッジ貸出中</div>
          <div id="checkinBadgeLent" class="mini-stat-value" style="color: #2563eb;">-</div>
        </div>
        <div class="mini-stat-card" style="background: #fef2f2;">
          <div class="mini-stat-label">バッジ未返却</div>
          <div id="checkinBadgeNotReturned" class="mini-stat-value" style="color: #dc2626;">-</div>
        </div>
        <div class="mini-stat-card" style="background: #f5f3ff;">
          <div class="mini-stat-label">最終更新</div>
          <div id="checkinLastUpdate" class="mini-stat-value text-xs" style="color: #7c3aed;">--:--</div>
        </div>
      </div>

      <!-- フィルタ・操作ボタン -->
      <div class="flex flex-wrap items-center gap-2 mb-4">
        <button onclick="filterCheckin('all')" class="checkin-filter-btn active px-3 py-1.5 text-xs rounded-lg border border-teal-200 bg-teal-50 text-teal-700 font-medium" data-filter="all">全員</button>
        <button onclick="filterCheckin('arrived')" class="checkin-filter-btn px-3 py-1.5 text-xs rounded-lg border border-slate-200 hover:bg-slate-50 font-medium" data-filter="arrived">到着済</button>
        <button onclick="filterCheckin('notArrived')" class="checkin-filter-btn px-3 py-1.5 text-xs rounded-lg border border-slate-200 hover:bg-slate-50 font-medium" data-filter="notArrived">未到着</button>
        <button onclick="filterCheckin('badgeNotReturned')" class="checkin-filter-btn px-3 py-1.5 text-xs rounded-lg border border-red-200 hover:bg-red-50 text-red-600 font-medium" data-filter="badgeNotReturned">未返却</button>
        <div class="flex-1"></div>
        <button onclick="refreshCheckinStatus()" class="px-3 py-1.5 text-xs rounded-lg border border-slate-300 hover:bg-slate-100 font-medium">
          🔄 更新
        </button>
        <!-- 管理者メニュー（折りたたみ） -->
        <details class="relative">
          <summary class="px-3 py-1.5 text-xs rounded-lg border border-slate-300 hover:bg-slate-100 font-medium cursor-pointer list-none flex items-center gap-1">
            ⚙️ 管理
          </summary>
          <div class="absolute right-0 top-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg p-2 z-10 min-w-[140px]">
            <button onclick="initCheckinData()" class="w-full px-3 py-2 text-xs rounded-lg border border-amber-300 bg-amber-50 hover:bg-amber-100 text-amber-700 font-medium">
              📥 データ初期化
            </button>
          </div>
        </details>
      </div>

      <!-- 会員リスト -->
      <div class="mb-4">
        <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-1">
          <span class="text-base">👔</span> 福岡飯塚会員
          <span id="checkinMemberCount" class="text-xs text-slate-400 font-normal ml-2">(-人)</span>
        </h3>
        <div id="checkinMemberList" class="space-y-1">
          <div class="text-center text-slate-400 py-4">読み込み中...</div>
        </div>
      </div>

      <!-- 他会場リスト -->
      <div class="mb-4">
        <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-1">
          <span class="text-base">🏢</span> 他会場参加者
          <span id="checkinOtherCount" class="text-xs text-slate-400 font-normal ml-2">(-人)</span>
        </h3>
        <div id="checkinOtherList" class="space-y-1">
          <div class="text-center text-slate-400 py-4">-</div>
        </div>
      </div>

      <!-- ゲストリスト -->
      <div class="mb-4">
        <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-1">
          <span class="text-base">🎁</span> ゲスト
          <span id="checkinGuestCount" class="text-xs text-slate-400 font-normal ml-2">(-人)</span>
        </h3>
        <div id="checkinGuestList" class="space-y-1">
          <div class="text-center text-slate-400 py-4">-</div>
        </div>
      </div>
    </section>

    <!-- 役割分担プレビュー画面 -->
<section id="rolePreviewSection" class="hidden bg-white rounded-xl shadow p-3 md:p-4 mt-4">
  <div class="flex items-center justify-between mb-4">
    <h2 id="rolePreviewTitle" class="text-sm md:text-base font-bold text-slate-800"></h2>
    <button
      id="roleBackButton"
      type="button"
      class="text-xs px-3 py-1.5 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100 active:bg-slate-200"
    >
      ← 戻る
    </button>
  </div>

  <!-- スマホ: 縦並び / PC: 横並び -->
  <div class="flex flex-col md:flex-row gap-4">

    <!-- テーブルマスター表 -->
    <div class="md:w-1/3">
      <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-1">
        <span class="text-base">🪑</span> テーブルマスター
      </h3>
      <div class="bg-slate-50 rounded-lg p-2">
        <table class="w-full text-sm border-collapse">
          <thead>
            <tr>
              <th class="bg-slate-200 text-slate-700 py-2 px-3 text-center font-bold rounded-tl-lg w-16">席</th>
              <th class="bg-slate-200 text-slate-700 py-2 px-3 text-left font-bold rounded-tr-lg">担当</th>
            </tr>
          </thead>
          <tbody id="tableMasterBody">
            <!-- JSで動的生成 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 役割分担表示 -->
    <div class="md:flex-1">
      <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-1">
        <span class="text-base">👔</span> 役割分担
      </h3>
      <div id="roleDisplayTable" class="bg-slate-50 rounded-lg p-2">
        <!-- JSで動的生成 -->
      </div>
    </div>

  </div>
</section>

<!-- 役割分担編集画面 -->
<section id="roleEditSection" class="hidden bg-white rounded-xl shadow p-3 md:p-4 mt-4">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-sm md:text-base font-bold text-slate-800">✏️ 役割分担編集</h2>
    <button
      id="roleEditBackButton"
      type="button"
      class="text-xs px-3 py-1.5 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100 active:bg-slate-200"
    >
      ← 戻る
    </button>
  </div>

  <!-- 役割編集カード -->
  <div id="roleEditCards" class="space-y-2">
    <!-- JSで動的生成 -->
  </div>

  <!-- 保存ボタン（固定表示） -->
  <div class="sticky bottom-0 bg-white pt-3 pb-1 mt-4 border-t border-slate-200">
    <div class="flex items-center gap-3">
      <button onclick="saveRoleAssignments()" class="flex-1 md:flex-none px-6 py-3 bg-green-600 text-white text-base font-bold rounded-xl hover:bg-green-700 active:bg-green-800 transition-colors shadow-lg">
        💾 保存する
      </button>
      <span id="roleSaveMessage" class="text-sm hidden"></span>
    </div>
  </div>
</section>
  </div>

  <!-- ★ 会員管理タブ -->
  <div id="member-tab" class="tab-panel">
    <section class="modern-card mt-4">
      <div class="modern-card-header">
        <h2 class="modern-card-title">
          <span class="modern-card-title-icon">👥</span>
          会員名簿管理
        </h2>
      </div>

      <!-- 検索・追加バー -->
      <div class="member-search-bar">
        <div class="member-search-wrapper">
          <span class="member-search-icon">🔍</span>
          <input type="text" id="memberSearchInput" class="member-search-input" placeholder="名前・フリガナ・会社名で検索..." oninput="filterMembers()">
        </div>
        <button class="member-add-btn" onclick="openMemberModal(null)">
          ➕ 新規追加
        </button>
      </div>

      <!-- フィルタ行 -->
      <div class="member-filter-row">
        <span class="member-filter-label">絞り込み:</span>
        <select id="memberTeamFilter" class="member-filter-select" onchange="filterMembers()">
          <option value="">チーム: 全て</option>
        </select>
        <select id="memberBadgeFilter" class="member-filter-select" onchange="filterMembers()">
          <option value="">バッジ: 全て</option>
          <option value="ゴ">🥇 ゴールド</option>
          <option value="正">🔴 正会員</option>
          <option value="準">🟢 準会員</option>
          <option value="紫">🟣 紫バッジ</option>
          <option value="ダイヤ">💎 ダイヤ</option>
        </select>
        <select id="memberRenewalFilter" class="member-filter-select" onchange="filterMembers()">
          <option value="">更新月: 全て</option>
          <option value="1">1月</option>
          <option value="2">2月</option>
          <option value="3">3月</option>
          <option value="4">4月</option>
          <option value="5">5月</option>
          <option value="6">6月</option>
          <option value="7">7月</option>
          <option value="8">8月</option>
          <option value="9">9月</option>
          <option value="10">10月</option>
          <option value="11">11月</option>
          <option value="12">12月</option>
        </select>
        <label class="member-checkbox-label">
          <input type="checkbox" id="memberShowRetiredOnly" onchange="loadMembersForEdit()">
          退会者のみ表示
        </label>
        <div class="member-count-display">
          会員数: <strong id="memberCountDisplay">-</strong>名
        </div>
      </div>

      <!-- 会員一覧 -->
      <div id="memberCardGrid" class="member-card-grid">
        <div class="member-loading">
          <div class="member-loading-spinner"></div>
          <p>会員データを読み込み中...</p>
        </div>
      </div>
    </section>
  </div>

  <!-- 会員編集モーダル -->
  <div id="memberModal" class="member-modal">
    <div class="member-modal-overlay" onclick="closeMemberModal()"></div>
    <div class="member-modal-content">
      <div class="member-modal-header">
        <h3 class="member-modal-title">
          <span id="memberModalIcon">✏️</span>
          <span id="memberModalTitle">会員情報編集</span>
        </h3>
        <button class="member-modal-close" onclick="closeMemberModal()">×</button>
      </div>
      <div class="member-modal-body">
        <input type="hidden" id="memberEditRowIndex">

        <!-- 基本情報 -->
        <div class="member-form-section">
          <div class="member-form-section-title">📋 基本情報</div>
          <div class="member-form-grid">
            <div class="member-form-group">
              <label class="member-form-label">会員ID</label>
              <input type="text" id="memberEditId" class="member-form-input" disabled>
            </div>
            <div class="member-form-group">
              <label class="member-form-label">バッジ</label>
              <select id="memberEditBadge" class="member-form-select">
                <option value="">なし</option>
                <option value="ゴ">🥇 ゴールド</option>
                <option value="正">🔴 正会員</option>
                <option value="準">🟢 準会員</option>
                <option value="紫">🟣 紫バッジ</option>
                <option value="ダイヤ">💎 ダイヤ</option>
              </select>
            </div>
            <div class="member-form-group">
              <label class="member-form-label">氏名 *</label>
              <input type="text" id="memberEditName" class="member-form-input" required>
            </div>
            <div class="member-form-group">
              <label class="member-form-label">フリガナ</label>
              <input type="text" id="memberEditFurigana" class="member-form-input">
            </div>
          </div>
        </div>

        <!-- 所属情報 -->
        <div class="member-form-section">
          <div class="member-form-section-title">🏢 所属情報</div>
          <div class="member-form-grid">
            <div class="member-form-group">
              <label class="member-form-label">チーム</label>
              <select id="memberEditTeam" class="member-form-select">
                <option value="">未配属</option>
              </select>
            </div>
            <div class="member-form-group">
              <label class="member-form-label">所属</label>
              <input type="text" id="memberEditAffiliation" class="member-form-input">
            </div>
            <div class="member-form-group">
              <label class="member-form-label">会社名</label>
              <input type="text" id="memberEditCompany" class="member-form-input">
            </div>
            <div class="member-form-group">
              <label class="member-form-label">役職</label>
              <input type="text" id="memberEditPosition" class="member-form-input">
            </div>
            <div class="member-form-group full-width">
              <label class="member-form-label">営業内容</label>
              <input type="text" id="memberEditBusiness" class="member-form-input">
            </div>
          </div>
        </div>

        <!-- 役割・紹介 -->
        <div class="member-form-section">
          <div class="member-form-section-title">🎯 役割・紹介</div>
          <div class="member-form-grid">
            <div class="member-form-group">
              <label class="member-form-label">役割</label>
              <select id="memberEditRole" class="member-form-input">
                <option value="">なし</option>
                <option value="統括">統括</option>
                <option value="PA">PA</option>
                <option value="MC">MC</option>
                <option value="バッジ授与">バッジ授与</option>
                <option value="受付">受付</option>
                <option value="ゲスト誘導">ゲスト誘導</option>
                <option value="会員サポート">会員サポート</option>
                <option value="名刺回収">名刺回収</option>
                <option value="撮影">撮影</option>
              </select>
            </div>
            <div class="member-form-group">
              <label class="member-form-label">紹介者</label>
              <input type="text" id="memberEditIntroducer" class="member-form-input">
            </div>
            <div class="member-form-group">
              <label class="member-form-label">紹介数</label>
              <input type="text" id="memberEditReferralCount" class="member-form-input">
            </div>
            <div class="member-form-group">
              <label class="member-form-label">自会場紹介在籍人数</label>
              <input type="text" id="memberEditReferralActive" class="member-form-input">
            </div>
            <div class="member-form-group">
              <label class="member-form-label">賞</label>
              <select id="memberEditAward" class="member-form-input">
                <option value="">なし</option>
                <option value="鬼">鬼</option>
                <option value="盾">盾</option>
                <option value="G">G</option>
              </select>
            </div>
            <div class="member-form-group">
              <label class="member-form-label">紫バッジ</label>
              <input type="text" id="memberEditPurpleBadge" class="member-form-input">
            </div>
          </div>
        </div>

        <!-- 更新管理 -->
        <div class="member-form-section">
          <div class="member-form-section-title">📅 更新管理</div>
          <div class="member-form-grid">
            <div class="member-form-group">
              <label class="member-form-label">入会日</label>
              <input type="date" id="memberEditJoinDate" class="member-form-input">
            </div>
            <div class="member-form-group">
              <label class="member-form-label">更新月</label>
              <select id="memberEditRenewalMonth" class="member-form-select">
                <option value="">未設定</option>
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
              </select>
            </div>
            <div class="member-form-group">
              <label class="member-form-label">継続月</label>
              <input type="text" id="memberEditContinuedMonths" class="member-form-input">
            </div>
            <div class="member-form-group">
              <label class="member-form-label">区分</label>
              <input type="text" id="memberEditCategory" class="member-form-input">
            </div>
          </div>
        </div>

        <!-- 退会チェック -->
        <div class="member-retire-section" id="memberRetireSection">
          <label class="member-retire-label">
            <input type="checkbox" id="memberEditRetired">
            この会員を退会扱いにする
          </label>
        </div>
      </div>
      <div class="member-modal-footer">
        <button class="member-btn-cancel" onclick="closeMemberModal()">キャンセル</button>
        <button class="member-btn-save" onclick="saveMember()">
          💾 保存
        </button>
      </div>
    </div>
  </div>

  <!-- パスワード確認モーダル -->
  <div id="passwordModal" class="password-modal">
    <div class="password-modal-overlay" onclick="closePasswordModal()"></div>
    <div class="password-modal-content">
      <div class="password-modal-title">🔐 パスワード確認</div>
      <p class="password-modal-desc">編集パスワードを入力してください</p>
      <div class="password-input-wrapper">
        <input type="password" id="memberPassword" class="password-input" placeholder="パスワード" onkeypress="if(event.key==='Enter')confirmPassword()">
        <p id="passwordError" class="password-error">パスワードが違います</p>
      </div>
      <div class="password-modal-buttons">
        <button class="member-btn-cancel" onclick="closePasswordModal()">キャンセル</button>
        <button class="member-btn-save" onclick="confirmPassword()">確認</button>
      </div>
    </div>
  </div>

  <!-- ★ 履歴タブ -->
  <!-- 会議タブ -->
  <div id="meeting-tab" class="tab-panel">
    <section class="modern-card mt-4">
      <div class="modern-card-header">
        <h2 class="modern-card-title">
          <span class="modern-card-title-icon">📋</span>
          会議議事録
        </h2>
        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-500">対象例会:</label>
          <select id="meetingEventSelect" onchange="loadMeetingData(this.value)" class="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white shadow-sm">
            <option value="">読み込み中...</option>
          </select>
        </div>
      </div>

      <!-- 読み込み中 -->
      <div id="meetingLoading" class="text-center text-slate-500 py-8">
        会議タブを選択してデータを読み込みます
      </div>

      <!-- メインコンテンツ（読み込み後に表示） -->
      <div id="meetingContent" style="display:none;">

        <!-- Zone A: スコアボード -->
        <div class="mtg-scoreboard" id="mtgScoreboard">
          <div class="mtg-tile mtg-tile--participation" onclick="toggleScoreboardDetail('participation')">
            <div class="mtg-tile-emoji">📊</div>
            <div class="mtg-tile-value"><span id="mtgTileParticipation">-</span><span class="mtg-tile-unit">%</span></div>
            <div class="mtg-tile-label">参加</div>
          </div>
          <div class="mtg-tile mtg-tile--business" onclick="toggleScoreboardDetail('business')">
            <div class="mtg-tile-emoji">💰</div>
            <div class="mtg-tile-value"><span id="mtgTileBusiness">-</span><span class="mtg-tile-unit">万</span></div>
            <div class="mtg-tile-label">商談</div>
          </div>
          <div class="mtg-tile mtg-tile--referral" onclick="toggleScoreboardDetail('referral')">
            <div class="mtg-tile-emoji">🤝</div>
            <div class="mtg-tile-value"><span id="mtgTileReferral">-</span><span class="mtg-tile-unit">人</span></div>
            <div class="mtg-tile-label">紹介</div>
          </div>
          <div class="mtg-tile mtg-tile--growth" onclick="toggleScoreboardDetail('growth')">
            <div class="mtg-tile-emoji">🌱</div>
            <div class="mtg-tile-value"><span id="mtgTileGrowth">-</span><span class="mtg-tile-unit">%</span></div>
            <div class="mtg-tile-label">成長</div>
          </div>
          <div class="mtg-tile mtg-tile--survey" onclick="toggleScoreboardDetail('survey')">
            <div class="mtg-tile-emoji">📝</div>
            <div class="mtg-tile-value"><span id="mtgTileSurvey">-</span></div>
            <div class="mtg-tile-label">満足度</div>
          </div>
        </div>
        <!-- 詳細ドロワー（タイルタップで動的挿入） -->
        <div id="mtgScoreboardDetail"></div>

        <!-- Zone B: アクション一覧 -->
        <div class="mtg-actions-section">
          <div class="mtg-actions-header">
            <span class="mtg-actions-title">アクション</span>
            <div class="mtg-filter-group">
              <button class="mtg-filter-btn mtg-filter-btn--active" onclick="filterActions('all')" data-filter="all">すべて</button>
              <button class="mtg-filter-btn" onclick="filterActions('未着手')" data-filter="未着手">未着手</button>
              <button class="mtg-filter-btn" onclick="filterActions('進行中')" data-filter="進行中">進行中</button>
              <button class="mtg-filter-btn" onclick="filterActions('完了')" data-filter="完了">完了</button>
            </div>
          </div>
          <div class="mtg-actions-list" id="mtgActionsList"></div>
          <div class="mtg-add-area">
            <select id="mtgAddCategory" class="mtg-add-category-select">
              <option value="参加循環">参加循環</option>
              <option value="商談循環">商談循環</option>
              <option value="紹介循環">紹介循環</option>
              <option value="成長循環">成長循環</option>
              <option value="アンケート改善">アンケート改善</option>
            </select>
            <button class="mtg-add-btn" onclick="addMeetingAction()">+ アクション追加</button>
          </div>
        </div>

        <!-- Zone C: 全体メモ・決定事項 -->
        <div class="mtg-notes-section">
          <label class="mtg-notes-label">全体メモ・決定事項</label>
          <textarea id="meetingNotes" class="mtg-notes-textarea" rows="8" placeholder="会議での決定事項や共有事項を記入..."></textarea>
        </div>

        <!-- 保存バー -->
        <div class="mtg-save-bar">
          <span id="meetingSaveStatus" class="mtg-save-status"></span>
          <button id="meetingSaveBtn" onclick="saveMeetingMinutesFromUI()" class="mtg-save-btn">保存</button>
        </div>

      </div>
    </section>
  </div>

  <div id="history-tab" class="tab-panel">
    <section class="modern-card mt-4">
      <div class="modern-card-header">
        <h2 class="modern-card-title">
          <span class="modern-card-title-icon">📋</span>
          例会参加履歴
        </h2>
        <!-- 例会選択 -->
        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-500">対象例会:</label>
          <select id="historyEventSelect" onchange="loadParticipantHistory()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white shadow-sm">
            <option value="">読み込み中...</option>
          </select>
        </div>
      </div>

      <!-- サマリー -->
      <div id="historySummary" class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-4">
        <div class="mini-stat-card">
          <div class="mini-stat-label">参加者数</div>
          <div id="historyTotal" class="mini-stat-value" style="color: var(--color-text-primary);">-</div>
        </div>
        <div class="mini-stat-card" style="background: #eff6ff;">
          <div class="mini-stat-label">会員</div>
          <div id="historyMembers" class="mini-stat-value" style="color: #2563eb;">-</div>
        </div>
        <div class="mini-stat-card" style="background: #ecfdf5;">
          <div class="mini-stat-label">ゲスト</div>
          <div id="historyGuests" class="mini-stat-value" style="color: #059669;">-</div>
        </div>
        <div class="mini-stat-card" style="background: #fff7ed;">
          <div class="mini-stat-label">他会場</div>
          <div id="historyOthers" class="mini-stat-value" style="color: #ea580c;">-</div>
        </div>
        <div class="mini-stat-card" style="background: #f0fdf4;">
          <div class="mini-stat-label">出席</div>
          <div id="historyAttended" class="mini-stat-value" style="color: #16a34a;">-</div>
        </div>
        <div class="mini-stat-card" style="background: #faf5ff;">
          <div class="mini-stat-label">欠席</div>
          <div id="historyCancelled" class="mini-stat-value" style="color: #9333ea;">-</div>
        </div>
      </div>

      <!-- フィルタボタン -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button onclick="filterHistory('all')" class="history-filter-btn active px-3 py-1.5 text-xs rounded-lg border border-teal-200 bg-teal-50 text-teal-700 font-medium transition-all" data-filter="all">全員</button>
        <button onclick="filterHistory('会員')" class="history-filter-btn px-3 py-1.5 text-xs rounded-lg border border-slate-200 hover:bg-slate-50 font-medium transition-all" data-filter="会員">会員</button>
        <button onclick="filterHistory('ゲスト')" class="history-filter-btn px-3 py-1.5 text-xs rounded-lg border border-slate-200 hover:bg-slate-50 font-medium transition-all" data-filter="ゲスト">ゲスト</button>
        <button onclick="filterHistory('他会場')" class="history-filter-btn px-3 py-1.5 text-xs rounded-lg border border-slate-200 hover:bg-slate-50 font-medium transition-all" data-filter="他会場">他会場</button>
        <span class="border-l border-slate-300 mx-1"></span>
        <button onclick="filterHistory('出席')" class="history-filter-btn px-3 py-1.5 text-xs rounded-lg border border-slate-200 hover:bg-slate-50 font-medium transition-all" data-filter="出席">出席</button>
        <button onclick="filterHistory('欠席')" class="history-filter-btn px-3 py-1.5 text-xs rounded-lg border border-purple-200 hover:bg-purple-50 text-purple-600 font-medium transition-all" data-filter="欠席">欠席</button>
      </div>

      <!-- 参加者一覧テーブル -->
      <div class="overflow-x-auto">
        <table class="modern-table">
          <thead>
            <tr>
              <th class="text-center w-10">#</th>
              <th>氏名</th>
              <th class="text-center w-16">区分</th>
              <th>所属</th>
              <th class="text-center w-16">テーブル</th>
              <th class="text-center w-16">出欠</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <tr><td colspan="6" class="py-8 text-center text-slate-400">例会を選択してください</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  </div>

    <script>
console.log('=== SCRIPT START ===');
let dashboardData = null;

// PDF保存（GAS経由：スプレッドシート→PDF→ダウンロード）
function exportRosterPdfFromGAS() {
  const btn = document.getElementById('prepPrintButton');
  const originalText = btn ? btn.textContent : '';

  if (btn) {
    btn.textContent = '生成中...';
    btn.disabled = true;
  }

  google.script.run
    .withSuccessHandler(function(result) {
      if (btn) {
        btn.textContent = originalText;
        btn.disabled = false;
      }

      if (result.success) {
        // Base64からBlobを作成してダウンロード
        const byteCharacters = atob(result.pdfBase64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/pdf' });

        // ダウンロードリンク作成
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = result.fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        console.log('[PDF] ダウンロード完了:', result.fileName);
      } else {
        alert('PDF生成に失敗しました: ' + (result.error || '不明なエラー'));
      }
    })
    .withFailureHandler(function(error) {
      if (btn) {
        btn.textContent = originalText;
        btn.disabled = false;
      }
      alert('PDF生成に失敗しました: ' + error.message);
      console.error('[PDF] Error:', error);
    })
    .exportRosterPdf();
}

// PDF生成（名簿 - html2canvas + jsPDF直接制御・A4横固定版）※旧方式・予備
async function generatePDF() {
  const area = document.getElementById('prepPreviewContainer');

  if (!area) {
    alert('名簿が表示されていません');
    return;
  }

  const btn = document.getElementById('prepPrintButton');
  const originalText = btn ? btn.textContent : '';
  if (btn) {
    btn.textContent = '生成中...';
    btn.disabled = true;
  }

  // A4横固定サイズ（px @ 96dpi）
  const A4_WIDTH = 1123;
  const A4_HEIGHT = 794;

  try {
    const pages = area.querySelectorAll('.print-page');
    if (!pages.length) {
      alert('表示するページがありません');
      return;
    }

    // 1. フォント読み込み待機 + 50ms追加待機
    if (document.fonts && document.fonts.ready) {
      await document.fonts.ready;
      console.log('[PDF] フォント読み込み完了');
    }
    await new Promise(r => setTimeout(r, 50));

    // 2. jsPDFをpx単位で初期化（A4横）
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: 'landscape',
      unit: 'px',
      format: [A4_WIDTH, A4_HEIGHT],
      hotfixes: ['px_scaling']
    });

    for (let i = 0; i < pages.length; i++) {
      // 3. クローン作成・ID削除
      const clone = pages[i].cloneNode(true);
      clone.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));

      // 4. PDF専用クラスを付与
      clone.classList.add('pdf-export');

      // 5. インラインの背景色をクリア（PDF用CSSで上書き）
      clone.querySelectorAll('[style]').forEach(el => {
        if (el.style.backgroundColor) el.style.backgroundColor = 'transparent';
        if (el.style.background) el.style.background = 'transparent';
      });

      clone.style.cssText = `
        position: absolute;
        top: -9999px;
        left: -9999px;
        width: ${A4_WIDTH}px;
        height: ${A4_HEIGHT}px;
        max-width: ${A4_WIDTH}px;
        max-height: ${A4_HEIGHT}px;
        overflow: hidden;
        padding: 20px 30px;
        box-sizing: border-box;
        background: #ffffff;
        transform: none;
        font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      `;
      document.body.appendChild(clone);

      // 6. リフロー待ち
      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

      // 7. デバッグログ
      console.log(`[PDF] ページ${i + 1} クローンサイズ:`, clone.scrollWidth, 'x', clone.scrollHeight);

      // 8. html2canvasで固定サイズキャプチャ
      const canvas = await html2canvas(clone, {
        useCORS: true,
        allowTaint: false,
        backgroundColor: '#ffffff',
        width: A4_WIDTH,
        height: A4_HEIGHT,
        windowWidth: A4_WIDTH,
        windowHeight: A4_HEIGHT,
        scrollX: 0,
        scrollY: 0,
        scale: 1.5,
        logging: false
      });

      // クローン削除
      document.body.removeChild(clone);

      console.log(`[PDF] ページ${i + 1} Canvas:`, canvas.width, 'x', canvas.height);

      // 9. PDFに追加
      if (i > 0) {
        pdf.addPage([A4_WIDTH, A4_HEIGHT], 'landscape');
      }
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      pdf.addImage(imgData, 'JPEG', 0, 0, A4_WIDTH, A4_HEIGHT);
    }

    // 10. ページ数確認・保存
    console.log('[PDF] 総ページ数:', pdf.getNumberOfPages());

    // ファイル名生成（例: 2026_01_福岡飯塚参加者名簿.pdf）
    const eventName = dashboardData?.eventName || '';
    const yearMonthMatch = eventName.match(/(\d{4})年(\d{1,2})月/);
    let prefix = '';
    if (yearMonthMatch) {
      const year = yearMonthMatch[1];
      const month = yearMonthMatch[2].padStart(2, '0');
      prefix = `${year}_${month}_`;
    }

    // プレビュータイトルから名簿タイプを判定
    const previewTitle = document.getElementById('prepPreviewTitle');
    const titleText = previewTitle?.textContent || '';
    let rosterType = '名簿';
    if (titleText.includes('福岡飯塚') && titleText.includes('受付')) {
      rosterType = '福岡飯塚受付名簿';
    } else if (titleText.includes('他会場') && titleText.includes('受付')) {
      rosterType = '他会場ゲスト受付名簿';
    } else if (titleText.includes('福岡飯塚') && titleText.includes('参加者')) {
      rosterType = '福岡飯塚参加者名簿';
    } else if (titleText.includes('他会場') || titleText.includes('ゲスト')) {
      rosterType = '他会場ゲスト参加者名簿';
    }

    const fileName = `${prefix}${rosterType}.pdf`;
    pdf.save(fileName);
    console.log('[PDF] 生成完了:', fileName);

  } catch (e) {
    console.error('[PDF] 生成エラー:', e);
    alert('PDF生成に失敗しました: ' + e.message);
  } finally {
    if (btn) {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  }
}

// PDFプレビュー（ブラウザで直接表示）
async function previewPDF() {
  const area = document.getElementById('prepPreviewContainer');

  if (!area) {
    alert('名簿が表示されていません');
    return;
  }

  const btn = document.getElementById('prepPdfPreviewButton');
  const originalText = btn ? btn.textContent : '';
  if (btn) {
    btn.textContent = '生成中...';
    btn.disabled = true;
  }

  // A4横固定サイズ（px @ 96dpi）
  const A4_WIDTH = 1123;
  const A4_HEIGHT = 794;

  try {
    const pages = area.querySelectorAll('.print-page');
    if (!pages.length) {
      alert('表示するページがありません');
      return;
    }

    // フォント読み込み待機
    if (document.fonts && document.fonts.ready) {
      await document.fonts.ready;
    }
    await new Promise(r => setTimeout(r, 50));

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: 'landscape',
      unit: 'px',
      format: [A4_WIDTH, A4_HEIGHT],
      hotfixes: ['px_scaling']
    });

    for (let i = 0; i < pages.length; i++) {
      const clone = pages[i].cloneNode(true);
      clone.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));
      clone.classList.add('pdf-export');

      clone.querySelectorAll('[style]').forEach(el => {
        if (el.style.backgroundColor) el.style.backgroundColor = 'transparent';
        if (el.style.background) el.style.background = 'transparent';
      });

      clone.style.cssText = `
        position: absolute;
        top: -9999px;
        left: -9999px;
        width: ${A4_WIDTH}px;
        height: ${A4_HEIGHT}px;
        max-width: ${A4_WIDTH}px;
        max-height: ${A4_HEIGHT}px;
        overflow: hidden;
        padding: 20px 30px;
        box-sizing: border-box;
        background: #ffffff;
        transform: none;
        font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      `;
      document.body.appendChild(clone);

      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

      const canvas = await html2canvas(clone, {
        useCORS: true,
        allowTaint: false,
        backgroundColor: '#ffffff',
        width: A4_WIDTH,
        height: A4_HEIGHT,
        windowWidth: A4_WIDTH,
        windowHeight: A4_HEIGHT,
        scrollX: 0,
        scrollY: 0,
        scale: 2,  // 高解像度でプレビュー
        logging: false
      });

      document.body.removeChild(clone);

      if (i > 0) {
        pdf.addPage([A4_WIDTH, A4_HEIGHT], 'landscape');
      }
      const imgData = canvas.toDataURL('image/jpeg', 0.92);
      pdf.addImage(imgData, 'JPEG', 0, 0, A4_WIDTH, A4_HEIGHT);
    }

    // BlobURLを生成してプレビュー表示
    const pdfBlob = pdf.output('blob');
    const blobUrl = URL.createObjectURL(pdfBlob);
    window.open(blobUrl, '_blank');

    console.log('[PDFプレビュー] 完了');

  } catch (e) {
    console.error('[PDFプレビュー] エラー:', e);
    alert('PDFプレビュー生成に失敗しました: ' + e.message);
  } finally {
    if (btn) {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  }
}

// タブ切り替え
console.log('=== DEFINING setupTabs ===');
function setupTabs() {
  const mainBtns = document.querySelectorAll('.tab-main-btn');
  const subGroups = document.querySelectorAll('.tab-sub-group');
  const tabPanels = document.querySelectorAll('.tab-panel');

  // メインカテゴリ切り替え
  mainBtns.forEach(mainBtn => {
    mainBtn.addEventListener('click', () => {
      const category = mainBtn.dataset.category;

      // メインボタンのactive切り替え
      mainBtns.forEach(b => b.classList.remove('active'));
      mainBtn.classList.add('active');

      // サブグループの表示切り替え
      subGroups.forEach(g => {
        if (g.dataset.category === category) {
          g.classList.add('active');
        } else {
          g.classList.remove('active');
        }
      });

      // そのカテゴリの最初のサブタブを自動選択
      const firstSubBtn = document.querySelector('.tab-sub-group.active .tab-btn');
      if (firstSubBtn) {
        firstSubBtn.click();
      }
    });
  });

  // サブタブ切り替え
  const allSubBtns = document.querySelectorAll('.tab-btn[data-tab]');
  allSubBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.dataset.tab;
      if (!targetId) return;

      // サブボタンのactive（全カテゴリ横断で1つだけ）
      allSubBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // パネル切り替え
      tabPanels.forEach(panel => {
        panel.classList.toggle('active', panel.id === targetId);
      });

      // ★遅延初期化フック
      if (targetId === 'sales-tab' && dashboardData && dashboardData.monthlySummary) {
        setTimeout(() => renderMonthlyChart(dashboardData.monthlySummary), 50);
      }
      if (targetId === 'history-tab') setTimeout(() => initHistoryTab(), 50);
      if (targetId === 'member-tab') setTimeout(() => initMemberTab(), 50);
      if (targetId === 'contact-tab') setTimeout(() => loadContactGroups(), 50);
      if (targetId === 'meeting-tab') setTimeout(() => initMeetingTab(), 50);
    });
  });
}

// ★連絡網グループを読み込み・表示
let contactGroupsLoaded = false;
function loadContactGroups() {
  if (contactGroupsLoaded) return;

  const container = document.getElementById('contactGroupsContainer');
  container.innerHTML = '<div class="text-center text-slate-500 py-8">読み込み中...</div>';

  google.script.run
    .withSuccessHandler((result) => {
      if (!result.success) {
        container.innerHTML = '<div class="text-center text-red-500 py-8">エラー: ' + escapeHtml(result.error) + '</div>';
        return;
      }

      if (!result.groups || result.groups.length === 0) {
        container.innerHTML = '<div class="text-center text-slate-500 py-8">連絡網データがありません。<br>会員名簿マスターのAD列に連絡網順序（例: A1-2）を入力してください。</div>';
        return;
      }

      let html = '';
      result.groups.forEach(group => {
        html += '<div class="contact-group-section">';
        html += '<div class="contact-group-header">';
        html += '<span class="contact-group-badge">' + escapeHtml(group.name) + '</span>グループ　';
        html += '<span class="contact-leader-name">' + escapeHtml(group.leader || '未設定') + '</span>';
        html += '</div>';

        // 各行をレンダリング
        if (group.rows && group.rows.length > 0) {
          group.rows.forEach(row => {
            html += '<div class="contact-row">';
            row.forEach((name, idx) => {
              html += '<div class="contact-member-card">' + escapeHtml(name) + '</div>';
              // 最後の要素でなければコネクタを追加
              if (idx < row.length - 1) {
                html += '<span class="contact-connector"></span>';
              }
            });
            html += '</div>';
          });
        } else {
          html += '<div class="text-slate-400 text-sm">メンバーなし</div>';
        }

        html += '</div>';
      });

      container.innerHTML = html;
      contactGroupsLoaded = true;
    })
    .withFailureHandler((err) => {
      container.innerHTML = '<div class="text-center text-red-500 py-8">読み込みエラー: ' + escapeHtml(err.message || err) + '</div>';
    })
    .getContactGroups();
}

// ★連絡網グループ印刷プレビュー
function printContactGroups() {
  if (!contactGroupsLoaded) {
    alert('データを読み込み中です。しばらくお待ちください。');
    return;
  }
  window.print();
}

// HTMLエスケープ（営業内容などに使う）
function escapeHtml(str) {
  if (str == null) return '';
  return String(str).replace(/[&<>"']/g, (s) => {
    switch (s) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case '\'': return '&#39;';
      default: return s;
    }
  });
}

/** =========================================================
 *  会議タブ JavaScript（リデザイン版）
 * ======================================================= */

let meetingTabInitialized = false;
let meetingIndicatorsData = null;
let meetingMinutesData = null;
let meetingActions = [];
let meetingMemberNames = [];
let meetingAssigneeNames = [];
let meetingCarryOverData = null;
let mtgActiveFilter = 'all';
let mtgOpenDetail = null; // 現在開いている詳細カテゴリ

// カテゴリ→CSSクラスマップ
const MTG_CAT_CLASS = {
  '参加循環': 'participation',
  '商談循環': 'business',
  '紹介循環': 'referral',
  '成長循環': 'growth',
  'アンケート改善': 'survey'
};

function initMeetingTab() {
  if (meetingTabInitialized) return;
  meetingTabInitialized = true;

  const select = document.getElementById('meetingEventSelect');
  select.innerHTML = '<option value="">読み込み中...</option>';

  google.script.run
    .withSuccessHandler(function(result) {
      if (!result.success || !result.eventKeys || result.eventKeys.length === 0) {
        select.innerHTML = '<option value="">データなし</option>';
        return;
      }
      var html = '';
      result.eventKeys.forEach(function(key) {
        var name = eventKeyToJapanese_(key);
        html += '<option value="' + escapeHtml(key) + '">' + escapeHtml(name || key) + '</option>';
      });
      select.innerHTML = html;
      if (result.eventKeys.length > 0) {
        loadMeetingData(result.eventKeys[0]);
      }
    })
    .withFailureHandler(function(err) {
      select.innerHTML = '<option value="">読み込みエラー</option>';
      console.error('getEventKeyList error:', err);
    })
    .getEventKeyList();
}

function eventKeyToJapanese_(eventKey) {
  if (!eventKey) return '';
  var match = String(eventKey).match(/^(\d{4})(\d{2})_\d+$/);
  if (!match) return eventKey;
  return match[1] + '年' + parseInt(match[2], 10) + '月例会';
}

function loadMeetingData(eventKey) {
  if (!eventKey) return;

  var loading = document.getElementById('meetingLoading');
  var content = document.getElementById('meetingContent');
  loading.style.display = 'block';
  loading.textContent = '読み込み中...';
  content.style.display = 'none';
  mtgOpenDetail = null;
  document.getElementById('mtgScoreboardDetail').innerHTML = '';

  // 1回のAPI呼び出しで全データ取得（高速化）
  google.script.run
    .withSuccessHandler(function(result) {
      if (!result || !result.success) {
        loading.textContent = 'データ取得エラー';
        console.error('getMeetingAllData error:', result ? result.error : 'unknown');
        return;
      }

      // 指標データ
      meetingIndicatorsData = result.indicators;
      meetingMemberNames = (result.indicators && result.indicators.memberNames) || [];
      meetingAssigneeNames = (result.indicators && result.indicators.assigneeNames) || [];

      // 議事録データ
      meetingMinutesData = result.minutes;
      meetingActions = (result.minutes && result.minutes.actions) ? result.minutes.actions : [];

      // 引き継ぎデータ
      meetingCarryOverData = result.carryOver;

      // スキーマ正規化（done→status互換）
      meetingActions = meetingActions.map(function(a) {
        return Object.assign({}, a, {
          status: a.status || (a.done ? '完了' : '未着手'),
          memo: a.memo || ''
        });
      });

      // 自動引き継ぎ: アクションが空の場合、前回未完了を自動インポート
      if (meetingActions.length === 0 && meetingCarryOverData
          && meetingCarryOverData.success && meetingCarryOverData.actions
          && meetingCarryOverData.actions.length > 0) {
        meetingCarryOverData.actions.forEach(function(a) {
          meetingActions.push({
            id: 'act_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
            category: a.category || '',
            trigger: a.trigger || '',
            content: a.content || '',
            assignee: a.assignee || '',
            deadline: a.deadline || '',
            status: a.status || (a.done ? '完了' : '未着手'),
            memo: a.memo || '',
            carryOver: true
          });
        });
      }

      loading.style.display = 'none';
      content.style.display = 'block';
      renderScoreboard(meetingIndicatorsData);
      renderActionList();
      document.getElementById('meetingNotes').value = meetingMinutesData ? meetingMinutesData.notes || '' : '';
      document.getElementById('meetingSaveStatus').textContent =
        meetingMinutesData && meetingMinutesData.updatedAt
          ? '最終保存: ' + meetingMinutesData.updatedAt
          : '';
    })
    .withFailureHandler(function(err) {
      loading.textContent = '読み込みエラー';
      console.error('getMeetingAllData error:', err);
    })
    .getMeetingAllData(eventKey);
}

/* --- Zone A: スコアボード --- */

function renderScoreboard(data) {
  if (!data || !data.success) return;

  var p = data.participation || {};
  var b = data.business || {};
  var r = data.referral || {};
  var g = data.growth || {};
  var s = data.survey || {};

  document.getElementById('mtgTileParticipation').textContent = p.attendRate || 0;

  // 売上を万円単位に（10000で割って小数1桁）
  var salesMan = b.totalSales ? Math.round(b.totalSales / 10000 * 10) / 10 : 0;
  document.getElementById('mtgTileBusiness').textContent = salesMan;

  document.getElementById('mtgTileReferral').textContent = r.guestCount || 0;
  document.getElementById('mtgTileGrowth').textContent = g.officerAttendRate || 0;
  document.getElementById('mtgTileSurvey').textContent = s.meetingScore || '-';
}

function toggleScoreboardDetail(category) {
  var detailEl = document.getElementById('mtgScoreboardDetail');

  // アクティブタイルのトグル
  var tiles = document.querySelectorAll('.mtg-tile');
  tiles.forEach(function(t) { t.classList.remove('mtg-tile--active'); });

  if (mtgOpenDetail === category) {
    // 同じタイルを再タップ → 閉じる
    mtgOpenDetail = null;
    detailEl.innerHTML = '';
    return;
  }

  mtgOpenDetail = category;
  var activeTile = document.querySelector('.mtg-tile--' + category);
  if (activeTile) activeTile.classList.add('mtg-tile--active');

  var html = '';
  switch (category) {
    case 'participation': html = buildParticipationDetail(); break;
    case 'business': html = buildBusinessDetail(); break;
    case 'referral': html = buildReferralDetail(); break;
    case 'growth': html = buildGrowthDetail(); break;
    case 'survey': html = buildSurveyDetail(); break;
  }
  detailEl.innerHTML = '<div class="mtg-scoreboard-detail">' + html
    + '<span class="mtg-detail-close" onclick="closeScoreboardDetail()">閉じる</span></div>';
}

function closeScoreboardDetail() {
  mtgOpenDetail = null;
  document.getElementById('mtgScoreboardDetail').innerHTML = '';
  document.querySelectorAll('.mtg-tile').forEach(function(t) { t.classList.remove('mtg-tile--active'); });
}

function buildParticipationDetail() {
  var data = meetingIndicatorsData;
  if (!data) return '';
  var p = data.participation || {};
  var html = '<div class="mtg-detail-title">📊 参加循環</div>';
  html += '<div class="mtg-detail-stats">'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">出席率</span><span class="mtg-detail-stat-value">' + (p.attendRate || 0) + '</span><span class="mtg-detail-stat-unit">%</span></div>'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">出席</span><span class="mtg-detail-stat-value">' + (p.attendCount || 0) + '</span><span class="mtg-detail-stat-unit">人</span></div>'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">欠席</span><span class="mtg-detail-stat-value">' + (p.absentCount || 0) + '</span><span class="mtg-detail-stat-unit">人</span></div>'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">未回答</span><span class="mtg-detail-stat-value">' + (p.noAnswerCount || 0) + '</span><span class="mtg-detail-stat-unit">人</span></div>'
    + '</div>';

  var consAbsent = p.consecutiveAbsent || [];
  if (consAbsent.length > 0) {
    html += '<div class="mtg-detail-alert"><div class="mtg-detail-alert-title">連続欠席者</div><div class="mtg-detail-alert-list">';
    consAbsent.forEach(function(m) {
      html += '<span class="mtg-detail-badge mtg-detail-badge--danger">' + escapeHtml(m.name) + '（' + m.count + '回）</span>';
    });
    html += '</div></div>';
  }

  var absentMembers = p.absentMembers || [];
  if (absentMembers.length > 0) {
    html += '<div class="mtg-detail-subsection"><div class="mtg-detail-subsection-title">欠席者</div><div>';
    absentMembers.forEach(function(m) {
      html += '<span class="mtg-detail-chip">' + escapeHtml(m.name) + '</span>';
    });
    html += '</div></div>';
  }
  return html;
}

function buildBusinessDetail() {
  var data = meetingIndicatorsData;
  if (!data) return '';
  var b = data.business || {};
  var html = '<div class="mtg-detail-title">💰 商談循環</div>';
  html += '<div class="mtg-detail-stats">'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">報告者数</span><span class="mtg-detail-stat-value">' + (b.reporterCount || 0) + '</span><span class="mtg-detail-stat-unit">人</span></div>'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">売上合計</span><span class="mtg-detail-stat-value">' + (b.totalSales || 0).toLocaleString() + '</span><span class="mtg-detail-stat-unit">円</span></div>'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">成約</span><span class="mtg-detail-stat-value">' + (b.dealCount || 0) + '</span><span class="mtg-detail-stat-unit">件</span></div>'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">商談</span><span class="mtg-detail-stat-value">' + (b.meetingsCount || 0) + '</span><span class="mtg-detail-stat-unit">件</span></div>'
    + '</div>';

  var zeroMembers = b.zeroMembers || [];
  if (zeroMembers.length > 0) {
    html += '<div class="mtg-detail-alert"><div class="mtg-detail-alert-title">商談ゼロの会員</div><div class="mtg-detail-alert-list">';
    zeroMembers.forEach(function(m) {
      html += '<span class="mtg-detail-badge mtg-detail-badge--warning">' + escapeHtml(m.name) + '</span>';
    });
    html += '</div></div>';
  }
  return html;
}

function buildReferralDetail() {
  var data = meetingIndicatorsData;
  if (!data) return '';
  var r = data.referral || {};
  var html = '<div class="mtg-detail-title">🤝 紹介循環</div>';
  html += '<div class="mtg-detail-stats">'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">ゲスト数</span><span class="mtg-detail-stat-value">' + (r.guestCount || 0) + '</span><span class="mtg-detail-stat-unit">人</span></div>'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">承認済み</span><span class="mtg-detail-stat-value">' + (r.guestApproved || 0) + '</span><span class="mtg-detail-stat-unit">人</span></div>'
    + '</div>';

  var ranking = r.referrerRanking || [];
  if (ranking.length > 0) {
    html += '<div class="mtg-detail-subsection"><div class="mtg-detail-subsection-title">紹介者ランキング</div><div class="mtg-detail-ranking">';
    ranking.forEach(function(m, i) {
      var medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : '';
      html += '<div class="mtg-detail-ranking-item">'
        + '<span class="mtg-detail-ranking-medal">' + medal + '</span>'
        + '<span>' + escapeHtml(m.name) + '</span>'
        + '<span class="mtg-detail-ranking-count">' + m.count + '人</span></div>';
    });
    html += '</div></div>';
  }
  return html;
}

function buildGrowthDetail() {
  var data = meetingIndicatorsData;
  if (!data) return '';
  var g = data.growth || {};
  var html = '<div class="mtg-detail-title">🌱 成長循環</div>';
  html += '<div class="mtg-detail-stats">'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">役職参加率</span><span class="mtg-detail-stat-value">' + (g.officerAttendRate || 0) + '</span><span class="mtg-detail-stat-unit">%</span></div>'
    + '</div>';

  // 更新予定者
  var renewalNext = g.renewalNext || [];
  if (renewalNext.length > 0) {
    html += '<div class="mtg-detail-subsection"><div class="mtg-detail-subsection-title">' + escapeHtml(g.nextMonthLabel || '翌月更新') + '</div><div>';
    renewalNext.forEach(function(m) {
      var warn = m.hasZeroReferral ? ' <span class="mtg-detail-badge--inline">紹介0</span>' : '';
      html += '<span class="mtg-detail-chip">' + escapeHtml(m.name) + warn + '</span>';
    });
    html += '</div></div>';
  }

  var renewalNext2 = g.renewalNext2 || [];
  if (renewalNext2.length > 0) {
    html += '<div class="mtg-detail-subsection"><div class="mtg-detail-subsection-title">' + escapeHtml(g.next2MonthLabel || '翌々月更新') + '</div><div>';
    renewalNext2.forEach(function(m) {
      var warn = m.hasZeroReferral ? ' <span class="mtg-detail-badge--inline">紹介0</span>' : '';
      html += '<span class="mtg-detail-chip">' + escapeHtml(m.name) + warn + '</span>';
    });
    html += '</div></div>';
  }
  return html;
}

function buildSurveyDetail() {
  var data = meetingIndicatorsData;
  if (!data) return '';
  var s = data.survey || {};
  var html = '<div class="mtg-detail-title">📝 アンケート改善</div>';
  html += '<div class="mtg-detail-stats">'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">例会満足度</span><span class="mtg-detail-stat-value">' + (s.meetingScore || '-') + '</span></div>'
    + '<div class="mtg-detail-stat"><span class="mtg-detail-stat-label">会満足度</span><span class="mtg-detail-stat-value">' + (s.clubScore || '-') + '</span></div>'
    + '</div>';

  var comments = s.improveComments || [];
  if (comments.length > 0) {
    html += '<div class="mtg-detail-subsection"><div class="mtg-detail-subsection-title">改善リクエスト</div>';
    comments.forEach(function(c) {
      html += '<div class="mtg-detail-improve-item">' + escapeHtml(c) + '</div>';
    });
    html += '</div>';
  }
  return html;
}

/* --- Zone B: アクション一覧 --- */

function filterActions(status) {
  mtgActiveFilter = status;
  // フィルタボタンのactive切り替え
  document.querySelectorAll('.mtg-filter-btn').forEach(function(btn) {
    btn.classList.toggle('mtg-filter-btn--active', btn.dataset.filter === status);
  });
  renderActionList();
}

function renderActionList() {
  var container = document.getElementById('mtgActionsList');
  var filtered = meetingActions;
  if (mtgActiveFilter !== 'all') {
    filtered = meetingActions.filter(function(a) { return a.status === mtgActiveFilter; });
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="mtg-empty-state">'
      + (meetingActions.length === 0 ? 'アクションなし' : '該当するアクションなし')
      + '</div>';
    return;
  }

  var html = '';
  filtered.forEach(function(action) {
    var catKey = MTG_CAT_CLASS[action.category] || 'participation';
    var statusOptions = ['未着手', '進行中', '完了'].map(function(s) {
      return '<option value="' + s + '"' + (action.status === s ? ' selected' : '') + '>' + s + '</option>';
    }).join('');

    // 担当者プルダウン（役職ありの会員 + システム管理者）
    var assigneeOptions = '<option value="">担当者</option>';
    meetingAssigneeNames.forEach(function(name) {
      var selected = name === action.assignee ? ' selected' : '';
      assigneeOptions += '<option value="' + escapeHtml(name) + '"' + selected + '>' + escapeHtml(name) + '</option>';
    });

    html += '<div class="mtg-action-card" data-status="' + escapeHtml(action.status) + '" data-action-id="' + escapeHtml(action.id) + '">'
      + '<div class="mtg-action-top-row">'
      + '<span class="mtg-action-category-tag mtg-cat--' + catKey + '">' + escapeHtml(action.category) + '</span>'
      + (action.carryOver ? '<span class="mtg-action-carry-badge">引継</span>' : '')
      + '<select class="mtg-action-status-select" onchange="updateActionField(\'' + action.id + '\', \'status\', this.value); renderActionList();">'
      + statusOptions + '</select>'
      + '<button class="mtg-action-delete-btn" onclick="removeMeetingAction(\'' + action.id + '\')" title="削除">&times;</button>'
      + '</div>'
      + '<div class="mtg-action-fields">'
      + '<input type="text" class="mtg-action-content-input" value="' + escapeHtml(action.content || '') + '" '
      + 'placeholder="対応内容" onchange="updateActionField(\'' + action.id + '\', \'content\', this.value)">'
      + '<div class="mtg-action-row">'
      + '<select class="mtg-action-assignee-select" onchange="updateActionField(\'' + action.id + '\', \'assignee\', this.value)">'
      + assigneeOptions + '</select>'
      + '<input type="date" class="mtg-action-deadline-input" value="' + escapeHtml(action.deadline || '') + '" '
      + 'onchange="updateActionField(\'' + action.id + '\', \'deadline\', this.value)">'
      + '</div>'
      + '<input type="text" class="mtg-action-memo-input" value="' + escapeHtml(action.memo || '') + '" '
      + 'placeholder="メモ" onchange="updateActionField(\'' + action.id + '\', \'memo\', this.value)">'
      + '</div>'
      + renderCommentSection(action)
      + '</div>';
  });
  container.innerHTML = html;
}

function addMeetingAction() {
  var categorySelect = document.getElementById('mtgAddCategory');
  var category = categorySelect ? categorySelect.value : '参加循環';
  var action = {
    id: 'act_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
    category: category,
    trigger: '',
    content: '',
    assignee: '',
    deadline: '',
    status: '未着手',
    memo: '',
    carryOver: false
  };
  meetingActions.push(action);
  renderActionList();
}

function removeMeetingAction(id) {
  meetingActions = meetingActions.filter(function(a) { return a.id !== id; });
  renderActionList();
}

function updateActionField(id, field, value) {
  var action = meetingActions.find(function(a) { return a.id === id; });
  if (action) {
    action[field] = value;
  }
}

/* --- コメント機能 --- */

function renderCommentSection(action) {
  var comments = action.comments || [];
  var count = comments.length;
  var countBadge = count > 0
    ? '<span class="mtg-comment-count">' + count + '</span>'
    : '';

  var html = '<button class="mtg-comment-toggle" onclick="toggleCommentThread(\'' + action.id + '\')">'
    + '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'
    + 'コメント ' + countBadge + '</button>';

  html += '<div class="mtg-comment-thread" id="commentThread_' + action.id + '">';

  // 既存コメント表示
  comments.forEach(function(c, idx) {
    html += '<div class="mtg-comment-item">'
      + '<span class="mtg-comment-author">' + escapeHtml(c.author) + '</span>'
      + '<div class="mtg-comment-body">'
      + escapeHtml(c.text)
      + '<div class="mtg-comment-time">' + escapeHtml(c.time || '') + '</div>'
      + '</div>'
      + '<button class="mtg-comment-delete" onclick="deleteComment(\'' + action.id + '\',' + idx + ')" title="削除">&times;</button>'
      + '</div>';
  });

  // 投稿欄（名前選択 + 入力 + 送信）
  var authorOptions = '';
  meetingAssigneeNames.forEach(function(name) {
    authorOptions += '<option value="' + escapeHtml(name) + '">' + escapeHtml(name) + '</option>';
  });

  html += '<div class="mtg-comment-input-row">'
    + '<select class="mtg-comment-author-select" id="commentAuthor_' + action.id + '">'
    + authorOptions + '</select>'
    + '<input type="text" class="mtg-comment-input" id="commentInput_' + action.id + '" placeholder="コメントを入力..."'
    + ' onkeypress="if(event.key===\'Enter\')addComment(\'' + action.id + '\')">'
    + '<button class="mtg-comment-send" onclick="addComment(\'' + action.id + '\')">送信</button>'
    + '</div>';

  html += '</div>';
  return html;
}

function toggleCommentThread(actionId) {
  var el = document.getElementById('commentThread_' + actionId);
  if (el) el.classList.toggle('open');
}

function addComment(actionId) {
  var input = document.getElementById('commentInput_' + actionId);
  var authorSelect = document.getElementById('commentAuthor_' + actionId);
  var text = input.value.trim();
  if (!text) return;

  var action = meetingActions.find(function(a) { return a.id === actionId; });
  if (!action) return;

  if (!action.comments) action.comments = [];
  var now = new Date();
  var timeStr = (now.getMonth() + 1) + '/' + now.getDate() + ' '
    + ('0' + now.getHours()).slice(-2) + ':' + ('0' + now.getMinutes()).slice(-2);

  action.comments.push({
    author: authorSelect.value,
    text: text,
    time: timeStr
  });

  renderActionList();
  // 再描画後にスレッドを開いた状態にする
  var thread = document.getElementById('commentThread_' + actionId);
  if (thread) thread.classList.add('open');
}

function deleteComment(actionId, idx) {
  var action = meetingActions.find(function(a) { return a.id === actionId; });
  if (!action || !action.comments) return;
  action.comments.splice(idx, 1);
  renderActionList();
  var thread = document.getElementById('commentThread_' + actionId);
  if (thread) thread.classList.add('open');
}

/* --- 保存 --- */

function saveMeetingMinutesFromUI() {
  var select = document.getElementById('meetingEventSelect');
  var eventKey = select.value;
  if (!eventKey) {
    alert('例会を選択してください');
    return;
  }

  var btn = document.getElementById('meetingSaveBtn');
  btn.disabled = true;
  btn.textContent = '保存中...';

  var payload = {
    eventKey: eventKey,
    actions: meetingActions,
    notes: document.getElementById('meetingNotes').value,
    meetingDate: new Date().toISOString().split('T')[0]
  };

  google.script.run
    .withSuccessHandler(function(result) {
      btn.disabled = false;
      btn.textContent = '保存';
      if (result.success) {
        document.getElementById('meetingSaveStatus').textContent =
          '保存完了 ' + new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      } else {
        alert('保存エラー: ' + (result.error || '不明なエラー'));
      }
    })
    .withFailureHandler(function(err) {
      btn.disabled = false;
      btn.textContent = '保存';
      alert('保存に失敗しました: ' + (err.message || err));
    })
    .saveMeetingMinutes(payload);
}

// バッジ別カードスタイル（通常のカード表示用）
function getBadgeStyle(badge) {
  switch (badge) {
    case 'ゴ':
      return { cardClass: 'member-card member-card--gold' };
    case '正':
      return { cardClass: 'member-card member-card--red' };
    case '準':
      return { cardClass: 'member-card member-card--green' };
    default:
      return { cardClass: 'member-card member-card--default' };
  }
}

// eventName（例: 2025年12月例会）から「第◯◯回」を計算
// ルール: 2025年11月例会 = 第91回 を起点に、月ごと+1
function calcMeetingNoFromEventName(eventName) {
  const m = String(eventName || '').match(/(\d{4})年(\d{1,2})月/);
  if (!m) return null;

  const year  = Number(m[1]);
  const month = Number(m[2]);

  const baseYear  = 2025;
  const baseMonth = 11;
  const baseNo    = 91;

  const diffMonths = (year - baseYear) * 12 + (month - baseMonth);
  return baseNo + diffMonths;
}

// 例会事前準備：プレビュー描画
function showPrepPreview(kind) {
  if (!dashboardData) return;

  const prep = dashboardData.prep || {};
  
  const previewTitle = document.getElementById('prepPreviewTitle');
  const container    = document.getElementById('prepPreviewContainer');

  if (!previewTitle || !container) return;

  const eventName = dashboardData.eventName || '';

  // meetingCount（GAS計算値）を優先、なければmeetingNo（手動設定）
  const round = dashboardData.meetingCount || dashboardData.meetingNo || calcMeetingNoFromEventName(eventName);
  const roundText = round ? `第${round}回 ` : '';

  const att = dashboardData.attendance || {};
  const activeMembers = att.memberCount != null ? att.memberCount : '-';
  const participants  = att.attend      != null ? att.attend      : '-';

  const eventDate = dashboardData.eventDate || '';
  let eventDateStr = '';
  if (eventDate) {
    const d = new Date(eventDate);
    if (!isNaN(d)) {
      eventDateStr = `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
    }
  }

  container.innerHTML = '';

  // 共通スタイル（行高36px）
  const cellStyle18 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:18px;vertical-align:middle;height:36px;line-height:36px;';
  const cellStyle14 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px;vertical-align:middle;height:36px;line-height:36px;';
  const cellStyle12 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px;vertical-align:middle;height:36px;line-height:36px;';
  const cellStyle10 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:10px;vertical-align:middle;height:36px;line-height:36px;';
  const centerCell9 = 'text-align:center;padding:2px;white-space:nowrap;font-size:9px;vertical-align:middle;height:36px;line-height:36px;';

  // 追加スタイル
  const cellStyle15 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:15px;vertical-align:middle;height:36px;line-height:36px;';
  const cellStyle13 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;vertical-align:middle;height:36px;line-height:36px;';
  const cellStyle11 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:11px;vertical-align:middle;height:36px;line-height:36px;';
  const cellStyle9 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:9px;vertical-align:middle;height:36px;line-height:36px;';
  const cellStyle8 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:8px;vertical-align:middle;height:36px;line-height:36px;';
  const cellStyle7 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:7px;vertical-align:middle;height:36px;line-height:36px;';
  const cellStyle6 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:6px;vertical-align:middle;height:36px;line-height:36px;';
  const cellStyle5 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:5px;vertical-align:middle;height:36px;line-height:36px;';

  // 氏名用：基本18px、6文字以上→15px（スペース除く）
  function getNameStyle(text) {
    const len = (text || '').replace(/\s/g, '').length;
    if (len >= 6) return cellStyle15;
    return cellStyle18;
  }

  // フリガナ用：基本11px、9文字以上→9px（スペース除く）
  function getFuriganaStyle(text) {
    const len = (text || '').replace(/\s/g, '').length;
    if (len >= 9) return cellStyle9;
    return cellStyle11;
  }

  // 役割用：12px固定（最長5文字）
  function getRoleStyle(text) {
    return cellStyle12;
  }

  // 会社名用：1px刻み（210px幅、スペース除く、半角カタカナ考慮）
  function getCompanyStyle(text) {
    const str = (text || '').replace(/\s/g, '');
    const halfWidthKana = (str.match(/[\uff61-\uff9f]/g) || []).length;
    const len = str.length - Math.floor(halfWidthKana / 2); // 半角2つで1文字分
    if (len >= 24) return cellStyle7;
    if (len >= 21) return cellStyle8;
    if (len >= 19) return cellStyle9;
    if (len >= 17) return cellStyle10;
    if (len >= 15) return cellStyle11;
    if (len >= 13) return cellStyle12;
    if (len >= 12) return cellStyle13;
    return cellStyle14;
  }

  // 役職用：5文字以下→12px、10文字以下→10px、11文字以上→7px（スペース除く）
  function getPositionStyle(text) {
    const len = (text || '').replace(/\s/g, '').length;
    if (len >= 11) return cellStyle7;
    if (len >= 6) return cellStyle10;
    return cellStyle12;
  }

  // 紹介者用：12px固定（最長5文字）
  function getIntroducerStyle(text) {
    return cellStyle12;
  }

  // 営業内容用：1px刻み（281px幅、スペース除く）
  function getBusinessStyle(text) {
    const len = (text || '').replace(/\s/g, '').length;
    if (len >= 36) return cellStyle7;
    if (len >= 32) return cellStyle8;
    if (len >= 29) return cellStyle9;
    if (len >= 26) return cellStyle10;
    if (len >= 24) return cellStyle11;
    return cellStyle12;
  }

  // バッジクラス取得関数（背景色付きバッジ列用）
  function getBadgeClass(badge) {
    switch (badge) {
      case 'ゴ': return 'badge-gold';
      case '正': return 'badge-red';
      case '準': return 'badge-green';
      default: return '';
    }
  }

  // バッジセルのベーススタイル
  const badgeCellStyle = 'text-align:center;font-weight:600;padding:2px;white-space:nowrap;font-size:9px;vertical-align:middle;height:36px;line-height:36px;';

  // 他会場・ゲスト用スタイル（行高20px）
  const otherCellStyle9 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:9px;vertical-align:middle;height:20px;line-height:20px;';
  const otherCellStyle8 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:8px;vertical-align:middle;height:20px;line-height:20px;';
  const otherCellStyle7 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:7px;vertical-align:middle;height:20px;line-height:20px;';
  const otherCellStyle6 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:6px;vertical-align:middle;height:20px;line-height:20px;';

  // 他会場用会社名（175px幅、半角カタカナ考慮）
  function getOtherCompanyStyle(text) {
    const str = (text || '').replace(/\s/g, '');
    const halfWidthKana = (str.match(/[\uff61-\uff9f]/g) || []).length;
    const len = str.length - Math.floor(halfWidthKana / 2);
    if (len >= 22) return otherCellStyle6;
    if (len >= 19) return otherCellStyle7;
    if (len >= 17) return otherCellStyle8;
    return otherCellStyle9;
  }

  // 他会場用営業内容（auto幅、半角カタカナ考慮）
  function getOtherBusinessStyle(text) {
    const str = (text || '').replace(/\s/g, '');
    const halfWidthKana = (str.match(/[\uff61-\uff9f]/g) || []).length;
    const len = str.length - Math.floor(halfWidthKana / 2);
    if (len >= 35) return otherCellStyle6;
    if (len >= 30) return otherCellStyle7;
    if (len >= 25) return otherCellStyle8;
    return otherCellStyle9;
  }

  // ゲスト参加者名簿用会社名（310px幅、半角カタカナ考慮）
  function getGuestCompanyStyle2(text) {
    const str = (text || '').replace(/\s/g, '');
    const halfWidthKana = (str.match(/[\uff61-\uff9f]/g) || []).length;
    const len = str.length - Math.floor(halfWidthKana / 2);
    if (len >= 30) return cellStyle10;
    if (len >= 25) return cellStyle12;
    if (len >= 21) return cellStyle14;
    return cellStyle18;
  }

  // ゲスト参加者名簿用役職（180px幅、半角カタカナ考慮）
  function getGuestPositionStyle(text) {
    const str = (text || '').replace(/\s/g, '');
    const halfWidthKana = (str.match(/[\uff61-\uff9f]/g) || []).length;
    const len = str.length - Math.floor(halfWidthKana / 2);
    if (len >= 17) return cellStyle10;
    if (len >= 14) return cellStyle12;
    if (len >= 11) return cellStyle14;
    return cellStyle18;
  }

  // ========================================
  // local（福岡飯塚会場）の場合
  // ========================================
  if (kind === 'local') {
    const list = prep.local || [];
    
    previewTitle.textContent = '福岡飯塚会場_参加者名簿';

    if (!list.length) {
      container.innerHTML = '<div class="text-xs text-slate-400">表示できるデータがありません。</div>';
      return;
    }

    const perPage   = 16;
    const totalPage = Math.ceil(list.length / perPage);

    const colgroupHtml = `
  <col style="width:18px">
  <col style="width:18px">
  <col style="width:20px">
  <col style="width:18px">
  <col style="width:23px">
  <col style="width:115px">
  <col style="width:105px">
  <col style="width:70px">
  <col style="width:210px">
  <col style="width:115px">
  <col style="width:70px">
  <col style="width:281px">
`;

    for (let p = 0; p < totalPage; p++) {
      const start = p * perPage;
      const end   = start + perPage;
      const rows  = list.slice(start, end);

      const pageDiv = document.createElement('div');
      pageDiv.className = 'print-page' + (p < totalPage - 1 ? ' print-page-break' : '');

      const titleHtml = `
        <div class="print-header" style="font-size:22px;font-weight:bold;margin-bottom:6px;">
          守成クラブ福岡飯塚　${roundText}仕事バンバンプラザ 例会　参加者名簿（${p + 1}）
        </div>
        <div class="print-subheader">
          <span>稼働会員数：${activeMembers}　会員参加者：${participants}</span>
          <span>開催日：${eventDateStr}</span>
        </div>
      `;

      const table = document.createElement('table');
    table.className = 'print-table';
    table.style.tableLayout = 'fixed';
    table.style.width = '100%';
    table.style.maxWidth = '1063px';  // A4横 - padding

      table.innerHTML = `
  <colgroup>${colgroupHtml}</colgroup>
  <thead>
    <tr>
      <th style="padding:8px 2px;font-size:10px;line-height:1.1;">受<br>賞</th>
<th style="padding:8px 2px;font-size:10px;line-height:1.1;">紹<br>介<br>数</th>
<th style="padding:8px 2px;font-size:10px;line-height:1.1;">バ<br>ッ<br>ジ</th>
<th style="padding:8px 2px;font-size:10px;line-height:1.1;">出<br>欠</th>
<th style="padding:8px 2px;font-size:10px;line-height:1.1;">ブ<br>|<br>ス</th>
      <th style="font-size:12px;">氏名</th>
            <th style="font-size:10px;">フリガナ</th>
            <th style="font-size:12px;">役割</th>
            <th style="font-size:12px;">会社名</th>
            <th style="font-size:10px;">役職</th>
            <th style="font-size:12px;">紹介者</th>
            <th style="font-size:10px;">営業内容</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector('tbody');

      rows.forEach((row) => {
        const badge = row.badge || '';
        const badgeClass = getBadgeClass(badge);

        let boothDisplay = row.booth || '';
        if (boothDisplay === '×' || boothDisplay === 'x') boothDisplay = '';

        const tr = document.createElement('tr');
        tr.style.height = '36px';
        tr.innerHTML = `
          <td style="${centerCell9}">${row.award || ''}</td>
          <td style="${centerCell9}">${row.referralCnt != null ? row.referralCnt : ''}</td>
          <td class="${badgeClass}" style="${badgeCellStyle}">${badge}</td>
          <td style="${centerCell9}">${row.attendStatus || ''}</td>
          <td style="${centerCell9}">${boothDisplay}</td>
          <td style="${getNameStyle(row.name)}">${row.name || ''}</td>
          <td style="${getFuriganaStyle(row.furigana)}">${row.furigana || ''}</td>
          <td style="${getRoleStyle(row.role)}">${row.role || ''}</td>
          <td style="${getCompanyStyle(row.company)}">${row.company || ''}</td>
          <td style="${getPositionStyle(row.position)}">${row.position || ''}</td>
          <td style="${getIntroducerStyle(row.introducer)}">${row.introducer || ''}</td>
          <td style="${getBusinessStyle(row.business)}">${row.business || ''}</td>
        `;
        tbody.appendChild(tr);
      });

      // 中間ページのみ空行で埋める
      if (p < totalPage - 1) {
        for (let i = rows.length; i < perPage; i++) {
          const blankTr = document.createElement('tr');
          blankTr.style.height = '36px';
          blankTr.innerHTML = '<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>';
          tbody.appendChild(blankTr);
        }
      }

      pageDiv.innerHTML = titleHtml;
    
    // 横スクロール用ラッパー
    const scrollWrapper = document.createElement('div');
    scrollWrapper.style.overflowX = 'auto';
    scrollWrapper.style.webkitOverflowScrolling = 'touch';
    scrollWrapper.appendChild(table);
    
    pageDiv.appendChild(scrollWrapper);
    container.appendChild(pageDiv);
    }

    return;
  }

  // ========================================
  // others（他会場・ゲスト）の場合
  // ========================================
  if (kind === 'others') {
    const othersData = prep.others || {};
    const otherVenueList = othersData.otherVenue || [];
    const guestList = othersData.guest || [];

    previewTitle.textContent = '他会場・ゲスト_参加者名簿';

    if (!otherVenueList.length && !guestList.length) {
      container.innerHTML = '<div class="text-xs text-slate-400">表示できるデータがありません。</div>';
      return;
    }

    const pageDiv = document.createElement('div');
    pageDiv.className = 'print-page';

    // ページタイトル
    let contentHtml = `
      <div class="print-header" style="font-size:20px;font-weight:bold;margin-bottom:6px;">
        守成クラブ福岡飯塚　${roundText}仕事バンバンプラザ例会　他会場・ゲスト参加者名簿
      </div>
    `;

    // ========== 他会場参加者セクション ==========
    contentHtml += `
  <div class="print-subheader" style="margin-top:8px;">
    <span>（他会場参加者）　　他会場参加者数　${otherVenueList.length}　名</span>
    <span style="float:right;">開催日：${eventDateStr}</span>
  </div>
`;

    // 他会場参加者テーブル列幅（A4横最適化・折り返し不可）
    const otherColgroup = `
      <col style="width:22px">
      <col style="width:22px">
      <col style="width:105px">
      <col style="width:115px">
      <col style="width:150px">
      <col style="width:35px">
      <col style="width:220px">
      <col style="width:90px">
      <col style="width:75px">
      <col style="width:auto">
    `;

    contentHtml += `
      <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
      <table class="print-table" style="table-layout:fixed;width:100%;min-width:700px;margin-bottom:16px;">
    <colgroup>${otherColgroup}</colgroup>
    <thead>
      <tr>
        <th style="padding:6px 2px;font-size:8px;line-height:1.1;">バ<br>ッ<br>ジ</th>
        <th style="padding:8px 2px;font-size:8px;line-height:1.1;">ブ<br>|<br>ス</th>
        <th style="font-size:9px;">氏名</th>
        <th style="font-size:8px;">フリガナ</th>
        <th style="font-size:9px;">所属</th>
        <th style="font-size:9px;">役割</th>
        <th style="font-size:9px;">会社名</th>
        <th style="font-size:8px;">役職</th>
        <th style="font-size:9px;">紹介者</th>
        <th style="font-size:9px;">営業内容</th>
      </tr>
    </thead>
    <tbody>
`;

    otherVenueList.forEach(row => {
      const badge = row.badge || '';
      let boothDisplay = row.booth || '';
      if (boothDisplay === '×' || boothDisplay === 'x') boothDisplay = '';
      const badgeClass = getBadgeClass(badge);

      contentHtml += `
        <tr style="height:36px;">
          <td class="${badgeClass}" style="${badgeCellStyle}">${badge}</td>
          <td style="${centerCell9}">${boothDisplay}</td>
          <td style="${getNameStyle(row.name)}">${row.name || ''}</td>
          <td style="${getFuriganaStyle(row.furigana)}">${row.furigana || ''}</td>
          <td style="${cellStyle12}">${row.venue || ''}</td>
          <td style="${getRoleStyle(row.role)}">${row.role || ''}</td>
          <td style="${getCompanyStyle(row.company)}">${row.company || ''}</td>
          <td style="${getPositionStyle(row.position)}">${row.position || ''}</td>
          <td style="${getIntroducerStyle(row.introducer)}">${row.introducer || ''}</td>
          <td style="${getBusinessStyle(row.business)}">${row.business || ''}</td>
        </tr>
      `;
    });

    contentHtml += `</tbody></table></div>`;

    // ========== ゲスト参加者セクション ==========
    const yearMatch = eventName.match(/(\d{4})年/);
    const yearLabel = yearMatch ? yearMatch[1] : '';

    contentHtml += `
  <div class="print-subheader" style="margin-top:16px;margin-bottom:4px;">
    <span>（ゲスト参加者）　　ゲスト参加者数　${guestList.length}　名</span>
  </div>
`;

    // ゲストテーブル列幅（A4横最適化・折り返し不可）
    const guestColgroup = `
      <col style="width:75px">
      <col style="width:105px">
      <col style="width:115px">
      <col style="width:300px">
      <col style="width:200px">
      <col style="width:auto">
    `;

    contentHtml += `
      <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
      <table class="print-table" style="table-layout:fixed;width:100%;min-width:600px;">
        <colgroup>${guestColgroup}</colgroup>
        <thead>
          <tr>
            <th style="font-size:9px;">紹介者</th>
            <th style="font-size:9px;">氏名</th>
            <th style="font-size:8px;">フリガナ</th>
            <th style="font-size:9px;">会社名</th>
            <th style="font-size:8px;">役職</th>
            <th style="font-size:9px;">営業内容</th>
          </tr>
        </thead>
        <tbody>
    `;

    guestList.forEach(row => {
      contentHtml += `
        <tr style="height:36px;">
          <td style="${getIntroducerStyle(row.introducer)}">${row.introducer || ''}</td>
          <td style="${getNameStyle(row.name)}">${row.name || ''}</td>
          <td style="${getFuriganaStyle(row.furigana)}">${row.furigana || ''}</td>
          <td style="${getGuestCompanyStyle2(row.company)}">${row.company || ''}</td>
          <td style="${getGuestPositionStyle(row.position)}">${row.position || ''}</td>
          <td style="${getBusinessStyle(row.business)}">${row.business || ''}</td>
        </tr>
      `;
    });

    contentHtml += `</tbody></table></div>`;

    pageDiv.innerHTML = contentHtml;
    container.appendChild(pageDiv);

    return;
  }
}

// DOM読み込み時
console.log('=== ADDING DOMContentLoaded LISTENER ===');
document.addEventListener('DOMContentLoaded', () => {
  console.log('=== DOMContentLoaded FIRED ===');
  console.log('typeof setupTabs:', typeof setupTabs);
  setupTabs();

  // URLパラメータで特定タブを開く（例: ?tab=contact）
  // パラメータ指定時は他のタブを非表示にする（単独ページモード）
  const urlParams = new URLSearchParams(window.location.search);
  const tabParam = urlParams.get('tab');
  if (tabParam) {
    const targetTabId = tabParam + '-tab';
    const tabBtn = document.querySelector('.tab-btn[data-tab="' + targetTabId + '"]');
    if (tabBtn) {
      // メインカテゴリ行を非表示にし、該当サブグループのみ表示
      const mainRow = document.querySelector('.tab-main-row');
      if (mainRow) mainRow.style.display = 'none';
      document.querySelectorAll('.tab-sub-group').forEach(g => g.classList.remove('active'));
      const parentGroup = tabBtn.closest('.tab-sub-group');
      if (parentGroup) parentGroup.classList.add('active');
      // 他のタブボタンを非表示
      document.querySelectorAll('.tab-btn').forEach(btn => {
        if (btn.dataset.tab !== targetTabId) {
          btn.style.display = 'none';
        }
      });
      // 該当タブをクリックして表示
      tabBtn.click();
    }
  }

  const prepMenuSection    = document.getElementById('prepMenuSection');
  const prepPreviewSection = document.getElementById('prepPreviewSection');
  const prepBackButton     = document.getElementById('prepBackButton');
  const prepPrintButton    = document.getElementById('prepPrintButton');
  const btnLocalRoster     = document.getElementById('btnLocalRoster');
  const btnOthersRoster    = document.getElementById('btnOthersRoster');

  function openPreview(kind) {
    if (!dashboardData) return;
    if (prepMenuSection)    prepMenuSection.classList.add('hidden');
    if (prepPreviewSection) prepPreviewSection.classList.remove('hidden');
    showPrepPreview(kind);
  }

  if (btnLocalRoster) {
    btnLocalRoster.addEventListener('click', () => openPreview('local'));
  }
  if (btnOthersRoster) {
    btnOthersRoster.addEventListener('click', () => openPreview('others'));
  }

  if (prepBackButton && prepMenuSection && prepPreviewSection) {
    prepBackButton.addEventListener('click', () => {
      prepPreviewSection.classList.add('hidden');
      prepMenuSection.classList.remove('hidden');
    });
  }

  if (prepPrintButton) {
    prepPrintButton.addEventListener('click', () => {
      generatePDF();
    });
  }

  // PDFプレビューボタン
  const prepPdfPreviewButton = document.getElementById('prepPdfPreviewButton');
  if (prepPdfPreviewButton) {
    prepPdfPreviewButton.addEventListener('click', () => {
      previewPDF();
    });
  }

  // ========================================
  // 受付名簿ボタンのイベントリスナー
  // ========================================
  const btnReceptionLocal = document.getElementById('btnReceptionLocal');
  const btnReceptionOthers = document.getElementById('btnReceptionOthers');

  if (btnReceptionLocal) {
    btnReceptionLocal.addEventListener('click', () => {
      loadReceptionRoster('local');
    });
  }

  if (btnReceptionOthers) {
    btnReceptionOthers.addEventListener('click', () => {
      loadReceptionRoster('others');
    });
  }

  // 例会当日：役割分担表示ボタン
  const btnRoleAssignment = document.getElementById('btnRoleAssignment');
  const eventdayMenuSection = document.getElementById('eventdayMenuSection');
  const rolePreviewSection = document.getElementById('rolePreviewSection');
  const roleEditSection = document.getElementById('roleEditSection');
  const roleBackButton = document.getElementById('roleBackButton');
  const roleEditBackButton = document.getElementById('roleEditBackButton');

  if (btnRoleAssignment) {
    btnRoleAssignment.addEventListener('click', () => {
      if (eventdayMenuSection) eventdayMenuSection.classList.add('hidden');
      if (roleEditSection) roleEditSection.classList.add('hidden');
      if (rolePreviewSection) rolePreviewSection.classList.remove('hidden');
      loadRoleAssignment();
    });
  }

  if (roleBackButton) {
    roleBackButton.addEventListener('click', () => {
      if (rolePreviewSection) rolePreviewSection.classList.add('hidden');
      if (roleEditSection) roleEditSection.classList.add('hidden');
      if (eventdayMenuSection) eventdayMenuSection.classList.remove('hidden');
    });
  }

  // 例会当日：役割分担編集ボタン
  const btnRoleEdit = document.getElementById('btnRoleEdit');
  if (btnRoleEdit) {
    btnRoleEdit.addEventListener('click', () => {
      if (eventdayMenuSection) eventdayMenuSection.classList.add('hidden');
      if (rolePreviewSection) rolePreviewSection.classList.add('hidden');
      if (roleEditSection) roleEditSection.classList.remove('hidden');
      loadRoleEditForm();
    });
  }

  if (roleEditBackButton) {
    roleEditBackButton.addEventListener('click', () => {
      if (roleEditSection) roleEditSection.classList.add('hidden');
      if (rolePreviewSection) rolePreviewSection.classList.add('hidden');
      if (eventdayMenuSection) eventdayMenuSection.classList.remove('hidden');
    });
  }

  // チェックインボタン
  const btnCheckin = document.getElementById('btnCheckin');
  const checkinSection = document.getElementById('checkinSection');
  const checkinBackButton = document.getElementById('checkinBackButton');

  if (btnCheckin) {
    btnCheckin.addEventListener('click', () => {
      if (eventdayMenuSection) eventdayMenuSection.classList.add('hidden');
      if (rolePreviewSection) rolePreviewSection.classList.add('hidden');
      if (roleEditSection) roleEditSection.classList.add('hidden');
      if (checkinSection) checkinSection.classList.remove('hidden');
      loadCheckinStatus();
    });
  }

  if (checkinBackButton) {
    checkinBackButton.addEventListener('click', () => {
      if (checkinSection) checkinSection.classList.add('hidden');
      if (eventdayMenuSection) eventdayMenuSection.classList.remove('hidden');
    });
  }

  // 配席表ボタン
  const btnSeatingChart = document.getElementById('btnSeatingChart');
  if (btnSeatingChart) {
    btnSeatingChart.addEventListener('click', () => {
      openSeatingChartModal();
    });
  }

  // 式次第イベント設定
  setupShikidaiEvents();

  google.script.run
    .withSuccessHandler(renderDashboard)
    .getDashboardDataFast();
});

// ダッシュボード描画
function renderDashboard(data) {
  if (!data) return;

  console.log('monthlySummary:', data.monthlySummary);

  // 他タブからも使う共通データ
  dashboardData = data;
  dashboardData.meetingNo = calcMeetingNoFromEventName(data.eventName || '');

  // ------------------------------
  // 1. 対象例会
  // ------------------------------
  const eventNameEl = document.getElementById('eventName');
  if (eventNameEl) {
    eventNameEl.textContent = data.eventName || '-';
  }

  // ------------------------------
  // 2. 出欠サマリ
  // ------------------------------
  const att       = data.attendance || {};
  const attendNum = att.attend      != null ? Number(att.attend)      : 0;
  const memberNum = att.memberCount != null ? Number(att.memberCount) : 0;

  const attendCountEl   = document.getElementById('attendCount');
  const absentCountEl   = document.getElementById('absentCount');
  const noAnswerCountEl = document.getElementById('noAnswerCount');
  const memberCountEl   = document.getElementById('memberCount');

  if (attendCountEl)   attendCountEl.textContent   = att.attend   ?? '-';
  if (absentCountEl)   absentCountEl.textContent   = att.absent   ?? '-';
  if (noAnswerCountEl) noAnswerCountEl.textContent = att.noAnswer ?? '-';

  const afterPartyCountEl = document.getElementById('afterPartyCount');
  if (afterPartyCountEl) afterPartyCountEl.textContent = att.afterPartyCount ?? '-';

  // ------------------------------
  // 3. バッジ集計 + 会員数 + 前月比
  // ------------------------------
  const badges  = data.badges || {};
  const goldEl  = document.getElementById('goldCount');
  const redEl   = document.getElementById('redCount');
  const greenEl = document.getElementById('greenCount');

  if (goldEl)  goldEl.textContent  = badges.gold  ?? '-';
  if (redEl)   redEl.textContent   = badges.red   ?? '-';
  if (greenEl) greenEl.textContent = badges.green ?? '-';

  // 会員数と前月比
  const memberCountMainEl = document.getElementById('memberCountMain');
  const memberDiffEl      = document.getElementById('memberDiff');

  const currentMemberCount = memberNum || 0;
  const lastMonthCount = 125;

  if (memberCountMainEl) {
    memberCountMainEl.textContent = currentMemberCount || '-';
  }

  if (memberDiffEl && currentMemberCount > 0) {
    const diff = currentMemberCount - lastMonthCount;
    const sign = diff > 0 ? '+' : '';
    const color = diff > 0 ? 'text-green-600' : (diff < 0 ? 'text-red-600' : 'text-slate-500');
    memberDiffEl.textContent = `前月比 ${sign}${diff}人`;
    memberDiffEl.className = `text-xs ml-1 ${color}`;
  }

  // ------------------------------
  // 売上ハイライト
  // ------------------------------
  const sales        = data.sales || {};
  const total        = sales.total        || 0;
  const dealCount    = sales.dealCount    || 0;
  const meetingsCount = sales.meetingsCount || 0;
  const reporterCount = sales.reporterCount || 0;
  const salesMonth    = sales.salesMonth;

  const hlReporter = document.getElementById('highlightReporterCount');
  const hlMeetings = document.getElementById('highlightMeetingsCount');
  const hlDeal     = document.getElementById('highlightDealCount');
  const hlSales    = document.getElementById('highlightSalesTotal');
  const salesMonthLabel = document.getElementById('salesMonthLabel');

  if (hlReporter) hlReporter.textContent = reporterCount || '-';
  if (hlMeetings) hlMeetings.textContent = meetingsCount || '-';
  if (hlDeal)     hlDeal.textContent     = dealCount     || '-';
  if (hlSales)    hlSales.textContent    = total ? total.toLocaleString() : '-';

  if (salesMonthLabel && salesMonth) {
    salesMonthLabel.textContent = `【${salesMonth}月分】`;
  }

  // ------------------------------
  // 売上：0件含む報告者一覧
  // ------------------------------
  const zeroList = sales.zeroList || [];
  const zeroListSection = document.getElementById('zeroListSection');
  const zeroListBody = document.getElementById('zeroListBody');
  const zeroListCount = document.getElementById('zeroListCount');

  if (zeroListSection && zeroListBody) {
    if (zeroList.length > 0) {
      zeroListSection.classList.remove('hidden');
      if (zeroListCount) zeroListCount.textContent = `${zeroList.length}名`;
      
      zeroListBody.innerHTML = '';
      zeroList.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-amber-200 last:border-b-0';
        
        const meetingsCls = item.meetings === 0 ? 'text-red-600 font-bold' : '';
        const dealsCls    = item.deals === 0    ? 'text-red-600 font-bold' : '';
        const amountCls   = item.amount === 0   ? 'text-red-600 font-bold' : '';
        
        tr.innerHTML = `
          <td class="py-1 px-2 border border-amber-200">${escapeHtml(item.name)}</td>
          <td class="py-1 px-2 text-center border border-amber-200 ${meetingsCls}">${item.meetings}</td>
          <td class="py-1 px-2 text-center border border-amber-200 ${dealsCls}">${item.deals}</td>
          <td class="py-1 px-2 text-right border border-amber-200 ${amountCls}">${item.amount.toLocaleString()}円</td>
        `;
        zeroListBody.appendChild(tr);
      });
    } else {
      zeroListSection.classList.add('hidden');
    }
  }

  // ------------------------------
  // 入会希望業種（全期間）
  // ------------------------------
  const industryList = data.industryRanking || [];
  const industryBody = document.getElementById('industryListBody');
  if (industryBody) {
    if (industryList.length === 0) {
      industryBody.innerHTML = '<div class="text-slate-400 text-center py-3">希望業種の報告はありません</div>';
    } else {
      industryBody.innerHTML = industryList.map(item => {
        const hasRecommendations = item.recommendations && item.recommendations.length > 0;
        const recommendText = hasRecommendations
          ? item.recommendations.map(r => escapeHtml(r)).join('、')
          : 'なし';
        return `
        <div class="border-b border-slate-100 pb-2 mb-2 last:border-b-0 last:mb-0">
          <div class="flex items-center justify-between">
            <span class="font-medium text-slate-700">${escapeHtml(item.industry)}</span>
            <span class="text-xs text-slate-500">（${item.reporters.map(r => escapeHtml(r)).join('、')}）</span>
          </div>
          <div class="text-xs mt-1 ${hasRecommendations ? 'text-blue-600' : 'text-slate-400'}">
            → 会内に在籍: ${recommendText}
          </div>
        </div>
      `}).join('');
    }
  }

  // ------------------------------
  // 5. ゲストサマリ（概要タブ上部の小さい表）
  // ------------------------------
  const guests = data.guests || {};
  const guestSummaryText =
    `申請 ${guests.total || 0} 名 / 承認 ${guests.approved || 0} / 保留 ${guests.pending || 0}`;

  const guestSummaryEl = document.getElementById('guestSummary');
  if (guestSummaryEl) guestSummaryEl.textContent = guestSummaryText;

  const tbodyGuest = document.getElementById('guestListBody');
  if (tbodyGuest) {
    tbodyGuest.innerHTML = '';
    if (guests.list && guests.list.length) {
      guests.list.forEach(g => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-1 pr-2">${escapeHtml(g.guestName || '')}</td>
          <td class="py-1 pr-2">${escapeHtml(g.introName || '')}</td>
          <td class="py-1">${g.approved ? '✔︎' : ''}</td>
        `;
        tbodyGuest.appendChild(tr);
      });
    } else {
      tbodyGuest.innerHTML =
        '<tr><td colspan="3" class="py-2 text-slate-400">ゲスト申請なし</td></tr>';
    }
  }

  // ------------------------------
// 6. ゲスト詳細タブ（氏名〜営業内容 6項目）
// ------------------------------
const guestDetailBody = document.getElementById('guestDetailBody');
if (guestDetailBody) {
  const detail = (data.guests && data.guests.detail) || [];
  guestDetailBody.innerHTML = '';

  if (!detail.length) {
    guestDetailBody.innerHTML =
      '<tr><td colspan="6" class="py-2 px-3 text-slate-400">該当するゲストがいません。</td></tr>';
  } else {
    detail.forEach(g => {
      const tr = document.createElement('tr');
      tr.className = 'border-b last:border-b-0 hover:bg-slate-50';
      tr.innerHTML = `
        <td class="py-2 px-3 whitespace-nowrap font-medium">${escapeHtml(g.name || '')}</td>
        <td class="py-2 px-3 whitespace-nowrap">${escapeHtml(g.furigana || '')}</td>
        <td class="py-2 px-3 whitespace-nowrap">${escapeHtml(g.company || '')}</td>
        <td class="py-2 px-3 whitespace-nowrap">${escapeHtml(g.position || '')}</td>
        <td class="py-2 px-3 whitespace-nowrap">${escapeHtml(g.introName || '')}</td>
        <td class="py-2 px-3" style="min-width: 200px;">${escapeHtml(g.business || '')}</td>
      `;
      guestDetailBody.appendChild(tr);
    });
  }
}

  const guestTotalNum = guests.total != null ? Number(guests.total) : 0;

  // ------------------------------
  // 他会場詳細タブ
  // ------------------------------
  const otherVenueDetailBody = document.getElementById('otherVenueDetailBody');
  if (otherVenueDetailBody) {
    const otherDetail = (data.otherVenues && data.otherVenues.detail) || [];
    otherVenueDetailBody.innerHTML = '';

    if (!otherDetail.length) {
      otherVenueDetailBody.innerHTML =
        '<tr><td colspan="9" class="py-2 px-3 text-slate-400">該当する他会場会員がいません。</td></tr>';
    } else {
      otherDetail.forEach(v => {
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0 hover:bg-slate-50';
        tr.innerHTML = `
          <td class="py-2 px-3 whitespace-nowrap text-center">${v.booth === '○' ? '○' : ''}</td>
          <td class="py-2 px-3 whitespace-nowrap font-medium">${escapeHtml(v.name || '')}</td>
          <td class="py-2 px-3 whitespace-nowrap">${escapeHtml(v.furigana || '')}</td>
          <td class="py-2 px-3 whitespace-nowrap">${escapeHtml(v.venue || '')}</td>
          <td class="py-2 px-3 whitespace-nowrap">${escapeHtml(v.role || '')}</td>
          <td class="py-2 px-3 whitespace-nowrap">${escapeHtml(v.company || '')}</td>
          <td class="py-2 px-3 whitespace-nowrap">${escapeHtml(v.position || '')}</td>
          <td class="py-2 px-3 whitespace-nowrap">${escapeHtml(v.introName || '')}</td>
          <td class="py-2 px-3" style="min-width: 200px;">${escapeHtml(v.business || '')}</td>
        `;
        otherVenueDetailBody.appendChild(tr);
      });
    }
  }

  // ------------------------------
  // 7. 今月のハイライト
  // ------------------------------
  let rateDisplay = '-';
  if (attendNum > 0 && memberNum > 0) {
    const rate = Math.round((attendNum / memberNum) * 100);
    rateDisplay = rate;
  }

  const otherVenueCount = (data.otherVenues && data.otherVenues.detail) 
    ? data.otherVenues.detail.length 
    : 0;

  const totalParticipants = attendNum + guestTotalNum + otherVenueCount;

  const hlTotalParticipants = document.getElementById('highlightTotalParticipants');
  const hlAttend            = document.getElementById('highlightAttendRate');
  const hlGuest             = document.getElementById('highlightGuestCount');
  const hlOtherVenue        = document.getElementById('highlightOtherVenue');

  if (hlTotalParticipants) hlTotalParticipants.textContent = totalParticipants || '-';
  if (hlAttend)            hlAttend.textContent            = rateDisplay;
  if (hlGuest)             hlGuest.textContent             = guestTotalNum    || '-';
  if (hlOtherVenue)        hlOtherVenue.textContent        = otherVenueCount  || '-';
  if (hlDeal)              hlDeal.textContent              = dealCount        || '-';
  if (hlSales)             hlSales.textContent             = total ? total.toLocaleString() : '-';

  // 参加率リングアニメーション
  const rateCircle = document.getElementById('attendRateCircle');
  if (rateCircle && typeof rateDisplay === 'number') {
    const circumference = 2 * Math.PI * 34; // r=34
    const offset = circumference * (1 - rateDisplay / 100);
    setTimeout(() => {
      rateCircle.style.transition = 'stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1)';
      rateCircle.style.strokeDashoffset = offset;
    }, 300);
  }

  // ------------------------------
  // 8. 出欠詳細（カード）
  // ------------------------------
  const attendanceDetail = data.attendanceDetail || {};
  const attendList   = Array.isArray(attendanceDetail.attendList)   ? attendanceDetail.attendList   : [];
  const absentList   = Array.isArray(attendanceDetail.absentList)   ? attendanceDetail.absentList   : [];
  const noAnswerList = Array.isArray(attendanceDetail.noAnswerList) ? attendanceDetail.noAnswerList : [];

  const colAttend   = document.getElementById('attendListAttend');
  const colAbsent   = document.getElementById('attendListAbsent');
  const colNoAnswer = document.getElementById('attendListNoAnswer');

  const countAttendEl   = document.getElementById('attendCountAttend');
  const countAbsentEl   = document.getElementById('attendCountAbsent');
  const countNoAnswerEl = document.getElementById('attendCountNoAnswer');

  if (countAttendEl)   countAttendEl.textContent   = `${attendList.length} 名`;
  if (countAbsentEl)   countAbsentEl.textContent   = `${absentList.length} 名`;
  if (countNoAnswerEl) countNoAnswerEl.textContent = `${noAnswerList.length} 名`;

  const countAfterPartyEl = document.getElementById('attendCountAfterParty');
  if (countAfterPartyEl) {
    const apCount = attendList.filter(m => m.afterParty === '○').length;
    countAfterPartyEl.textContent = `${apCount} 名`;
  }

  const renderAttendList = (list, container, showTime) => {
    if (!container) return;
    container.innerHTML = '';
    if (!list.length) {
      container.innerHTML =
        '<div class="text-xs text-slate-400">該当者なし</div>';
      return;
    }
    list.forEach(item => {
      const style = getBadgeStyle(item.badge);
      const div = document.createElement('div');
      div.className = style.cardClass;
      const partyIcon = item.afterParty === '○' ? ' <span title="2部会参加">🍻</span>' : '';
      div.innerHTML = `
        <div class="member-card__name">${escapeHtml(item.name || '')}${partyIcon}</div>
        ${showTime && item.time
          ? `<div class="text-[10px] text-slate-500 mt-0.5">${escapeHtml(item.time)}</div>`
          : '' }
      `;
      container.appendChild(div);
    });
  };

  renderAttendList(attendList,   colAttend,   true);
  renderAttendList(absentList,   colAbsent,   true);
  renderAttendList(noAnswerList, colNoAnswer, false);

  // ------------------------------
  // 9. 更新予定（更新タブ）
  // ------------------------------
  const renewals = data.renewals || {};
  const nextArr  = Array.isArray(renewals.next)  ? renewals.next  : [];
  const next2Arr = Array.isArray(renewals.next2) ? renewals.next2 : [];

  const nextLabelEl   = document.getElementById('nextMonthLabel');
  const next2LabelEl  = document.getElementById('next2MonthLabel');
  const nextCountEl   = document.getElementById('nextMonthCount');
  const next2CountEl  = document.getElementById('next2MonthCount');
  const nextContainer = document.getElementById('nextMonthContainer');
  const next2Container= document.getElementById('next2MonthContainer');

  if (nextLabelEl)  nextLabelEl.textContent  = renewals.nextMonthLabel  || '来月更新';
  if (next2LabelEl) next2LabelEl.textContent = renewals.next2MonthLabel || '再来月更新';
  if (nextCountEl)  nextCountEl.textContent  = `${nextArr.length} 名`;
  if (next2CountEl) next2CountEl.textContent = `${next2Arr.length} 名`;

  const renderRenew = (arr, container) => {
    if (!container) return;
    container.innerHTML = '';

    if (!arr.length) {
      container.innerHTML =
        '<div class="text-xs text-slate-400">該当者なし</div>';
      return;
    }

    let hasZero = false;

    arr.forEach(m => {
      const style = getBadgeStyle(m.badge);
      const div = document.createElement('div');
      div.className = style.cardClass;
      const displayName = (m.hasZeroReferral ? '⚠️' : '') + m.name;
      if (m.hasZeroReferral) hasZero = true;
      div.innerHTML = `<div class="member-card__name">${escapeHtml(displayName)}</div>`;
      container.appendChild(div);
    });

    if (hasZero) {
      const warn = document.createElement('div');
      warn.className = 'col-span-full text-[11px] text-red-600 mt-1';
      warn.textContent = '⚠️紹介在籍人数が0人です。';
      container.appendChild(warn);
    }
  };

  renderRenew(nextArr,  nextContainer);
  renderRenew(next2Arr, next2Container);

  // ------------------------------
  // 10. チーム構成（チームタブ）
  // ------------------------------
  const teamData      = data.teams || { teams: [], unassigned: [] };
  const teamContainer = document.getElementById('teamContainer');

  if (teamContainer) {
    teamContainer.innerHTML = '';

    const hasTeams      = Array.isArray(teamData.teams) && teamData.teams.length > 0;
    const hasUnassigned = Array.isArray(teamData.unassigned) && teamData.unassigned.length > 0;

    if (!hasTeams && !hasUnassigned) {
      teamContainer.innerHTML =
        '<div class="text-xs text-slate-400">チーム情報が登録されていません。</div>';
    } else {
      if (hasTeams) {
        teamData.teams.forEach(team => {
          const card = document.createElement('div');
          card.className = 'bg-white rounded-xl shadow p-4 border border-slate-200';

          const members      = Array.isArray(team.members) ? team.members : [];
          const totalMembers = members.length;

          let membersHtml = '';
          if (!totalMembers) {
            membersHtml = '<div class="text-xs text-slate-400">メンバー未登録</div>';
          } else {
            membersHtml = members.map(m => {
              const style = getBadgeStyle(m.badge);
              return `
                <div class="${style.cardClass}">
                  <div class="member-card__name">${escapeHtml(m.name)}</div>
                </div>
              `;
            }).join('');
          }

          card.innerHTML = `
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-slate-800">${escapeHtml(team.teamName || 'チーム名未設定')}</h3>
              <span class="text-xs text-slate-500">${totalMembers} 名</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
              ${membersHtml}
            </div>
          `;
          teamContainer.appendChild(card);
        });
      }

      if (hasUnassigned) {
        const card = document.createElement('div');
        card.className =
          'bg-white rounded-xl shadow p-4 border border-dashed border-amber-300';

        const members      = teamData.unassigned;
        const totalMembers = members.length;

        let membersHtml = '';
        if (!totalMembers) {
          membersHtml = '<div class="text-xs text-amber-400">未配属メンバーなし</div>';
        } else {
          membersHtml = members.map(m => {
            const style = getBadgeStyle(m.badge);
            return `
              <div class="${style.cardClass}">
                <div class="member-card__name">${escapeHtml(m.name)}</div>
              </div>
            `;
          }).join('');
        }

        card.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-amber-800">未配属</h3>
            <span class="text-xs text-amber-700">${totalMembers} 名</span>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
            ${membersHtml}
          </div>
        `;
        teamContainer.appendChild(card);
      }
    }
  }

  // ------------------------------
  // 11. 累計表示（売上タブ）
  // ------------------------------
  if (data.monthlySummary) {
    const totals = data.monthlySummary.totals;
    if (totals) {
      const totalDealEl = document.getElementById('totalDealCount');
      const totalSalesEl = document.getElementById('totalSalesAmount');
      if (totalDealEl) totalDealEl.textContent = totals.dealCount || '-';
      if (totalSalesEl) totalSalesEl.textContent = totals.salesAmount ? totals.salesAmount.toLocaleString() + '円' : '-';
    }
  }

  // ------------------------------
  // 12. アンケート結果読み込み
  // ------------------------------
  loadSurveyResults();
}

// ★ 月別推移グラフ描画（renderDashboard の外に出す）
function renderMonthlyChart(monthlySummary) {
  const canvas = document.getElementById('monthlyChart');
  if (!canvas || !monthlySummary) return;

  if (window.monthlyChartInstance) {
    window.monthlyChartInstance.destroy();
  }

  const monthly = monthlySummary.monthly || [];
  if (!monthly.length) return;

  const labels = monthly.map(m => m.label);
  const attendRates = monthly.map(m => Math.round(m.attendRate * 100));
  const salesAmounts = monthly.map(m => Math.round(m.salesAmount / 10000));

  window.monthlyChartInstance = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          type: 'line',
          label: '出席率 (%)',
          data: attendRates,
          borderColor: '#10b981',
          backgroundColor: '#10b981',
          yAxisID: 'y1',
          tension: 0.3,
          pointRadius: 4,
          pointBackgroundColor: '#10b981',
          order: 1,
        },
        {
          type: 'bar',
          label: '売上 (万円)',
          data: salesAmounts,
          backgroundColor: 'rgba(59, 130, 246, 0.6)',
          borderColor: '#3b82f6',
          borderWidth: 1,
          yAxisID: 'y',
          order: 2,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: {
          position: 'top',
          labels: {
            font: { size: 11 },
            boxWidth: 12,
          },
        },
      },
      scales: {
        y: {
          type: 'linear',
          position: 'left',
          title: {
            display: true,
            text: '売上 (万円)',
            font: { size: 10 },
          },
          ticks: {
            font: { size: 10 },
            callback: (v) => v.toLocaleString(),
          },
        },
        y1: {
          type: 'linear',
          position: 'right',
          min: 0,
          max: 100,
          title: {
            display: true,
            text: '出席率 (%)',
            font: { size: 10 },
          },
          ticks: {
            font: { size: 10 },
          },
          grid: {
            drawOnChartArea: false,
          },
        },
        x: {
          ticks: {
            font: { size: 10 },
          },
        },
      },
    },
  });
}

// =============================================
// アンケート結果表示
// =============================================

/**
 * 前月のイベントキーを計算
 * アンケートは例会当日に送信されるため、次の開催日までは前回例会のキーを使用
 * @param {string} eventKey - 現在のイベントキー（例: 202602_01）
 * @returns {string} 前月のイベントキー（例: 202601_01）
 */
function getPreviousEventKey(eventKey) {
  if (!eventKey) return '';
  const match = eventKey.match(/^(\d{4})(\d{2})_(\d+)$/);
  if (!match) return eventKey;

  let year = parseInt(match[1], 10);
  let month = parseInt(match[2], 10);
  const num = match[3];

  month--;
  if (month < 1) {
    month = 12;
    year--;
  }

  return `${year}${String(month).padStart(2, '0')}_${num}`;
}

/**
 * イベントキーを日本語形式に変換
 * @param {string} eventKey - イベントキー（例: 202601_01）
 * @returns {string} 日本語形式（例: 2026年1月例会）
 */
function eventKeyToJapaneseForSurvey(eventKey) {
  if (!eventKey) return '';
  const match = eventKey.match(/^(\d{4})(\d{2})_\d+$/);
  if (!match) return eventKey;
  const year = match[1];
  const month = parseInt(match[2], 10);
  return `${year}年${month}月例会`;
}

/**
 * アンケート結果を読み込み
 */
function loadSurveyResults() {
  if (!dashboardData || !dashboardData.eventKey) {
    hideSurveyLoading();
    showSurveyNoData();
    return;
  }

  // 次の開催日までは前回例会のアンケート結果を表示
  const eventKey = getPreviousEventKey(dashboardData.eventKey);

  // アンケート用のイベント名を保存
  window.surveyEventName = eventKeyToJapaneseForSurvey(eventKey);

  google.script.run
    .withSuccessHandler(renderSurveyResults)
    .withFailureHandler(function(err) {
      console.error('アンケート結果取得エラー:', err);
      hideSurveyLoading();
      showSurveyNoData();
    })
    .getSurveyResultsForDashboard(eventKey);
}

/**
 * アンケート結果を描画
 */
/**
 * コメントを展開可能なリストとして描画（初期5件、ボタンで全件表示）
 * @param {HTMLElement} container - 描画先コンテナ
 * @param {Array} items - コメント配列（hasType=true: {type, text}, false: string）
 * @param {string} color - Tailwindカラー名（emerald, amber, slate）
 * @param {boolean} hasType - typeラベルの有無
 */
function renderExpandableComments(container, items, color, hasType) {
  const INITIAL_COUNT = 5;
  const bgClass = color === 'slate' ? 'bg-slate-100 text-slate-700' : `bg-${color}-50 text-${color}-800`;
  const labelClass = `text-${color}-500`;

  function renderItem(item) {
    if (hasType) {
      return `<div class="text-xs ${bgClass} rounded-lg px-3 py-2">
        <span class="${labelClass} mr-1">[${escapeHtml(item.type)}]</span>
        ${escapeHtml(item.text)}
      </div>`;
    }
    return `<div class="text-xs ${bgClass} rounded-lg px-3 py-2">${escapeHtml(item)}</div>`;
  }

  if (items.length <= INITIAL_COUNT) {
    container.innerHTML = items.map(renderItem).join('');
    return;
  }

  // 初期表示：最初の5件 + 「すべて表示」ボタン
  const initialHtml = items.slice(0, INITIAL_COUNT).map(renderItem).join('');
  const restHtml = items.slice(INITIAL_COUNT).map(renderItem).join('');
  const toggleId = 'toggle_' + color + '_' + Date.now();

  container.innerHTML = initialHtml
    + `<div id="${toggleId}_rest" style="display:none">${restHtml}</div>`
    + `<button id="${toggleId}_btn" onclick="document.getElementById('${toggleId}_rest').style.display='block';this.style.display='none';" class="text-xs text-blue-500 hover:text-blue-700 pl-1 cursor-pointer mt-1">▼ 他 ${items.length - INITIAL_COUNT}件を表示</button>`;
}

function renderSurveyResults(data) {
  hideSurveyLoading();

  if (!data || !data.success) {
    showSurveyNoData();
    return;
  }

  const { stats, scores, comments } = data;

  // イベント名ラベル（前回例会名を表示）
  const eventLabel = document.getElementById('surveyEventLabel');
  if (eventLabel && window.surveyEventName) {
    eventLabel.textContent = `（${window.surveyEventName}）`;
  }

  // 回答率
  const responseRateEl = document.getElementById('surveyResponseRate');
  const responseCountEl = document.getElementById('surveyResponseCount');
  const sentCountEl = document.getElementById('surveySentCount');
  const progressBar = document.getElementById('surveyProgressBar');

  if (responseRateEl) responseRateEl.textContent = stats.responseRate || 0;
  if (responseCountEl) responseCountEl.textContent = stats.responseCount || 0;
  if (sentCountEl) sentCountEl.textContent = stats.sentCount || 0;
  if (progressBar) progressBar.style.width = `${Math.min(stats.responseRate || 0, 100)}%`;

  // 満足度スコア
  const meetingScore = scores.meeting.avg || 0;
  const clubScore = scores.club.avg || 0;
  const meetingDist = scores.meeting.distribution || [0, 0, 0, 0, 0];
  const clubDist = scores.club.distribution || [0, 0, 0, 0, 0];

  const meetingScoreEl = document.getElementById('surveyMeetingScore');
  const meetingEmojiEl = document.getElementById('surveyMeetingEmoji');
  const clubScoreEl = document.getElementById('surveyClubScore');
  const clubEmojiEl = document.getElementById('surveyClubEmoji');

  if (meetingScoreEl) meetingScoreEl.textContent = meetingScore > 0 ? meetingScore.toFixed(1) : '-';
  if (meetingEmojiEl) meetingEmojiEl.textContent = getScoreEmoji(meetingScore);
  if (clubScoreEl) clubScoreEl.textContent = clubScore > 0 ? clubScore.toFixed(1) : '-';
  if (clubEmojiEl) clubEmojiEl.textContent = getScoreEmoji(clubScore);

  // 満足度分布（横棒グラフ）
  renderDistributionChart('surveyMeetingDistribution', meetingDist, 'blue');
  renderDistributionChart('surveyClubDistribution', clubDist, 'purple');

  // コメント
  const allGoodComments = [
    ...comments.meetingGood.map(c => ({ type: '例会', text: c })),
    ...comments.clubGood.map(c => ({ type: '福岡飯塚', text: c }))
  ];
  const allImproveComments = [
    ...comments.meetingImprove.map(c => ({ type: '例会', text: c })),
    ...comments.clubImprove.map(c => ({ type: '福岡飯塚', text: c }))
  ];

  const goodSection = document.getElementById('surveyGoodSection');
  const improveSection = document.getElementById('surveyImproveSection');
  const noComments = document.getElementById('surveyNoComments');
  const goodCountEl = document.getElementById('surveyGoodCount');
  const improveCountEl = document.getElementById('surveyImproveCount');
  const goodContainer = document.getElementById('surveyGoodComments');
  const improveContainer = document.getElementById('surveyImproveComments');

  if (allGoodComments.length > 0) {
    if (goodSection) goodSection.classList.remove('hidden');
    if (goodCountEl) goodCountEl.textContent = `(${allGoodComments.length}件)`;
    if (goodContainer) {
      renderExpandableComments(goodContainer, allGoodComments, 'emerald', true);
    }
  } else {
    if (goodSection) goodSection.classList.add('hidden');
  }

  if (allImproveComments.length > 0) {
    if (improveSection) improveSection.classList.remove('hidden');
    if (improveCountEl) improveCountEl.textContent = `(${allImproveComments.length}件)`;
    if (improveContainer) {
      renderExpandableComments(improveContainer, allImproveComments, 'amber', true);
    }
  } else {
    if (improveSection) improveSection.classList.add('hidden');
  }

  // その他コメント
  const otherComments = comments.otherComments || [];
  const otherSection = document.getElementById('surveyOtherSection');
  const otherCountEl = document.getElementById('surveyOtherCount');
  const otherContainer = document.getElementById('surveyOtherComments');

  if (otherComments.length > 0) {
    if (otherSection) otherSection.classList.remove('hidden');
    if (otherCountEl) otherCountEl.textContent = `(${otherComments.length}件)`;
    if (otherContainer) {
      renderExpandableComments(otherContainer, otherComments, 'slate', false);
    }
  } else {
    if (otherSection) otherSection.classList.add('hidden');
  }

  // コメントなし
  if (allGoodComments.length === 0 && allImproveComments.length === 0 && otherComments.length === 0) {
    if (noComments) noComments.classList.remove('hidden');
  } else {
    if (noComments) noComments.classList.add('hidden');
  }

  // データなし表示を隠す
  const noDataEl = document.getElementById('surveyNoData');
  if (noDataEl) noDataEl.classList.add('hidden');
}

/**
 * スコアに応じた絵文字を返す
 */
function getScoreEmoji(score) {
  if (score >= 4.5) return '😄';
  if (score >= 4.0) return '🙂';
  if (score >= 3.0) return '😐';
  if (score >= 2.0) return '😕';
  if (score > 0) return '😞';
  return '-';
}

/**
 * 満足度分布の横棒グラフを描画（Google口コミ風）
 * @param {string} containerId - コンテナ要素のID
 * @param {Array<number>} distribution - 1〜5点の分布配列 [1点の数, 2点の数, ..., 5点の数]
 * @param {string} color - カラーテーマ ('blue' or 'purple')
 */
function renderDistributionChart(containerId, distribution, color) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const total = distribution.reduce((a, b) => a + b, 0);
  const maxCount = Math.max(...distribution, 1);

  // カラー設定
  const barColors = {
    blue: 'bg-blue-500',
    purple: 'bg-purple-500'
  };
  const barBgColors = {
    blue: 'bg-blue-200',
    purple: 'bg-purple-200'
  };
  const textColors = {
    blue: 'text-blue-700',
    purple: 'text-purple-700'
  };

  const barColor = barColors[color] || 'bg-blue-500';
  const barBgColor = barBgColors[color] || 'bg-blue-200';
  const textColor = textColors[color] || 'text-blue-700';

  // 5点から1点の順に表示
  let html = '';
  for (let i = 4; i >= 0; i--) {
    const score = i + 1;
    const count = distribution[i];
    const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
    const barWidth = maxCount > 0 ? Math.round((count / maxCount) * 100) : 0;

    html += `
      <div class="flex items-center gap-2 text-xs">
        <span class="${textColor} w-3 text-right font-medium">${score}</span>
        <div class="flex-1 ${barBgColor} rounded-full h-2 overflow-hidden">
          <div class="${barColor} h-2 rounded-full transition-all duration-500" style="width: ${barWidth}%"></div>
        </div>
        <span class="text-slate-500 w-6 text-right">${count}</span>
      </div>
    `;
  }

  container.innerHTML = html;
}

/**
 * ローディング表示を非表示
 */
function hideSurveyLoading() {
  const loading = document.getElementById('surveyLoading');
  if (loading) loading.classList.add('hidden');
}

/**
 * データなし表示を表示
 */
function showSurveyNoData() {
  const noData = document.getElementById('surveyNoData');
  if (noData) noData.classList.remove('hidden');
}

// =============================================
// 配席表モーダル関連
// =============================================

/**
 * 配席表モーダルを開く
 */
function openSeatingChartModal() {
  const modal = document.getElementById('seatingChartModal');
  if (modal) {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    loadSeatingChart();
  }
}

/**
 * 配席表モーダルを閉じる
 */
function closeSeatingChartModal() {
  const modal = document.getElementById('seatingChartModal');
  if (modal) {
    modal.classList.remove('active');
    document.body.style.overflow = '';
  }
}

/**
 * 配席データを読み込む
 */
function loadSeatingChart() {
  const content = document.getElementById('seatingChartContent');
  const titleEl = document.getElementById('seatingChartTitle');

  if (!content) return;

  // ローディング表示
  content.innerHTML = '<div class="seating-loading">配席データを読み込み中...</div>';

  // dashboardDataからeventKeyを取得
  let eventKey = '';
  console.log('[配席表] dashboardData:', dashboardData);

  if (dashboardData && dashboardData.eventKey) {
    eventKey = dashboardData.eventKey;
    console.log('[配席表] eventKey from dashboardData:', eventKey);
  } else if (dashboardData && dashboardData.eventName) {
    // eventNameからeventKeyを生成（例: 2026年1月例会 → 202601_01）
    eventKey = generateEventKeyFromName(dashboardData.eventName);
    console.log('[配席表] eventKey generated from eventName:', dashboardData.eventName, '->', eventKey);
  }

  if (!eventKey) {
    content.innerHTML = '<div class="seating-error">例会情報が取得できません</div>';
    console.error('[配席表] eventKeyが取得できません');
    return;
  }

  // タイトルに例会名を表示
  if (titleEl && dashboardData && dashboardData.eventName) {
    titleEl.textContent = `配席表（${dashboardData.eventName}）`;
  }

  // GASからデータ取得
  console.log('[配席表] getSeatingArchive呼び出し:', eventKey);
  google.script.run
    .withSuccessHandler(result => {
      console.log('[配席表] getSeatingArchive結果:', result);
      if (result.success) {
        renderSeatingChart(result);
      } else {
        content.innerHTML = `<div class="seating-error">${result.error || '配席データの取得に失敗しました'}</div>`;
      }
    })
    .withFailureHandler(err => {
      console.error('[配席表] getSeatingArchiveエラー:', err);
      content.innerHTML = `<div class="seating-error">エラー: ${err.message || '不明なエラー'}</div>`;
    })
    .getSeatingArchive(eventKey);
}

/**
 * eventNameからeventKeyを生成
 * 例: "2026年1月例会" → "202601_01"
 *     "2026年01月 第1例会" → "202601_01"
 */
function generateEventKeyFromName(eventName) {
  if (!eventName) return '';

  // パターン1: "2026年1月例会" のシンプルな形式
  let match = eventName.match(/(\d{4})年(\d{1,2})月例会/);
  if (match) {
    const year = match[1];
    const month = match[2].padStart(2, '0');
    return `${year}${month}_01`;
  }

  // パターン2: "2026年01月 第1例会" の形式
  match = eventName.match(/(\d{4})年(\d{1,2})月\s*第(\d+)例会/);
  if (match) {
    const year = match[1];
    const month = match[2].padStart(2, '0');
    const no = match[3].padStart(2, '0');
    return `${year}${month}_${no}`;
  }

  return '';
}

/**
 * 配席表を描画
 * @param {Object} data - 配席アーカイブデータ
 */
function renderSeatingChart(data) {
  const content = document.getElementById('seatingChartContent');
  if (!content) return;

  const { assignments, tables, layout } = data;

  // データがない場合
  if (!assignments || assignments.length === 0) {
    content.innerHTML = '<div class="seating-empty">配席データがありません<br><span style="font-size: 0.8em;">（座席配置がまだ反映されていません）</span></div>';
    return;
  }

  let html = '';

  // ステージ表示
  html += '<div class="seating-stage">【ステージ】</div>';

  // PAテーブルは除外
  const tableNames = Object.keys(tables).filter(t => t !== 'PA').sort();

  // layout配列に従って配置
  if (layout && layout.length > 0) {
    let tableIndex = 0;
    layout.forEach(rowCount => {
      html += '<div class="seating-table-row">';
      for (let i = 0; i < rowCount && tableIndex < tableNames.length; i++) {
        html += renderTableCard(tableNames[tableIndex], assignments);
        tableIndex++;
      }
      html += '</div>';
    });
    // 残りがあれば追加
    if (tableIndex < tableNames.length) {
      html += '<div class="seating-table-row">';
      for (; tableIndex < tableNames.length; tableIndex++) {
        html += renderTableCard(tableNames[tableIndex], assignments);
      }
      html += '</div>';
    }
  } else {
    // layoutがない場合は3列
    for (let i = 0; i < tableNames.length; i += 3) {
      html += '<div class="seating-table-row">';
      for (let j = i; j < i + 3 && j < tableNames.length; j++) {
        html += renderTableCard(tableNames[j], assignments);
      }
      html += '</div>';
    }
  }

  // PA/司会表示（PAテーブルがある場合）
  if (tables && tables['PA']) {
    const paMembers = assignments.filter(a => a.table === 'PA');
    if (paMembers.length > 0) {
      html += '<div class="seating-pa-row">';
      paMembers.forEach(m => {
        const role = m.seat === 0 ? 'PA' : '司会';
        html += `<div class="seating-pa-badge"><span class="seating-pa-role">${role}</span><span class="seating-pa-name">${escapeHtml(m.name || '')}</span></div>`;
      });
      html += '</div>';
    }
  }

  content.innerHTML = html;
}

/**
 * テーブルカードを生成（2列レイアウト）
 */
function renderTableCard(tableName, assignments) {
  const tableMembers = assignments
    .filter(a => a.table === tableName)
    .sort((a, b) => a.seat - b.seat);

  let html = `<div class="seating-table-card">`;
  html += `<div class="seating-card-header">テーブル ${escapeHtml(tableName)}</div>`;
  html += `<div class="seating-card-grid">`;

  // 左右に分ける
  const leftCol = [], rightCol = [];
  tableMembers.forEach((m, i) => (i % 2 === 0 ? leftCol : rightCol).push(m));

  html += `<div class="seating-card-col">`;
  leftCol.forEach(m => { html += renderMemberCell(m); });
  html += `</div>`;

  html += `<div class="seating-card-col">`;
  rightCol.forEach(m => { html += renderMemberCell(m); });
  html += `</div>`;

  html += `</div></div>`;
  return html;
}

/**
 * メンバーセルを生成
 */
function renderMemberCell(member) {
  const isTM = member.seat === 0;
  const category = member.category || '会員';

  // 名前のスペースを詰める（全角スペース→なし）
  const name = (member.name || '').replace(/　/g, '');

  let cellClass = 'seating-cell';
  let label = '';

  if (isTM) {
    cellClass += ' seating-cell-tm';
    label = '<span class="seating-cell-label">TM</span>';
  } else if (category === 'ゲスト') {
    cellClass += ' seating-cell-guest';
    label = '<span class="seating-cell-label">ゲスト</span>';
  } else if (category === '他会場') {
    cellClass += ' seating-cell-other';
    label = '<span class="seating-cell-label">他会場</span>';
  } else {
    cellClass += ' seating-cell-member';
  }

  return `<div class="${cellClass}">${label}<span class="seating-cell-name">${escapeHtml(name)}</span></div>`;
}

// =============================================
// 役割分担関連
// =============================================

// 役割分担の読み込み＆描画（表示専用）
function loadRoleAssignment() {
  // 1. イベント当日データを読み込み（テーブルマスター用）
  google.script.run
    .withSuccessHandler(renderEventDayInfo)
    .getEventDayData();

  // 2. 役割分担データを読み込み（表示用）
  google.script.run
    .withSuccessHandler(result => {
      if (result.success) {
        renderRoleDisplayTable(result.assignments);
      } else {
        const container = document.getElementById('roleDisplayTable');
        if (container) {
          container.innerHTML = `<div class="text-center text-red-500 py-2">${result.message || 'エラー'}</div>`;
        }
      }
    })
    .getRoleAssignments('');
}

// 役割分担を表形式で表示（表示専用・スマホ対応）
function renderRoleDisplayTable(assignments) {
  const container = document.getElementById('roleDisplayTable');
  if (!container) return;

  if (!assignments || assignments.length === 0) {
    container.innerHTML = '<div class="text-center text-slate-400 py-4">役割分担が未設定です</div>';
    return;
  }

  // 同じ役割名をグループ化して表示
  const roleGroups = {};
  assignments.forEach(a => {
    if (!roleGroups[a.roleName]) {
      roleGroups[a.roleName] = [];
    }
    if (a.assignee) {
      roleGroups[a.roleName].push(a.assignee);
    }
  });

  // 役割順序（司会削除済み）
  const roleOrder = ['統括', 'PA', 'MC', 'バッジ授与', '受付', 'ゲスト誘導', '会員サポート', '名刺回収', '撮影'];

  let html = '<div class="space-y-1">';
  roleOrder.forEach((roleName, idx) => {
    const members = roleGroups[roleName] || [];
    const hasMembers = members.length > 0;
    const memberText = hasMembers ? members.join('、') : '-';
    const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-slate-100';
    const textClass = hasMembers ? 'text-slate-800 font-medium' : 'text-slate-400';

    html += `
      <div class="${bgClass} rounded-lg py-2.5 px-3 flex items-center">
        <span class="text-sm font-bold text-slate-600 w-28 shrink-0">${roleName}</span>
        <span class="text-sm ${textClass} flex-1">${memberText}</span>
      </div>
    `;
  });
  html += '</div>';

  container.innerHTML = html;
}

// イベント当日情報を描画（タイトル・テーブルマスター）
function renderEventDayInfo(data) {
  if (!data) return;

  const rolePreviewTitle = document.getElementById('rolePreviewTitle');
  const tableMasterBody = document.getElementById('tableMasterBody');

  if (rolePreviewTitle) {
    const meetingNo = calcMeetingNoFromEventName(data.eventName || '');
    const title = meetingNo
      ? `第${meetingNo}回 役割分担表`
      : '役割分担表';
    rolePreviewTitle.textContent = title;
  }

  if (tableMasterBody) {
    tableMasterBody.innerHTML = '';
    const tableMasters = data.tableMasters || [];
    tableMasters.forEach((tm, idx) => {
      const tr = document.createElement('tr');
      const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50';
      const hasTm = tm.tm && tm.tm.trim() !== '' && tm.tm !== '-';
      const tmClass = hasTm ? 'text-slate-800 font-medium' : 'text-slate-400';
      tr.className = bgClass;
      tr.innerHTML = `
        <td class="py-2.5 px-3 text-center font-bold text-slate-600 border-b border-slate-200">${tm.table}</td>
        <td class="py-2.5 px-3 text-left ${tmClass} border-b border-slate-200">${tm.tm || '-'}</td>
      `;
      tableMasterBody.appendChild(tr);
    });
  }
}

// ========================================
// 受付名簿：データ取得＆プレビュー表示
// ========================================
let receptionData = null;

function loadReceptionRoster(kind) {
  const prepMenuSection = document.getElementById('prepMenuSection');
  const prepPreviewSection = document.getElementById('prepPreviewSection');
  const container = document.getElementById('prepPreviewContainer');
  
  if (container) {
    container.innerHTML = '<div class="text-sm text-slate-500 py-4">データ取得中...</div>';
  }
  
  if (prepMenuSection) prepMenuSection.classList.add('hidden');
  if (prepPreviewSection) prepPreviewSection.classList.remove('hidden');
  
  google.script.run
    .withSuccessHandler((data) => {
      receptionData = data;
      showReceptionPreview(kind);
    })
    .withFailureHandler((err) => {
      console.error('受付名簿取得エラー:', err);
      if (container) {
        container.innerHTML = '<div class="text-sm text-red-500 py-4">データ取得に失敗しました。</div>';
      }
    })
    .getReceptionRosterData();
}

function showReceptionPreview(kind) {
  if (!receptionData) return;
  
  const previewTitle = document.getElementById('prepPreviewTitle');
  const container = document.getElementById('prepPreviewContainer');
  
  if (!previewTitle || !container) return;
  
  const eventName = receptionData.eventName || '';
  const reception = receptionData.reception || {};
  
  const round = calcMeetingNoFromEventName(eventName);
  const roundText = round ? `第${round}回 ` : '';
  
  // 開催日
  let eventDateStr = '';
  if (dashboardData && dashboardData.eventDate) {
    const d = new Date(dashboardData.eventDate);
    if (!isNaN(d)) {
      eventDateStr = `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
    }
  }
  
  container.innerHTML = '';
  
  // 共通スタイル（フォントサイズ24px、行高40px）
  const cellStyle = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:24px;vertical-align:middle;height:40px;line-height:40px;padding:2px 4px;';
  const centerCell = 'text-align:center;padding:2px 4px;white-space:nowrap;font-size:24px;vertical-align:middle;height:40px;line-height:40px;';
  const inputCell = 'text-align:center;padding:2px 4px;white-space:nowrap;font-size:24px;vertical-align:middle;height:40px;line-height:40px;min-width:70px;';

  // 受付名簿用スタイル（行高40px）
  const recCellStyle24 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:24px;vertical-align:middle;height:40px;line-height:40px;padding:2px 4px;';
  const recCellStyle20 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:20px;vertical-align:middle;height:40px;line-height:40px;padding:2px 4px;';
  const recCellStyle18 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:18px;vertical-align:middle;height:40px;line-height:40px;padding:2px 4px;';
  const recCellStyle16 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:16px;vertical-align:middle;height:40px;line-height:40px;padding:2px 4px;';
  const recCellStyle14 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px;vertical-align:middle;height:40px;line-height:40px;padding:2px 4px;';

  // 受付名簿用氏名（160px幅、半角カタカナ考慮）
  function getRecNameStyle(text) {
    const str = (text || '').replace(/\s/g, '');
    const halfWidthKana = (str.match(/[\uff61-\uff9f]/g) || []).length;
    const len = str.length - Math.floor(halfWidthKana / 2);
    if (len >= 9) return recCellStyle16;
    if (len >= 7) return recCellStyle20;
    return recCellStyle24;
  }

  // 受付名簿用フリガナ（180px幅、半角カタカナ考慮）
  function getRecFuriganaStyle(text) {
    const str = (text || '').replace(/\s/g, '');
    const halfWidthKana = (str.match(/[\uff61-\uff9f]/g) || []).length;
    const len = str.length - Math.floor(halfWidthKana / 2);
    if (len >= 11) return recCellStyle14;
    if (len >= 9) return recCellStyle16;
    if (len >= 8) return recCellStyle20;
    return recCellStyle24;
  }

  // 受付名簿用営業内容（auto幅約308px、半角カタカナ考慮）
  function getRecBusinessStyle(text) {
    const str = (text || '').replace(/\s/g, '');
    const halfWidthKana = (str.match(/[\uff61-\uff9f]/g) || []).length;
    const len = str.length - Math.floor(halfWidthKana / 2);
    if (len >= 19) return recCellStyle14;
    if (len >= 16) return recCellStyle16;
    if (len >= 14) return recCellStyle18;
    return recCellStyle20;
  }

  // 他会場・ゲスト受付名簿用スタイル（行高22px）
  const recOtherCellStyle10 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:10px;vertical-align:middle;height:22px;line-height:22px;padding:2px;';
  const recOtherCellStyle9 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:9px;vertical-align:middle;height:22px;line-height:22px;padding:2px;';
  const recOtherCellStyle8 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:8px;vertical-align:middle;height:22px;line-height:22px;padding:2px;';
  const recOtherCellStyle7 = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:7px;vertical-align:middle;height:22px;line-height:22px;padding:2px;';
  const recOtherCenterCell = 'text-align:center;padding:2px;white-space:nowrap;font-size:10px;vertical-align:middle;height:22px;line-height:22px;';
  const recOtherInputCell = 'text-align:center;padding:2px;white-space:nowrap;font-size:10px;vertical-align:middle;height:22px;line-height:22px;';

  // 他会場受付名簿用所属（auto幅、半角カタカナ考慮）
  function getRecOtherVenueStyle(text) {
    const str = (text || '').replace(/\s/g, '');
    const halfWidthKana = (str.match(/[\uff61-\uff9f]/g) || []).length;
    const len = str.length - Math.floor(halfWidthKana / 2);
    if (len >= 20) return recOtherCellStyle7;
    if (len >= 16) return recOtherCellStyle8;
    if (len >= 12) return recOtherCellStyle9;
    return recOtherCellStyle10;
  }

  // ゲスト受付名簿用会社名（auto幅、半角カタカナ考慮）
  function getRecGuestCompanyStyle(text) {
    const str = (text || '').replace(/\s/g, '');
    const halfWidthKana = (str.match(/[\uff61-\uff9f]/g) || []).length;
    const len = str.length - Math.floor(halfWidthKana / 2);
    if (len >= 25) return recOtherCellStyle7;
    if (len >= 20) return recOtherCellStyle8;
    if (len >= 15) return recOtherCellStyle9;
    return recOtherCellStyle10;
  }

  // ========================================
  // 福岡飯塚_受付名簿（ページ分割対応）
  // ========================================
  if (kind === 'local') {
    const list = reception.local || [];

    previewTitle.textContent = '福岡飯塚_受付名簿';

    if (!list.length) {
      container.innerHTML = '<div class="text-xs text-slate-400">表示できるデータがありません。</div>';
      return;
    }

    const colgroupHtml = `
      <col style="width:45px">
      <col style="width:60px">
      <col style="width:80px">
      <col style="width:160px">
      <col style="width:180px">
      <col style="width:auto">
      <col style="width:70px">
      <col style="width:70px">
      <col style="width:90px">
    `;

    const theadHtml = `
      <thead>
        <tr>
          <th style="font-size:14px;">No</th>
          <th style="font-size:14px;">座席</th>
          <th style="font-size:12px;">領収書<br>番号</th>
          <th style="font-size:14px;">氏名</th>
          <th style="font-size:14px;">フリガナ</th>
          <th style="font-size:14px;">営業内容</th>
          <th style="font-size:12px;">バッジ<br>貸出</th>
          <th style="font-size:12px;">バッジ<br>返却</th>
          <th style="font-size:12px;">キャンセル料</th>
        </tr>
      </thead>
    `;

    // ページ分割の設定（行高40pxに対応）
    const ROWS_PER_FIRST_PAGE = 15;  // 1ページ目
    const ROWS_PER_PAGE = 15;         // 2ページ目以降も同じ

    const totalPages = Math.ceil((list.length - ROWS_PER_FIRST_PAGE) / ROWS_PER_PAGE) + 1;
    const actualTotalPages = list.length <= ROWS_PER_FIRST_PAGE ? 1 : totalPages;

    let currentIndex = 0;
    let pageNum = 1;

    while (currentIndex < list.length) {
      const isFirstPage = pageNum === 1;
      const rowsThisPage = isFirstPage ? ROWS_PER_FIRST_PAGE : ROWS_PER_PAGE;
      const pageData = list.slice(currentIndex, currentIndex + rowsThisPage);

      const pageDiv = document.createElement('div');
      pageDiv.className = 'print-page';

      // ヘッダー（ページ番号付き）
      const pageIndicator = actualTotalPages > 1 ? `（${pageNum}/${actualTotalPages}）` : '';
      const titleHtml = `
        <div class="print-header" style="font-size:20px;font-weight:bold;margin-bottom:6px;">
          守成クラブ福岡飯塚　${roundText}仕事バンバンプラザ 例会　受付名簿${pageIndicator}
        </div>
        <div class="print-subheader">
          <span>福岡飯塚会員　${list.length}名</span>
          <span>開催日：${eventDateStr}</span>
        </div>
      `;

      const table = document.createElement('table');
      table.className = 'print-table';
      table.style.tableLayout = 'fixed';
      table.style.width = '100%';

      table.innerHTML = `
        <colgroup>${colgroupHtml}</colgroup>
        ${theadHtml}
        <tbody></tbody>
      `;

      const tbody = table.querySelector('tbody');

      pageData.forEach((row, idx) => {
        const tr = document.createElement('tr');
        tr.style.height = '40px';
        const globalNo = currentIndex + idx + 1;
        tr.innerHTML = `
          <td style="${centerCell}">${globalNo}</td>
          <td style="${centerCell}">${row.seat || ''}</td>
          <td style="${inputCell}"></td>
          <td style="${getRecNameStyle(row.name)}">${row.name || ''}</td>
          <td style="${getRecFuriganaStyle(row.furigana)}">${row.furigana || ''}</td>
          <td style="${getRecBusinessStyle(row.business)}">${row.business || ''}</td>
          <td style="${inputCell}"></td>
          <td style="${inputCell}"></td>
          <td style="${inputCell}"></td>
        `;
        tbody.appendChild(tr);
      });

      pageDiv.innerHTML = titleHtml;

      // 横スクロール用ラッパー
      const scrollWrapper = document.createElement('div');
      scrollWrapper.style.overflowX = 'auto';
      scrollWrapper.style.webkitOverflowScrolling = 'touch';
      scrollWrapper.appendChild(table);

      pageDiv.appendChild(scrollWrapper);
      container.appendChild(pageDiv);

      currentIndex += rowsThisPage;
      pageNum++;
    }

    return;
  }
  
 
  // ========================================
  // 他会場・ゲスト_受付名簿（ページ分割対応）
  // ========================================
  if (kind === 'others') {
    const othersData = reception.others || {};
    const otherVenueList = othersData.otherVenue || [];
    const guestList = othersData.guest || [];

    previewTitle.textContent = '他会場・ゲスト_受付名簿';

    if (!otherVenueList.length && !guestList.length) {
      container.innerHTML = '<div class="text-xs text-slate-400">表示できるデータがありません。</div>';
      return;
    }

    const otherColgroup = `
      <col style="width:30px">
      <col style="width:40px">
      <col style="width:60px">
      <col style="width:150px">
      <col style="width:200px">
      <col style="width:auto">
      <col style="width:50px">
      <col style="width:50px">
      <col style="width:80px">
    `;

    const guestColgroup = `
      <col style="width:30px">
      <col style="width:40px">
      <col style="width:60px">
      <col style="width:150px">
      <col style="width:200px">
      <col style="width:auto">
      <col style="width:100px">
    `;

    const otherTheadHtml = `
      <thead>
        <tr>
          <th style="font-size:9px;">No.</th>
          <th style="font-size:9px;">座席</th>
          <th style="font-size:8px;">領収書<br>No.</th>
          <th style="font-size:9px;">氏名</th>
          <th style="font-size:9px;">フリガナ</th>
          <th style="font-size:9px;">所属</th>
          <th style="font-size:8px;">バッジ<br>貸出</th>
          <th style="font-size:8px;">バッジ<br>返却</th>
          <th style="font-size:9px;">備考</th>
        </tr>
      </thead>
    `;

    const guestTheadHtml = `
      <thead>
        <tr>
          <th style="font-size:9px;">No.</th>
          <th style="font-size:9px;">座席</th>
          <th style="font-size:8px;">領収書<br>No.</th>
          <th style="font-size:9px;">氏名</th>
          <th style="font-size:9px;">フリガナ</th>
          <th style="font-size:9px;">会社名</th>
          <th style="font-size:9px;">備考</th>
        </tr>
      </thead>
    `;

    // ページ分割の設定（行数）
    const ROWS_PER_FIRST_PAGE = 20;  // 1ページ目（両セクションのヘッダーあり）
    const ROWS_PER_PAGE = 24;         // 2ページ目以降

    // 全データを結合して行単位で管理
    const allRows = [];

    // 他会場参加者の行を追加
    otherVenueList.forEach((row, idx) => {
      allRows.push({
        type: 'other',
        no: idx + 1,
        seat: row.seat || '',
        name: row.name || '',
        furigana: row.furigana || '',
        col5: row.venue || '',
        isFirst: idx === 0
      });
    });

    // ゲスト参加者の行を追加
    guestList.forEach((row, idx) => {
      allRows.push({
        type: 'guest',
        no: idx + 1,
        seat: row.seat || '',
        name: row.name || '',
        furigana: row.furigana || '',
        col5: row.company || '',
        isFirst: idx === 0
      });
    });

    // ページ数計算
    const totalRows = allRows.length;
    let estimatedPages = 1;
    if (totalRows > ROWS_PER_FIRST_PAGE) {
      estimatedPages = 1 + Math.ceil((totalRows - ROWS_PER_FIRST_PAGE) / ROWS_PER_PAGE);
    }

    let currentIndex = 0;
    let pageNum = 1;
    let currentType = null;

    while (currentIndex < allRows.length) {
      const isFirstPage = pageNum === 1;
      const rowsThisPage = isFirstPage ? ROWS_PER_FIRST_PAGE : ROWS_PER_PAGE;

      const pageDiv = document.createElement('div');
      pageDiv.className = 'print-page';

      // ページ番号
      const pageIndicator = estimatedPages > 1 ? `（${pageNum}/${estimatedPages}）` : '';

      let contentHtml = `
        <div class="print-header" style="font-size:20px;font-weight:bold;margin-bottom:6px;">
          守成クラブ福岡飯塚　${roundText}仕事バンバンプラザ例会　他会場・ゲスト受付名簿${pageIndicator}
        </div>
      `;

      let rowsRendered = 0;
      let pageStartIndex = currentIndex;

      while (rowsRendered < rowsThisPage && currentIndex < allRows.length) {
        const row = allRows[currentIndex];

        // セクション切り替え時にヘッダーを追加
        if (row.type !== currentType) {
          // 前のテーブルを閉じる
          if (currentType !== null) {
            contentHtml += `</tbody></table></div>`;
          }

          currentType = row.type;

          if (currentType === 'other') {
            contentHtml += `
              <div class="print-subheader" style="margin-top:8px;">
                <span>（他会場参加者）　${otherVenueList.length}名</span>
                <span style="float:right;">開催日：${eventDateStr}</span>
              </div>
              <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
              <table class="print-table" style="table-layout:fixed;width:100%;min-width:700px;margin-bottom:16px;">
                <colgroup>${otherColgroup}</colgroup>
                ${otherTheadHtml}
                <tbody>
            `;
          } else {
            contentHtml += `
              <div class="print-subheader" style="margin-top:16px;margin-bottom:4px;">
                <span>（ゲスト参加者）　${guestList.length}名</span>
              </div>
              <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
              <table class="print-table" style="table-layout:fixed;width:100%;min-width:600px;">
                <colgroup>${guestColgroup}</colgroup>
                ${guestTheadHtml}
                <tbody>
            `;
          }
          rowsRendered += 2; // セクションヘッダー分
        }

        // 行を追加
        if (currentType === 'other') {
          contentHtml += `
            <tr style="height:40px;">
              <td style="${centerCell}">${row.no}</td>
              <td style="${centerCell}">${row.seat}</td>
              <td style="${inputCell}"></td>
              <td style="${getRecNameStyle(row.name)}">${row.name}</td>
              <td style="${recCellStyle20}">${row.furigana}</td>
              <td style="${getRecBusinessStyle(row.col5)}">${row.col5}</td>
              <td style="${inputCell}"></td>
              <td style="${inputCell}"></td>
              <td style="${inputCell}"></td>
            </tr>
          `;
        } else {
          contentHtml += `
            <tr style="height:40px;">
              <td style="${centerCell}">${row.no}</td>
              <td style="${centerCell}">${row.seat}</td>
              <td style="${inputCell}"></td>
              <td style="${getRecNameStyle(row.name)}">${row.name}</td>
              <td style="${recCellStyle20}">${row.furigana}</td>
              <td style="${getRecBusinessStyle(row.col5)}">${row.col5}</td>
              <td style="${inputCell}"></td>
            </tr>
          `;
        }

        currentIndex++;
        rowsRendered++;
      }

      // テーブルを閉じる
      if (currentType !== null) {
        contentHtml += `</tbody></table></div>`;
      }

      // 該当者なしの場合
      if (pageNum === 1 && !otherVenueList.length && !guestList.length) {
        contentHtml = `
          <div class="print-header" style="font-size:20px;font-weight:bold;margin-bottom:6px;">
            守成クラブ福岡飯塚　${roundText}仕事バンバンプラザ例会　他会場・ゲスト受付名簿
          </div>
          <div style="text-align:center;color:#94a3b8;padding:20px;">該当者なし</div>
        `;
      }

      pageDiv.innerHTML = contentHtml;
      container.appendChild(pageDiv);

      pageNum++;
    }

    return;
  }
}

// ========================================
// 式次第編集
// ========================================

// フォームをレンダリング
function renderShikidaiEditForm(data) {
  const timeTableBody = document.getElementById('shikidaiTimeTableBody');
  const noticesBody = document.getElementById('shikidaiNoticesBody');
  const resultDiv = document.getElementById('shikidaiTestResult');

  // デバッグ用
  if (resultDiv) {
    resultDiv.textContent = JSON.stringify(data, null, 2);
  }

  // 司会進行を描画
  const mcPerson1 = document.getElementById('mcPerson1');
  const mcPerson2 = document.getElementById('mcPerson2');
  if (mcPerson1 && mcPerson2 && data.mcPersons) {
    mcPerson1.value = data.mcPersons[0] || '';
    mcPerson2.value = data.mcPersons[1] || '';
  }

  // タイムテーブル描画
  if (timeTableBody && data.timeTable) {
    timeTableBody.innerHTML = '';
    data.timeTable.forEach((row, idx) => {
      const tr = document.createElement('tr');
      const isSubtitle = !row.time;
      tr.className = isSubtitle ? 'bg-amber-50' : '';
      tr.innerHTML = `
        <td class="border px-1 py-1">
          <input type="text" class="w-full px-1 py-0.5 text-xs border rounded time-input"
                 data-field="time" data-idx="${idx}" value="${escapeHtml(row.time || '')}"
                 placeholder="${isSubtitle ? '(サブタイトル)' : ''}">
        </td>
        <td class="border px-1 py-1">
          <input type="text" class="w-full px-1 py-0.5 text-xs border rounded"
                 data-field="item" data-idx="${idx}" value="${escapeHtml(row.item || '')}">
        </td>
        <td class="border px-1 py-1">
          <input type="text" class="w-full px-1 py-0.5 text-xs border rounded"
                 data-field="person" data-idx="${idx}" value="${escapeHtml(row.person || '')}">
        </td>
        <td class="border px-1 py-1">
          <input type="text" class="w-full px-1 py-0.5 text-xs border rounded"
                 data-field="note" data-idx="${idx}" value="${escapeHtml(row.note || '')}">
        </td>
        <td class="border px-1 py-1 text-center whitespace-nowrap">
          <button type="button" class="shikidai-move-up text-gray-400 hover:text-blue-500 px-0.5">↑</button>
          <button type="button" class="shikidai-move-down text-gray-400 hover:text-blue-500 px-0.5">↓</button>
          <button type="button" class="shikidai-delete-row text-red-500 hover:text-red-700 px-0.5">🗑</button>
        </td>
      `;
      timeTableBody.appendChild(tr);
    });

    // 時間入力変更時に背景色を切り替え
    timeTableBody.querySelectorAll('.time-input').forEach(input => {
      input.addEventListener('input', (e) => {
        const tr = e.target.closest('tr');
        if (e.target.value.trim()) {
          tr.className = '';
          e.target.placeholder = '';
        } else {
          tr.className = 'bg-amber-50';
          e.target.placeholder = '(サブタイトル)';
        }
      });
    });
  }

  // お知らせ描画
  if (noticesBody && data.notices) {
    noticesBody.innerHTML = '';
    Object.entries(data.notices).forEach(([key, value]) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border px-1 py-1">
          <input type="text" class="w-full px-1 py-0.5 text-xs border rounded bg-slate-50"
                 data-notice-key="${escapeHtml(key)}" value="${escapeHtml(key)}" readonly>
        </td>
        <td class="border px-1 py-1">
          <textarea class="w-full px-1 py-0.5 text-xs border rounded resize-y"
                    data-notice-value="${escapeHtml(key)}" rows="2">${escapeHtml(value || '')}</textarea>
        </td>
      `;
      noticesBody.appendChild(tr);
    });
  }
}

// 新しい行を追加
function addShikidaiRow() {
  const timeTableBody = document.getElementById('shikidaiTimeTableBody');
  if (!timeTableBody) return;

  const idx = timeTableBody.querySelectorAll('tr').length;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="border px-1 py-1">
      <input type="text" class="w-full px-1 py-0.5 text-xs border rounded time-input"
             data-field="time" data-idx="${idx}" value="">
    </td>
    <td class="border px-1 py-1">
      <input type="text" class="w-full px-1 py-0.5 text-xs border rounded"
             data-field="item" data-idx="${idx}" value="">
    </td>
    <td class="border px-1 py-1">
      <input type="text" class="w-full px-1 py-0.5 text-xs border rounded"
             data-field="person" data-idx="${idx}" value="">
    </td>
    <td class="border px-1 py-1">
      <input type="text" class="w-full px-1 py-0.5 text-xs border rounded"
             data-field="note" data-idx="${idx}" value="">
    </td>
    <td class="border px-1 py-1 text-center whitespace-nowrap">
      <button type="button" class="shikidai-move-up text-gray-400 hover:text-blue-500 px-0.5">↑</button>
      <button type="button" class="shikidai-move-down text-gray-400 hover:text-blue-500 px-0.5">↓</button>
      <button type="button" class="shikidai-delete-row text-red-500 hover:text-red-700 px-0.5">🗑</button>
    </td>
  `;
  timeTableBody.appendChild(tr);

  // 時間入力欄にイベントリスナーを追加
  const timeInput = tr.querySelector('.time-input');
  if (timeInput) {
    timeInput.addEventListener('input', (e) => {
      if (e.target.value.trim()) {
        tr.className = '';
        e.target.placeholder = '';
      } else {
        tr.className = 'bg-amber-50';
        e.target.placeholder = '(サブタイトル)';
      }
    });
  }
}

// 行を削除
function deleteShikidaiRow(idx) {
  const timeTableBody = document.getElementById('shikidaiTimeTableBody');
  if (!timeTableBody) return;
  const rows = timeTableBody.querySelectorAll('tr');
  if (rows[idx]) {
    rows[idx].remove();
  }
}

// 行を上に移動
function moveShikidaiRowUp(row) {
  const prevRow = row.previousElementSibling;
  if (prevRow) {
    row.parentNode.insertBefore(row, prevRow);
  }
}

// 行を下に移動
function moveShikidaiRowDown(row) {
  const nextRow = row.nextElementSibling;
  if (nextRow) {
    row.parentNode.insertBefore(nextRow, row);
  }
}

// 式次第編集画面を開く
function openShikidaiEdit() {
  const prepMenuSection = document.getElementById('prepMenuSection');
  const shikidaiEditSection = document.getElementById('shikidaiEditSection');
  if (prepMenuSection) prepMenuSection.classList.add('hidden');
  if (shikidaiEditSection) shikidaiEditSection.classList.remove('hidden');

  // 埋め込みデータでフォームを描画
  if (typeof EMBEDDED_SHIKIDAI_DATA !== 'undefined') {
    renderShikidaiEditForm(EMBEDDED_SHIKIDAI_DATA);
  }
}

function setupShikidaiEvents() {
  const prepMenuSection = document.getElementById('prepMenuSection');
  const shikidaiEditSection = document.getElementById('shikidaiEditSection');

  // 式次第編集ボタン
  const btnShikidaiEdit = document.getElementById('btnShikidaiEdit');
  if (btnShikidaiEdit) {
    btnShikidaiEdit.addEventListener('click', openShikidaiEdit);
  }

  // 戻るボタン
  const shikidaiBackFromEdit = document.getElementById('shikidaiBackFromEdit');
  if (shikidaiBackFromEdit) {
    shikidaiBackFromEdit.addEventListener('click', () => {
      if (shikidaiEditSection) shikidaiEditSection.classList.add('hidden');
      if (prepMenuSection) prepMenuSection.classList.remove('hidden');
    });
  }

  // 行追加ボタン
  const addRowBtn = document.getElementById('shikidaiAddRowButton');
  if (addRowBtn) {
    addRowBtn.addEventListener('click', addShikidaiRow);
  }

  // 削除・移動ボタン（イベント委譲）
  const timeTableBody = document.getElementById('shikidaiTimeTableBody');
  if (timeTableBody) {
    timeTableBody.addEventListener('click', (e) => {
      const row = e.target.closest('tr');
      if (!row) return;

      if (e.target.classList.contains('shikidai-delete-row')) {
        row.remove();
      } else if (e.target.classList.contains('shikidai-move-up')) {
        moveShikidaiRowUp(row);
      } else if (e.target.classList.contains('shikidai-move-down')) {
        moveShikidaiRowDown(row);
      }
    });
  }

  // 保存ボタン
  const saveBtn = document.getElementById('shikidaiSaveButton');
  if (saveBtn) {
    saveBtn.addEventListener('click', saveShikidaiData);
  }

  // 式次第プレビューボタン
  const previewBtn = document.getElementById('btnShikidaiPreview');
  if (previewBtn) {
    previewBtn.addEventListener('click', openShikidaiPreview);
  }

  // 他会場日程を更新ボタン
  const updateVenueBtn = document.getElementById('btnUpdateOtherVenue');
  if (updateVenueBtn) {
    updateVenueBtn.addEventListener('click', updateOtherVenueSchedule);
  }

  // フォーム回答を同期ボタン
  const syncFormBtn = document.getElementById('btnSyncFormToOtherVenue');
  if (syncFormBtn) {
    syncFormBtn.addEventListener('click', syncFormToOtherVenue);
  }

  // プレビュー画面の戻るボタン
  const previewBackBtn = document.getElementById('shikidaiPreviewBack');
  if (previewBackBtn) {
    previewBackBtn.addEventListener('click', () => {
      const previewSection = document.getElementById('shikidaiPreviewSection');
      if (previewSection) previewSection.classList.add('hidden');
      if (prepMenuSection) prepMenuSection.classList.remove('hidden');
    });
  }

  // PDF保存ボタン
  const printBtn = document.getElementById('shikidaiPrintButton');
  if (printBtn) {
    printBtn.addEventListener('click', generateShikidaiPDF);
  }
}

// 式次第プレビューを開く
function openShikidaiPreview() {
  const prepMenuSection = document.getElementById('prepMenuSection');
  const previewSection = document.getElementById('shikidaiPreviewSection');
  const previewBtn = document.getElementById('btnShikidaiPreview');

  // 画面切り替え用の共通処理
  function showPreview(data) {
    if (previewBtn) {
      previewBtn.disabled = false;
      previewBtn.textContent = '式次第プレビュー';
    }
    if (prepMenuSection) prepMenuSection.classList.add('hidden');
    if (previewSection) previewSection.classList.remove('hidden');
    renderShikidaiPreview(data);
    setupRefreshButton();
  }

  if (previewBtn) {
    previewBtn.disabled = true;
    previewBtn.textContent = 'データ取得中...';
  }

  // GASからデータ取得を試みる
  google.script.run
    .withSuccessHandler((data) => {
      if (data && !data.error) {
        showPreview(data);
      } else {
        // エラーレスポンスの場合は埋め込みデータを使用
        console.log('GAS returned error, using embedded data:', data?.error);
        if (typeof EMBEDDED_SHIKIDAI_DATA !== 'undefined') {
          showPreview(EMBEDDED_SHIKIDAI_DATA);
        }
      }
    })
    .withFailureHandler((error) => {
      // GAS呼び出し失敗時は埋め込みデータをフォールバック
      console.log('GAS call failed, using embedded data:', error);
      if (typeof EMBEDDED_SHIKIDAI_DATA !== 'undefined') {
        showPreview(EMBEDDED_SHIKIDAI_DATA);
      } else {
        if (previewBtn) {
          previewBtn.disabled = false;
          previewBtn.textContent = '式次第プレビュー';
        }
        alert('データ取得に失敗しました');
      }
    })
    .getShikidaiData();
}

// 更新ボタンのイベント設定
function setupRefreshButton() {
  const refreshBtn = document.getElementById('shikidaiRefreshButton');
  if (refreshBtn) {
    // 既存のリスナーを削除して再設定（重複防止）
    refreshBtn.replaceWith(refreshBtn.cloneNode(true));
    const newRefreshBtn = document.getElementById('shikidaiRefreshButton');

    newRefreshBtn.addEventListener('click', () => {
      newRefreshBtn.disabled = true;
      newRefreshBtn.textContent = '更新中...';

      google.script.run
        .withSuccessHandler((data) => {
          newRefreshBtn.disabled = false;
          newRefreshBtn.textContent = '🔄 更新';
          if (data && !data.error) {
            renderShikidaiPreview(data);
          } else {
            console.log('GAS returned error on refresh:', data?.error);
            alert('更新に失敗しました');
          }
        })
        .withFailureHandler((error) => {
          newRefreshBtn.disabled = false;
          newRefreshBtn.textContent = '🔄 更新';
          console.log('Refresh failed:', error);
          alert('更新に失敗しました');
        })
        .getShikidaiData();
    });
  }
}

// 式次第PDF生成（html2canvas + jsPDF直接制御・1ページ強制版）
async function generateShikidaiPDF() {
  const content = document.getElementById('shikidaiA4Content');

  if (!content) {
    alert('式次第が表示されていません。プレビューを開いてください。');
    return;
  }

  const btn = document.getElementById('shikidaiPrintButton');
  const originalText = btn ? btn.textContent : '';
  if (btn) {
    btn.textContent = '生成中...';
    btn.disabled = true;
  }

  // A4固定サイズ（px @ 96dpi）
  const A4_WIDTH = 794;
  const A4_HEIGHT = 1123;

  let clone = null;

  try {
    const eventName = dashboardData?.eventName || '例会';
    const fileName = `${eventName}_式次第.pdf`;

    // 1. フォント読み込み待機 + 50ms追加待機
    if (document.fonts && document.fonts.ready) {
      await document.fonts.ready;
      console.log('[PDF] フォント読み込み完了');
    }
    await new Promise(r => setTimeout(r, 50));

    // 2. クローン作成
    clone = content.cloneNode(true);

    // 3. ID衝突対策：clone配下の全IDを削除
    clone.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));

    // 3.5. 担当者セルに折り返し禁止スタイルを直接適用（html2canvas対策）
    clone.querySelectorAll('.tt-person').forEach(el => {
      el.style.whiteSpace = 'nowrap';
      el.style.width = '200px';
      el.style.minWidth = '200px';
    });

    // 4. クローンのスタイル設定（画面外配置）
    clone.style.cssText = `
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: ${A4_WIDTH}px;
      height: ${A4_HEIGHT}px;
      max-height: ${A4_HEIGHT}px;
      overflow: hidden;
      margin: 0;
      padding: 30px 90px;
      box-sizing: border-box;
      background: #ffffff;
      transform: none;
      font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      font-size: 12px;
      line-height: 1.3;
    `;
    document.body.appendChild(clone);

    // 5. リフロー待ち（2フレーム）
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

    // 6. デバッグログ（サイズ確認）
    const rect = clone.getBoundingClientRect();
    const scrollH = clone.scrollHeight;
    console.log('[PDF] クローンサイズ:', {
      rectWidth: rect.width,
      rectHeight: rect.height,
      scrollHeight: scrollH,
      status: scrollH > A4_HEIGHT ? '⚠️ 高さ超過!' : '✓ OK'
    });

    // 7. html2canvasで固定サイズキャプチャ
    const canvas = await html2canvas(clone, {
      useCORS: true,
      allowTaint: false,
      backgroundColor: '#ffffff',
      width: A4_WIDTH,
      height: A4_HEIGHT,
      windowWidth: A4_WIDTH,
      windowHeight: A4_HEIGHT,
      scrollX: 0,
      scrollY: 0,
      scale: 2,
      logging: false
    });

    console.log('[PDF] Canvas生成:', canvas.width, 'x', canvas.height);

    // 8. jsPDFで1ページに強制配置
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'px',
      format: [A4_WIDTH, A4_HEIGHT],
      hotfixes: ['px_scaling']
    });

    const imgData = canvas.toDataURL('image/jpeg', 0.95);
    pdf.addImage(imgData, 'JPEG', 0, 0, A4_WIDTH, A4_HEIGHT);

    // 9. ページ数チェック
    const pageCount = pdf.getNumberOfPages();
    console.log('[PDF] ページ数:', pageCount, pageCount === 1 ? '✓' : '⚠️');

    pdf.save(fileName);

    // クローン削除
    document.body.removeChild(clone);
    clone = null;

    console.log('[PDF] 生成完了:', fileName);

  } catch (e) {
    console.error('[PDF] 生成エラー:', e);
    alert('PDF生成に失敗しました: ' + e.message);
  } finally {
    // エラー時もクローン削除
    if (clone && clone.parentNode) {
      document.body.removeChild(clone);
    }
    if (btn) {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  }
}

// 他会場日程を更新
function updateOtherVenueSchedule() {
  const btn = document.getElementById('btnUpdateOtherVenue');
  if (btn) {
    btn.disabled = true;
    btn.textContent = '更新中...';
  }

  google.script.run
    .withSuccessHandler((result) => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = '他会場日程を更新';
      }
      if (result && result.success) {
        alert(`他会場日程を更新しました (${result.count}件)\n\nプレビューに反映するには、ページをリロードしてください。`);
        // 自動リロードは行わない（エラー回避）
      } else {
        alert('更新に失敗しました: ' + (result?.error || '不明なエラー'));
      }
    })
    .withFailureHandler((err) => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = '他会場日程を更新';
      }
      alert('エラーが発生しました: ' + err.message);
    })
    .updateOtherVenueSchedule();
}

// フォーム回答を他会場名簿マスターに同期
function syncFormToOtherVenue() {
  const btn = document.getElementById('btnSyncFormToOtherVenue');
  if (btn) {
    btn.disabled = true;
    btn.textContent = '同期中...';
  }

  google.script.run
    .withSuccessHandler((result) => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'フォーム回答を同期';
      }
      if (result && result.success) {
        let message = `同期完了\n\n追加: ${result.added}件\nスキップ（重複）: ${result.skipped}件`;
        if (result.errors && result.errors.length > 0) {
          message += `\n\nエラー:\n${result.errors.join('\n')}`;
        }
        alert(message);
        // 他会場タブのデータを更新するためリロード
        if (result.added > 0) {
          location.reload();
        }
      } else {
        alert('同期に失敗しました: ' + (result?.message || '不明なエラー'));
      }
    })
    .withFailureHandler((err) => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'フォーム回答を同期';
      }
      alert('エラーが発生しました: ' + err.message);
    })
    .syncFormResponsesToOtherVenueMaster();
}

// 式次第プレビュー描画（px単位・html2canvas対応版）
function renderShikidaiPreview(data) {
  const container = document.getElementById('shikidaiPreviewContent');
  if (!container) return;

  // meetingCount（計算値）を優先、なければmeetingNo（手動設定）を使用
  const meetingNo = data.meetingCount || data.meetingNo || '';
  const meetingTitle = `守成クラブ福岡飯塚　第${meetingNo}回 仕事バンバンプラザ 例会　式次第`;
  const timeTable = data.timeTable || [];
  const notices = data.notices || {};
  const otherVenueSchedule = data.otherVenueSchedule || [];

  // 来月の例会日
  let nextEventDateStr = data.nextEventDateStr || '';
  if (!nextEventDateStr && data.nextEventDate) {
    const d = new Date(data.nextEventDate);
    const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
    nextEventDateStr = `${d.getMonth() + 1}/${d.getDate()}（${weekdays[d.getDay()]}）`;
  }
  const nextMeetingText = nextEventDateStr
    ? `◎ 来月の例会は${nextEventDateStr}　　原則　第二水曜日開催です！！`
    : (notices['来月案内'] || '');

  // 司会担当者
  let mcPersonText = '';
  if (data.mcPersons && (data.mcPersons[0] || data.mcPersons[1])) {
    mcPersonText = data.mcPersons.filter(p => p).join('・');
  } else {
    mcPersonText = timeTable.find(r => r.item && r.item.includes('開会宣言'))?.person || '';
  }

  // 会場名を4件ごとに改行する関数
  function formatVenuesWithBreak(venuesStr) {
    if (!venuesStr) return '';
    const parts = venuesStr.split(/\s*[\/／]\s*/);
    const chunks = [];
    for (let i = 0; i < parts.length; i += 4) {
      chunks.push(parts.slice(i, i + 4).map(v => escapeHtml(v)).join(' / '));
    }
    return chunks.join('<br>');
  }

  // 他会場スケジュールHTML（2列テーブル）
  let venuesHtml = '';
  const totalVenues = otherVenueSchedule.length;
  const halfCount = Math.ceil(totalVenues / 2);

  for (let i = 0; i < halfCount; i++) {
    const left = otherVenueSchedule[i];
    const right = otherVenueSchedule[i + halfCount];
    venuesHtml += '<tr>';
    if (left) {
      venuesHtml += `<td class="venue-date">${escapeHtml(left.date || '')}</td>`;
      venuesHtml += `<td class="venue-name">${formatVenuesWithBreak(left.venues)}</td>`;
    } else {
      venuesHtml += '<td></td><td></td>';
    }
    if (right) {
      venuesHtml += `<td class="venue-date">${escapeHtml(right.date || '')}</td>`;
      venuesHtml += `<td class="venue-name">${formatVenuesWithBreak(right.venues)}</td>`;
    } else {
      venuesHtml += '<td></td><td></td>';
    }
    venuesHtml += '</tr>';
  }

  // タイムテーブルHTML（3列テーブル）
  let timetableHtml = '';
  timeTable.forEach(row => {
    const time = row.time || '';
    const item = row.item || '';
    const person = row.person || '';
    const note = row.note || '';

    if (time) {
      // メイン行（時間あり）
      let personNote = person;
      if (note) personNote += `（${note}）`;
      timetableHtml += `<tr>
        <td class="tt-time">${escapeHtml(time)}</td>
        <td class="tt-item">★${escapeHtml(item)}</td>
        <td class="tt-person">${escapeHtml(personNote)}</td>
      </tr>`;
    } else if (item) {
      // サブ行（時間なし、補足説明）
      timetableHtml += `<tr>
        <td></td>
        <td colspan="2" class="tt-sub">（${escapeHtml(item)}）</td>
      </tr>`;
    }
  });

  // A4固定レイアウト（794px x 1123px）- 上下2ブロック構造
  const html = `
    <div id="shikidaiA4Content" class="shikidai-page">
      <!-- 上部ブロック -->
      <div class="shikidai-top">
        <!-- 1. タイトル -->
        <div class="shikidai-title">${escapeHtml(meetingTitle)}</div>

        <!-- 2. サブタイトル（来月例会案内） -->
        <div class="shikidai-subtitle">${escapeHtml(nextMeetingText)}</div>

        <!-- 3. 他会場日程（2列テーブル） -->
        <table class="shikidai-venues">
          <tbody>${venuesHtml}</tbody>
        </table>

        <!-- 4. 注意事項（中央揃え） -->
        <div class="shikidai-notices">
          <p class="notice-red">${escapeHtml(notices['キャンセル'] || '')}</p>
          <p class="notice-blue">${escapeHtml(notices['設営案内'] || '').replace(/中心で(おこなって|行って)(います|ます)。/g, '中心で行ってます。<br>')}</p>
          <p>${escapeHtml(notices['ゲスト連絡先'] || '').replace(/フォームよりお願いします。/g, 'フォームよりお願いします。<br>')}</p>
          <p>${escapeHtml(notices['他会場連絡先'] || '')}</p>
        </div>
      </div>

      <!-- 下部ブロック -->
      <div class="shikidai-bottom">
        <!-- 5. 司会進行ヘッダー -->
        <div class="shikidai-mc">＜ 司会進行 ＞　${escapeHtml(mcPersonText)}</div>

        <!-- 6. タイムテーブル（3列テーブル） -->
        <table class="shikidai-timetable">
          <tbody>${timetableHtml}</tbody>
        </table>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

// フォームからデータを収集
function collectShikidaiFormData() {
  const timeTableBody = document.getElementById('shikidaiTimeTableBody');
  const noticesBody = document.getElementById('shikidaiNoticesBody');

  const timeTable = [];
  const notices = {};

  // タイムテーブル収集
  if (timeTableBody) {
    const rows = timeTableBody.querySelectorAll('tr');
    rows.forEach(row => {
      const inputs = row.querySelectorAll('input');
      if (inputs.length >= 4) {
        timeTable.push({
          time: inputs[0].value.trim(),
          item: inputs[1].value.trim(),
          person: inputs[2].value.trim(),
          note: inputs[3].value.trim()
        });
      }
    });
  }

  // お知らせ収集
  if (noticesBody) {
    const rows = noticesBody.querySelectorAll('tr');
    rows.forEach(row => {
      const keyInput = row.querySelector('input[data-notice-key]');
      const valueTextarea = row.querySelector('textarea[data-notice-value]');
      if (keyInput && valueTextarea) {
        const key = keyInput.dataset.noticeKey;
        notices[key] = valueTextarea.value.trim();
      }
    });
  }

  // 司会進行収集
  const mcPerson1 = document.getElementById('mcPerson1');
  const mcPerson2 = document.getElementById('mcPerson2');
  const mcPersons = [
    mcPerson1 ? mcPerson1.value.trim() : '',
    mcPerson2 ? mcPerson2.value.trim() : ''
  ];

  return { timeTable, notices, mcPersons };
}

// 保存処理
function saveShikidaiData() {
  const saveBtn = document.getElementById('shikidaiSaveButton');
  const originalText = saveBtn ? saveBtn.textContent : '';

  // ボタンを無効化してローディング表示
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = '保存中...';
  }

  const data = collectShikidaiFormData();
  console.log('Saving shikidai data:', data);

  google.script.run
    .withSuccessHandler((result) => {
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      }

      if (result && result.success) {
        alert('保存しました');
      } else {
        alert('保存に失敗しました: ' + (result?.error || '不明なエラー'));
      }
    })
    .withFailureHandler((err) => {
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      }
      console.error('Save failed:', err);
      alert('保存に失敗しました: ' + err);
    })
    .saveTimeTableData(data);
}

console.log('=== SCRIPT END ===');

// =========================================================
// 個別売上機能（パスワード保護）
// =========================================================
let individualSalesPassword = '';

function openIndividualSalesModal() {
  document.getElementById('salesPasswordModal').classList.remove('hidden');
  document.getElementById('salesPasswordInput').value = '';
  document.getElementById('salesPasswordError').textContent = '';
  document.getElementById('salesPasswordInput').focus();
}

function closeSalesPasswordModal() {
  document.getElementById('salesPasswordModal').classList.add('hidden');
}

// ★例会アンケート送信管理モーダル
let surveyData = null;
let surveyCustomMessage = '';

function openSurveyModal() {
  document.getElementById('surveyModal').classList.remove('hidden');
  loadSurveyParticipants();
}

function closeSurveyModal() {
  document.getElementById('surveyModal').classList.add('hidden');
  surveyData = null;
  surveyCustomMessage = '';
}

// アンケート送信対象者を読み込む
function loadSurveyParticipants() {
  const eventInfoEl = document.getElementById('surveyEventInfo');
  const participantsListEl = document.getElementById('surveyParticipantsList');
  const noLineMembersEl = document.getElementById('surveyNoLineMembers');
  const messagePreviewEl = document.getElementById('surveyMessagePreview');
  const resultEl = document.getElementById('surveyResult');
  const targetCountEl = document.getElementById('surveyTargetCount');

  // ローディング表示
  if (eventInfoEl) eventInfoEl.innerHTML = '<p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>';
  if (participantsListEl) participantsListEl.innerHTML = '<p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>';
  if (noLineMembersEl) noLineMembersEl.innerHTML = '<p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>';
  if (messagePreviewEl) messagePreviewEl.textContent = '読み込み中...';
  if (resultEl) resultEl.innerHTML = '';

  // 現在のeventKeyを取得（dashboardDataから）
  const eventKey = getCurrentEventKeyForSurvey();

  // GAS APIを呼び出し
  google.script.run
    .withSuccessHandler(data => {
    if (!data.success) {
      if (eventInfoEl) eventInfoEl.innerHTML = `<p class="text-red-500 text-center py-2 text-sm">${data.message || 'エラーが発生しました'}</p>`;
      if (participantsListEl) participantsListEl.innerHTML = '<p class="text-red-500 text-center py-2 text-sm">取得失敗</p>';
      if (noLineMembersEl) noLineMembersEl.innerHTML = '<p class="text-red-500 text-center py-2 text-sm">取得失敗</p>';
      return;
    }

    surveyData = data;

    // イベント情報
    if (eventInfoEl) {
      eventInfoEl.innerHTML = `
        <div class="text-center">
          <p class="text-lg font-bold text-purple-700">${data.eventInfo.eventKeyJp}</p>
          <p class="text-sm text-purple-600 mt-1">
            参加総数: <span class="font-semibold">${data.eventInfo.totalParticipants}</span>名
            (自会場会員: <span class="font-semibold">${data.eventInfo.memberCount}</span>名)
          </p>
        </div>
      `;
    }

    // 参加者リスト（チェックボックス付き）
    if (participantsListEl && data.participants) {
      if (data.participants.length === 0) {
        participantsListEl.innerHTML = '<p class="text-slate-500 text-center py-2 text-sm">送信対象者がいません</p>';
      } else {
        participantsListEl.innerHTML = data.participants.map((p, idx) => `
          <label class="flex items-center gap-2 py-1 px-2 hover:bg-slate-100 rounded cursor-pointer">
            <input type="checkbox" name="surveyParticipant" value="${p.userId}" data-name="${p.name}" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500" onchange="updateSurveySelectedCount()">
            <span class="text-sm text-slate-700">${p.name}</span>
            <span class="text-xs text-slate-400 ml-auto">${p.team || ''}</span>
          </label>
        `).join('');
      }
      if (targetCountEl) targetCountEl.textContent = `(${data.participants.length}名)`;
    }

    // 全員選択チェックボックスを初期化
    document.getElementById('surveySelectAll').checked = false;
    updateSurveySelectedCount();

    // LINE未登録者
    if (noLineMembersEl && data.noLineIdMembers) {
      if (data.noLineIdMembers.length === 0) {
        noLineMembersEl.innerHTML = '<p class="text-emerald-600 text-center py-2 text-sm">全員がLINE連携済みです</p>';
      } else {
        noLineMembersEl.innerHTML = `
          <p class="text-sm text-amber-700 mb-2">${data.noLineIdMembers.length}名がLINE未登録です（手動連絡が必要）:</p>
          <div class="flex flex-wrap gap-1">
            ${data.noLineIdMembers.map(m => `<span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded">${m.name}</span>`).join('')}
          </div>
        `;
      }
    }

    // デフォルトメッセージをプレビューに表示
    const defaultMessage = buildSurveyDefaultMessage(data.eventInfo.eventKeyJp);
    if (messagePreviewEl) messagePreviewEl.textContent = defaultMessage;
    surveyCustomMessage = '';
    document.getElementById('surveyMessageTextarea').value = defaultMessage;
  })
  .withFailureHandler(err => {
    console.error('loadSurveyParticipants error:', err);
    if (eventInfoEl) eventInfoEl.innerHTML = '<p class="text-red-500 text-center py-2 text-sm">通信エラーが発生しました</p>';
  })
  .getSurveyParticipants(eventKey);
}

// 現在のeventKeyを取得
function getCurrentEventKeyForSurvey() {
  // dashboardDataがあればそこから取得
  if (window.dashboardData && window.dashboardData.eventKey) {
    return window.dashboardData.eventKey;
  }
  // なければ設定シートの現在イベントキーを使用（フォールバック）
  return '';
}

// デフォルトメッセージを生成
function buildSurveyDefaultMessage(eventKeyJp) {
  const encodedKey = encodeURIComponent(eventKeyJp);
  const surveyUrl = 'https://shusei-survey.pages.dev/?key=' + encodedKey;

  return '【例会アンケートのお願い】\n\n' +
    '本日は例会にご参加いただき、ありがとうございました。\n\n' +
    '今後のより良い運営のため、簡単なアンケートにご協力をお願いいたします。\n' +
    '（所要時間：約1分）\n\n' +
    '▼ アンケートはこちら\n' +
    surveyUrl + '\n\n' +
    '※ 回答は匿名で収集されます\n\n' +
    '守成クラブ福岡飯塚';
}

// 全員選択トグル
function toggleSurveySelectAll() {
  const selectAll = document.getElementById('surveySelectAll').checked;
  const checkboxes = document.querySelectorAll('input[name="surveyParticipant"]');
  checkboxes.forEach(cb => cb.checked = selectAll);
  updateSurveySelectedCount();
}

// 選択人数を更新
function updateSurveySelectedCount() {
  const checkboxes = document.querySelectorAll('input[name="surveyParticipant"]:checked');
  document.getElementById('surveySelectedCount').textContent = `選択: ${checkboxes.length}名`;

  // 全選択チェックボックスの状態を更新
  const allCheckboxes = document.querySelectorAll('input[name="surveyParticipant"]');
  const selectAllCb = document.getElementById('surveySelectAll');
  if (allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length) {
    selectAllCb.checked = true;
    selectAllCb.indeterminate = false;
  } else if (checkboxes.length > 0) {
    selectAllCb.checked = false;
    selectAllCb.indeterminate = true;
  } else {
    selectAllCb.checked = false;
    selectAllCb.indeterminate = false;
  }
}

// メッセージ編集トグル
function toggleSurveyMessageEdit() {
  const previewContainer = document.getElementById('surveyMessagePreviewContainer');
  const editContainer = document.getElementById('surveyMessageEditContainer');
  const toggleBtn = document.getElementById('surveyMessageEditToggle');

  if (editContainer.classList.contains('hidden')) {
    // 編集モードに切り替え
    editContainer.classList.remove('hidden');
    previewContainer.classList.add('hidden');
    toggleBtn.innerHTML = '<span class="material-icons text-sm">visibility</span> プレビュー';
  } else {
    // プレビューモードに切り替え
    editContainer.classList.add('hidden');
    previewContainer.classList.remove('hidden');
    toggleBtn.innerHTML = '<span class="material-icons text-sm">edit</span> 編集';
  }
}

// メッセージを適用
function applySurveyMessage() {
  const textarea = document.getElementById('surveyMessageTextarea');
  const previewEl = document.getElementById('surveyMessagePreview');

  surveyCustomMessage = textarea.value;

  // {SURVEY_URL}を実際のURLに置換してプレビュー
  if (surveyData && surveyData.eventInfo) {
    const encodedKey = encodeURIComponent(surveyData.eventInfo.eventKeyJp);
    const surveyUrl = 'https://shusei-survey.pages.dev/?key=' + encodedKey;
    const previewText = surveyCustomMessage.replace(/\{SURVEY_URL\}/g, surveyUrl);
    previewEl.textContent = previewText;
  } else {
    previewEl.textContent = surveyCustomMessage;
  }

  // プレビューモードに戻る
  toggleSurveyMessageEdit();
}

// デフォルトメッセージに戻す
function resetSurveyMessageToDefault() {
  if (!surveyData || !surveyData.eventInfo) {
    alert('イベント情報が読み込まれていません');
    return;
  }

  const defaultMessage = buildSurveyDefaultMessage(surveyData.eventInfo.eventKeyJp);
  document.getElementById('surveyMessageTextarea').value = defaultMessage;
  document.getElementById('surveyMessagePreview').textContent = defaultMessage;
  surveyCustomMessage = '';
}

// テスト実行（ドライラン）
function executeSurveyDryRun() {
  const selectedUserIds = getSelectedSurveyUserIds();
  const resultEl = document.getElementById('surveyResult');

  if (selectedUserIds.length === 0) {
    resultEl.innerHTML = '<div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-amber-700 text-sm">送信対象者を選択してください</div>';
    return;
  }

  resultEl.innerHTML = '<div class="text-slate-400 text-center py-2 text-sm">テスト実行中...</div>';

  const eventKey = getCurrentEventKeyForSurvey();

  google.script.run
    .withSuccessHandler(data => {
      if (!data.success) {
        resultEl.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-700 text-sm">${data.message || 'エラーが発生しました'}</div>`;
        return;
      }

      // テスト結果を表示
      const targetNames = data.targets ? data.targets.map(t => t.name).join('、') : '';
      resultEl.innerHTML = `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <p class="text-blue-700 font-semibold text-sm mb-2">テスト実行結果</p>
          <p class="text-blue-600 text-sm">送信対象: <span class="font-bold">${data.targetCount}</span>名</p>
          <p class="text-xs text-blue-500 mt-1">${targetNames}</p>
          ${data.noLineIdCount > 0 ? `<p class="text-amber-600 text-xs mt-2">※ LINE未登録: ${data.noLineIdCount}名</p>` : ''}
        </div>
      `;
    })
    .withFailureHandler(err => {
      console.error('executeSurveyDryRun error:', err);
      resultEl.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-700 text-sm">通信エラーが発生しました</div>';
    })
    .sendSurveyManual(eventKey, selectedUserIds, surveyCustomMessage, true);
}

// 本番送信
function executeSurveySend() {
  const selectedUserIds = getSelectedSurveyUserIds();
  const resultEl = document.getElementById('surveyResult');

  if (selectedUserIds.length === 0) {
    resultEl.innerHTML = '<div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-amber-700 text-sm">送信対象者を選択してください</div>';
    return;
  }

  // 確認ダイアログ
  const selectedNames = getSelectedSurveyNames();
  if (!confirm(`以下の ${selectedUserIds.length}名 にアンケートを送信します。\n\n${selectedNames.join('、')}\n\n送信してよろしいですか？`)) {
    return;
  }

  resultEl.innerHTML = '<div class="text-slate-400 text-center py-2 text-sm">送信中...</div>';

  const eventKey = getCurrentEventKeyForSurvey();

  google.script.run
    .withSuccessHandler(data => {
      if (!data.success) {
        resultEl.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-700 text-sm">${data.message || 'エラーが発生しました'}</div>`;
        return;
      }

      // 送信結果を表示
      let resultHtml = `
        <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
          <p class="text-emerald-700 font-semibold text-sm mb-2">送信完了</p>
          <p class="text-emerald-600 text-sm">成功: <span class="font-bold">${data.sent}</span>件</p>
      `;

      if (data.failed > 0) {
        resultHtml += `
          <p class="text-red-600 text-sm">失敗: <span class="font-bold">${data.failed}</span>件</p>
          <p class="text-xs text-red-500 mt-1">${data.errors ? data.errors.map(e => e.name).join('、') : ''}</p>
        `;
      }

      resultHtml += '</div>';
      resultEl.innerHTML = resultHtml;

      // チェックボックスをリセット
      const checkboxes = document.querySelectorAll('input[name="surveyParticipant"]');
      checkboxes.forEach(cb => cb.checked = false);
      document.getElementById('surveySelectAll').checked = false;
      updateSurveySelectedCount();
    })
    .withFailureHandler(err => {
      console.error('executeSurveySend error:', err);
      resultEl.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-700 text-sm">通信エラーが発生しました</div>';
    })
    .sendSurveyManual(eventKey, selectedUserIds, surveyCustomMessage, false);
}

// 選択されたuserIdを取得
function getSelectedSurveyUserIds() {
  const checkboxes = document.querySelectorAll('input[name="surveyParticipant"]:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

// 選択された名前を取得
function getSelectedSurveyNames() {
  const checkboxes = document.querySelectorAll('input[name="surveyParticipant"]:checked');
  return Array.from(checkboxes).map(cb => cb.dataset.name);
}

// ★出欠リマインド管理モーダル（自動送信設定UI）
let reminderData = null;

function openReminderModal() {
  document.getElementById('reminderModal').classList.remove('hidden');
  loadReminderStatusFromAPI();
}

function closeReminderModal() {
  document.getElementById('reminderModal').classList.add('hidden');
  reminderData = null;
}

// リマインド状態を読み込む
function loadReminderStatusFromAPI() {
  const nextScheduleEl = document.getElementById('reminderNextSchedule');
  const messagePreviewEl = document.getElementById('reminderMessagePreview');
  const triggerStatusEl = document.getElementById('reminderTriggerStatus');
  const noLineMembersEl = document.getElementById('reminderNoLineMembers');
  const resultEl = document.getElementById('reminderResult');

  // ローディング表示
  if (nextScheduleEl) nextScheduleEl.innerHTML = '<p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>';
  if (messagePreviewEl) messagePreviewEl.textContent = '読み込み中...';
  if (triggerStatusEl) triggerStatusEl.innerHTML = '<p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>';
  if (noLineMembersEl) noLineMembersEl.innerHTML = '<p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>';
  if (resultEl) resultEl.innerHTML = '';

  google.script.run
    .withSuccessHandler(data => {
      if (!data.success) {
        if (nextScheduleEl) nextScheduleEl.innerHTML = `<p class="text-red-500 text-center py-2 text-sm">${data.message || 'エラーが発生しました'}</p>`;
        if (triggerStatusEl) triggerStatusEl.innerHTML = '<p class="text-red-500 text-center py-2 text-sm">取得失敗</p>';
        if (noLineMembersEl) noLineMembersEl.innerHTML = '<p class="text-red-500 text-center py-2 text-sm">取得失敗</p>';
        return;
      }

      reminderData = data;
      const currentYear = new Date().getFullYear();

      // 次回送信予定
      if (data.nextTrigger && data.count > 0) {
        nextScheduleEl.innerHTML = `
          <div class="text-center">
            <p class="text-lg font-bold text-blue-700">${data.nextTrigger.formatted}</p>
            <p class="text-sm text-blue-600 mt-1">対象: 未回答者 <span class="font-semibold">${data.unrespondedCount}</span>名</p>
          </div>
        `;
      } else {
        nextScheduleEl.innerHTML = `
          <div class="text-center py-2">
            <p class="text-slate-500 text-sm">自動送信が設定されていません</p>
            <p class="text-xs text-slate-400 mt-1">下の「${currentYear}年設定」ボタンで有効にできます</p>
          </div>
        `;
      }

      // 自動送信設定状態
      if (data.count > 0) {
        triggerStatusEl.innerHTML = `
          <div class="flex flex-col gap-3">
            <div class="flex items-center justify-center">
              <span class="inline-flex items-center gap-1 text-emerald-600 font-semibold text-sm">
                <span class="material-icons text-base">check_circle</span>
                有効
              </span>
              <span class="text-slate-600 text-sm ml-2">（${data.count}件登録済）</span>
            </div>
            <div class="flex flex-wrap gap-2 justify-center">
              <button onclick="setupReminderTriggersForYear(${currentYear + 1})" class="px-3 py-1.5 bg-slate-600 hover:bg-slate-700 text-white text-xs font-medium rounded-lg transition flex items-center gap-1">
                <span class="material-icons text-sm">calendar_month</span>
                ${currentYear + 1}年設定
              </button>
            </div>
          </div>
        `;
      } else {
        triggerStatusEl.innerHTML = `
          <div class="flex flex-col gap-3">
            <div class="flex items-center justify-center">
              <span class="inline-flex items-center gap-1 text-slate-500 text-sm">
                <span class="material-icons text-base">cancel</span>
                無効（トリガー未設定）
              </span>
            </div>
            <div class="flex flex-wrap gap-2 justify-center">
              <button onclick="setupReminderTriggersForYear(${currentYear})" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition flex items-center gap-1">
                <span class="material-icons text-base">add</span>
                ${currentYear}年設定
              </button>
            </div>
          </div>
        `;
      }

      // LINE未登録者
      if (data.noLineIdCount > 0) {
        noLineMembersEl.innerHTML = `
          <p class="text-amber-700 text-sm mb-2">${data.noLineIdCount}名: ${data.noLineIdNames.join('、')}</p>
          <p class="text-xs text-amber-600">※ これらの方には電話等で手動連絡が必要です</p>
        `;
      } else {
        noLineMembersEl.innerHTML = '<p class="text-emerald-600 text-sm text-center">全員LINE登録済みです</p>';
      }
      // メッセージプレビューを表示（次回送信に対応する日付を使用）
      if (data.nextTrigger) {
        // eventInfoを保存（プレビュー更新用）
        reminderData.eventInfo = {
          eventDate: data.nextTrigger.eventDate || '未設定',
          deadline: data.nextTrigger.deadline || '未設定'
        };

        // テンプレートを取得してプレビュー表示
        google.script.run
          .withSuccessHandler(templateData => {
            if (templateData.success && messagePreviewEl) {
              const message = templateData.template
                .replace(/\{\{eventDate\}\}/g, data.nextTrigger.eventDate || '未設定')
                .replace(/\{\{deadline\}\}/g, data.nextTrigger.deadline || '未設定');
              messagePreviewEl.textContent = message;
            } else if (messagePreviewEl) {
              messagePreviewEl.textContent = 'テンプレートを取得できませんでした';
            }
          })
          .withFailureHandler(err => {
            if (messagePreviewEl) messagePreviewEl.textContent = 'テンプレートを取得できませんでした';
          })
          .getReminderMessageTemplate();
      } else if (messagePreviewEl) {
        messagePreviewEl.textContent = '次回送信予定がありません';
      }
    })
    .withFailureHandler(err => {
      console.error('loadReminderStatusFromAPI error:', err);
      if (nextScheduleEl) nextScheduleEl.innerHTML = '<p class="text-red-500 text-center py-2 text-sm">データ取得に失敗しました</p>';
      if (triggerStatusEl) triggerStatusEl.innerHTML = '<p class="text-red-500 text-center py-2 text-sm">取得失敗</p>';
      if (noLineMembersEl) noLineMembersEl.innerHTML = '<p class="text-red-500 text-center py-2 text-sm">取得失敗</p>';
    })
    .getReminderTriggerStatus();
}

// デフォルトのリマインドメッセージを生成
function generateDefaultReminderMessage(eventDate, deadline) {
  return `【出欠回答のお願い】

いつもお世話になっております。
守成クラブ福岡飯塚 事務局です。

※本メッセージと行き違いで
　すでにご回答済みの場合は
　何卒ご容赦ください。

次回例会の出欠につきまして、
まだご回答をいただいておりません。

━━━━━━━━━━━━━━━━━━
■ 例会日程
　${eventDate || '未設定'}

■ 回答期限
　${deadline || '未設定'}

■ ご注意
　期限を過ぎますと
　自動的に「出席」扱いとなります。

　その後のキャンセルには
　キャンセル料 4,000円が発生いたします。
━━━━━━━━━━━━━━━━━━

画面下部のリッチメニューより
「例会出欠」ボタンを押して
ご回答をお願いいたします。

よろしくお願いいたします。`;
}

// トリガーを設定（指定年）
function setupReminderTriggersForYear(year) {
  if (!confirm(`${year}年の月末日に自動送信トリガーを設定します。\n\n既存のトリガーは削除されます。\n続行しますか？`)) {
    return;
  }

  const resultEl = document.getElementById('reminderResult');
  const triggerStatusEl = document.getElementById('reminderTriggerStatus');

  resultEl.innerHTML = '<p class="text-slate-500 text-sm">トリガーを設定中...</p>';
  triggerStatusEl.innerHTML = '<p class="text-slate-400 text-center py-2 text-sm">設定中...</p>';

  google.script.run
    .withSuccessHandler(data => {
      if (data.success) {
        resultEl.innerHTML = `
          <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-3 mt-2">
            <p class="text-emerald-700 font-semibold text-sm flex items-center gap-1">
              <span class="material-icons text-base">check_circle</span>
              設定完了
            </p>
            <p class="text-xs text-emerald-600 mt-1">${data.message}</p>
            ${data.dates && data.dates.length > 0 ? `<p class="text-xs text-slate-500 mt-1">作成日: ${data.dates.join(', ')}</p>` : ''}
          </div>
        `;
        // 状態を再読み込み
        setTimeout(() => loadReminderStatusFromAPI(), 500);
      } else {
        resultEl.innerHTML = `<p class="text-red-500 text-sm">エラー: ${data.message || '不明なエラー'}</p>`;
        loadReminderStatusFromAPI();
      }
    })
    .withFailureHandler(err => {
      resultEl.innerHTML = `<p class="text-red-500 text-sm">エラー: ${err}</p>`;
      loadReminderStatusFromAPI();
    })
    .setupReminderTriggers(year);
}

// トリガーを全削除
function clearAllReminderTriggers() {
  if (!confirm('自動送信トリガーをすべて削除します。\n\n削除後は手動で再設定が必要です。\n続行しますか？')) {
    return;
  }

  const resultEl = document.getElementById('reminderResult');
  const triggerStatusEl = document.getElementById('reminderTriggerStatus');

  resultEl.innerHTML = '<p class="text-slate-500 text-sm">トリガーを削除中...</p>';
  triggerStatusEl.innerHTML = '<p class="text-slate-400 text-center py-2 text-sm">削除中...</p>';

  google.script.run
    .withSuccessHandler(data => {
      if (data.success) {
        resultEl.innerHTML = `
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-2">
            <p class="text-blue-700 font-semibold text-sm flex items-center gap-1">
              <span class="material-icons text-base">info</span>
              削除完了
            </p>
            <p class="text-xs text-blue-600 mt-1">${data.message}</p>
          </div>
        `;
        // 状態を再読み込み
        setTimeout(() => loadReminderStatusFromAPI(), 500);
      } else {
        resultEl.innerHTML = `<p class="text-red-500 text-sm">エラー: ${data.message || '不明なエラー'}</p>`;
        loadReminderStatusFromAPI();
      }
    })
    .withFailureHandler(err => {
      resultEl.innerHTML = `<p class="text-red-500 text-sm">エラー: ${err}</p>`;
      loadReminderStatusFromAPI();
    })
    .clearReminderTriggers();
}

// メッセージ編集モード切り替え
let isMessageEditMode = false;
let currentMessageTemplate = '';

function toggleMessageEdit() {
  const previewContainer = document.getElementById('reminderMessagePreviewContainer');
  const editContainer = document.getElementById('reminderMessageEditContainer');
  const toggleBtn = document.getElementById('messageEditToggle');
  const textarea = document.getElementById('reminderMessageTextarea');

  isMessageEditMode = !isMessageEditMode;

  if (isMessageEditMode) {
    // 編集モードに切り替え
    previewContainer.classList.add('hidden');
    editContainer.classList.remove('hidden');
    toggleBtn.innerHTML = '<span class="material-icons text-sm">visibility</span> プレビュー';

    // テンプレートを取得してテキストエリアに設定
    google.script.run
      .withSuccessHandler(data => {
        if (data.success) {
          currentMessageTemplate = data.template;
          textarea.value = data.template;
        }
      })
      .getReminderMessageTemplate();
  } else {
    // プレビューモードに切り替え
    previewContainer.classList.remove('hidden');
    editContainer.classList.add('hidden');
    toggleBtn.innerHTML = '<span class="material-icons text-sm">edit</span> 編集';
  }
}

// メッセージを保存
function saveReminderMessage() {
  const textarea = document.getElementById('reminderMessageTextarea');
  const template = textarea.value.trim();
  const resultEl = document.getElementById('reminderResult');
  const saveBtn = document.getElementById('saveMessageBtn');

  if (!template) {
    alert('メッセージを入力してください');
    return;
  }

  saveBtn.disabled = true;
  saveBtn.innerHTML = '<span class="material-icons text-sm animate-spin">sync</span> 保存中...';

  google.script.run
    .withSuccessHandler(data => {
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<span class="material-icons text-sm">save</span> 保存';

      if (data.success) {
        resultEl.innerHTML = `
          <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-3 mt-2">
            <p class="text-emerald-700 font-semibold text-sm flex items-center gap-1">
              <span class="material-icons text-base">check_circle</span>
              ${data.message}
            </p>
          </div>
        `;
        // 編集モードを終了してプレビューに戻す
        isMessageEditMode = true; // toggleで反転されるのでtrueにしておく
        toggleMessageEdit();
        // 全データを再読み込みしてプレビューを更新
        setTimeout(() => loadReminderStatusFromAPI(), 300);
      } else {
        resultEl.innerHTML = `<p class="text-red-500 text-sm">エラー: ${data.message || '不明なエラー'}</p>`;
      }
    })
    .withFailureHandler(err => {
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<span class="material-icons text-sm">save</span> 保存';
      resultEl.innerHTML = `<p class="text-red-500 text-sm">エラー: ${err}</p>`;
    })
    .saveReminderMessageTemplate(template);
}

// メッセージをデフォルトにリセット
function resetReminderMessageToDefault() {
  if (!confirm('メッセージをデフォルトに戻しますか？\n\n編集した内容は失われます。')) {
    return;
  }

  const textarea = document.getElementById('reminderMessageTextarea');
  const resultEl = document.getElementById('reminderResult');

  google.script.run
    .withSuccessHandler(data => {
      if (data.success) {
        textarea.value = data.template;
        currentMessageTemplate = data.template;
        resultEl.innerHTML = `
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-2">
            <p class="text-blue-700 font-semibold text-sm flex items-center gap-1">
              <span class="material-icons text-base">info</span>
              ${data.message}
            </p>
          </div>
        `;
        // 編集モードを終了してプレビューに戻す
        isMessageEditMode = true;
        toggleMessageEdit();
        // 全データを再読み込みしてプレビューを更新
        setTimeout(() => loadReminderStatusFromAPI(), 300);
      } else {
        resultEl.innerHTML = `<p class="text-red-500 text-sm">エラー: ${data.message || '不明なエラー'}</p>`;
      }
    })
    .withFailureHandler(err => {
      resultEl.innerHTML = `<p class="text-red-500 text-sm">エラー: ${err}</p>`;
    })
    .resetReminderMessageTemplate();
}

// プレビューを更新（プレースホルダーを置換して表示）
function updateMessagePreview(template) {
  const previewEl = document.getElementById('reminderMessagePreview');
  if (previewEl && reminderData && reminderData.eventInfo) {
    const message = template
      .replace(/\{\{eventDate\}\}/g, reminderData.eventInfo.eventDate || '未設定')
      .replace(/\{\{deadline\}\}/g, reminderData.eventInfo.deadline || '未設定');
    previewEl.textContent = message;
  }
}

function verifySalesPassword() {
  const password = document.getElementById('salesPasswordInput').value;
  const errorEl = document.getElementById('salesPasswordError');
  const btn = document.getElementById('verifySalesPasswordBtn');

  if (!password) {
    errorEl.textContent = 'パスワードを入力してください';
    return;
  }

  btn.disabled = true;
  btn.textContent = '確認中...';

  google.script.run
    .withSuccessHandler(result => {
      btn.disabled = false;
      btn.textContent = '確認';

      if (result.success) {
        individualSalesPassword = password;
        closeSalesPasswordModal();
        showIndividualSalesView();
      } else {
        errorEl.textContent = result.message || 'パスワードが違います';
      }
    })
    .withFailureHandler(err => {
      btn.disabled = false;
      btn.textContent = '確認';
      errorEl.textContent = 'エラー: ' + err;
    })
    .verifySalesPassword(password);
}

function showIndividualSalesView() {
  // 売上タブの内容を個別売上ビューに切り替え
  document.getElementById('salesSummaryView').classList.add('hidden');
  document.getElementById('individualSalesView').classList.remove('hidden');

  // 月一覧を取得
  loadSalesMonthList();
}

function hideIndividualSalesView() {
  document.getElementById('individualSalesView').classList.add('hidden');
  document.getElementById('salesSummaryView').classList.remove('hidden');
  individualSalesPassword = '';
}

function loadSalesMonthList() {
  const select = document.getElementById('salesMonthSelect');
  select.innerHTML = '<option value="">読み込み中...</option>';

  google.script.run
    .withSuccessHandler(result => {
      if (result.success && result.months.length > 0) {
        // months: [{year, month, label, key}, ...]
        select.innerHTML = result.months.map(m =>
          `<option value="${m.key}">${m.label}</option>`
        ).join('');
        // 最新月を自動選択
        select.value = result.months[result.months.length - 1].key;
        loadIndividualSalesData();
      } else {
        select.innerHTML = '<option value="">データなし</option>';
      }
    })
    .withFailureHandler(err => {
      select.innerHTML = '<option value="">エラー</option>';
      console.error(err);
    })
    .getSalesMonthList();
}

function loadIndividualSalesData() {
  const month = document.getElementById('salesMonthSelect').value;
  if (!month) return;

  const container = document.getElementById('individualSalesData');
  container.innerHTML = '<div class="text-center py-8 text-slate-500">読み込み中...</div>';

  google.script.run
    .withSuccessHandler(result => {
      if (result.success) {
        renderIndividualSalesData(result);
      } else {
        container.innerHTML = `<div class="text-center py-8 text-red-500">${result.message || 'エラー'}</div>`;
      }
    })
    .withFailureHandler(err => {
      container.innerHTML = `<div class="text-center py-8 text-red-500">エラー: ${err}</div>`;
    })
    .getIndividualSales(month, individualSalesPassword);
}

function renderIndividualSalesData(result) {
  const container = document.getElementById('individualSalesData');
  const { data, summary, month } = result;

  if (!data || data.length === 0) {
    container.innerHTML = `<div class="text-center py-8 text-slate-500">${month}月のデータがありません</div>`;
    return;
  }

  // サマリー
  let html = `
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
      <div class="bg-blue-50 rounded-lg p-3 text-center">
        <div class="text-xs text-slate-500">報告者数</div>
        <div class="text-xl font-bold text-blue-600">${summary.reporterCount}人</div>
      </div>
      <div class="bg-blue-50 rounded-lg p-3 text-center">
        <div class="text-xs text-slate-500">商談件数</div>
        <div class="text-xl font-bold text-blue-600">${summary.meetingsCount}件</div>
      </div>
      <div class="bg-blue-50 rounded-lg p-3 text-center">
        <div class="text-xs text-slate-500">成約件数</div>
        <div class="text-xl font-bold text-blue-600">${summary.dealCount}件</div>
      </div>
      <div class="bg-green-50 rounded-lg p-3 text-center">
        <div class="text-xs text-slate-500">売上合計</div>
        <div class="text-xl font-bold text-green-600">${summary.total.toLocaleString()}円</div>
      </div>
    </div>
  `;

  // テーブル
  html += `
    <div class="overflow-x-auto">
      <table class="w-full text-xs md:text-sm border-collapse">
        <thead>
          <tr class="bg-slate-100">
            <th class="py-2 px-2 text-left border border-slate-200">#</th>
            <th class="py-2 px-2 text-left border border-slate-200">氏名</th>
            <th class="py-2 px-2 text-center border border-slate-200">商談</th>
            <th class="py-2 px-2 text-center border border-slate-200">成約</th>
            <th class="py-2 px-2 text-right border border-slate-200">売上金額</th>
          </tr>
        </thead>
        <tbody>
  `;

  data.forEach((row, idx) => {
    const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50';
    const amountClass = row.amount > 0 ? 'text-green-600 font-semibold' : 'text-slate-400';
    html += `
      <tr class="${bgClass}">
        <td class="py-2 px-2 border border-slate-200 text-slate-400">${idx + 1}</td>
        <td class="py-2 px-2 border border-slate-200">${row.name}</td>
        <td class="py-2 px-2 border border-slate-200 text-center">${row.meetings}</td>
        <td class="py-2 px-2 border border-slate-200 text-center">${row.deals}</td>
        <td class="py-2 px-2 border border-slate-200 text-right ${amountClass}">${row.amount.toLocaleString()}円</td>
      </tr>
    `;
  });

  html += '</tbody></table></div>';

  container.innerHTML = html;
}

/** =========================================================
 *  履歴タブ
 * ======================================================= */
let historyData = null;  // 参加者データを保持
let historyFilter = 'all';  // 現在のフィルタ

// 例会キー一覧を読み込み
function loadEventKeyList() {
  const select = document.getElementById('historyEventSelect');
  if (!select) return;

  select.innerHTML = '<option value="">読み込み中...</option>';

  google.script.run
    .withSuccessHandler(result => {
      if (result.success && result.eventKeys && result.eventKeys.length > 0) {
        // eventKeyを日本語ラベルに変換して表示
        select.innerHTML = result.eventKeys.map(key => {
          const label = formatEventKeyLabel(key);
          return `<option value="${key}">${label}</option>`;
        }).join('');
        // 最新を自動選択してデータ読み込み
        select.value = result.eventKeys[0];
        loadParticipantHistory();
      } else {
        select.innerHTML = '<option value="">データなし</option>';
      }
    })
    .withFailureHandler(err => {
      select.innerHTML = '<option value="">エラー</option>';
      console.error('getEventKeyList error:', err);
    })
    .getEventKeyList();
}

// eventKey "202601_01" → "2026年1月例会" に変換
function formatEventKeyLabel(eventKey) {
  const match = eventKey.match(/^(\d{4})(\d{2})_(\d{2})$/);
  if (match) {
    const year = parseInt(match[1], 10);
    const month = parseInt(match[2], 10);
    return `${year}年${month}月例会`;
  }
  return eventKey;
}

// 参加者履歴を読み込み
function loadParticipantHistory() {
  const eventKey = document.getElementById('historyEventSelect')?.value;
  if (!eventKey) return;

  const tbody = document.getElementById('historyTableBody');
  tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-slate-400">読み込み中...</td></tr>';

  // サマリーをリセット
  document.getElementById('historyTotal').textContent = '-';
  document.getElementById('historyMembers').textContent = '-';
  document.getElementById('historyGuests').textContent = '-';
  document.getElementById('historyOthers').textContent = '-';

  google.script.run
    .withSuccessHandler(result => {
      if (result.success) {
        historyData = result;
        historyFilter = 'all';  // フィルタをリセット
        updateHistoryFilterButtons();
        renderHistorySummary(result);
        renderHistoryTable(result.participants);
      } else {
        tbody.innerHTML = `<tr><td colspan="6" class="py-8 text-center text-red-500">${result.message || 'エラー'}</td></tr>`;
      }
    })
    .withFailureHandler(err => {
      tbody.innerHTML = `<tr><td colspan="6" class="py-8 text-center text-red-500">エラー: ${err}</td></tr>`;
      console.error('getParticipantHistory error:', err);
    })
    .getParticipantHistory(eventKey);
}

// サマリー表示
function renderHistorySummary(data) {
  document.getElementById('historyTotal').textContent = data.total + '名';
  document.getElementById('historyMembers').textContent = data.members + '名';
  document.getElementById('historyGuests').textContent = data.guests + '名';
  document.getElementById('historyOthers').textContent = data.others + '名';
  document.getElementById('historyAttended').textContent = (data.attended || 0) + '名';
  document.getElementById('historyCancelled').textContent = (data.cancelled || 0) + '名';
}

// テーブル表示
function renderHistoryTable(participants) {
  const tbody = document.getElementById('historyTableBody');

  // フィルタ適用
  let filtered = participants;
  if (historyFilter !== 'all') {
    // 区分フィルタ（会員/ゲスト/他会場）
    if (['会員', 'ゲスト', '他会場'].includes(historyFilter)) {
      filtered = participants.filter(p => p.category === historyFilter);
    }
    // 出欠フィルタ
    else if (historyFilter === '出席') {
      filtered = participants.filter(p => p.attendance === '出席');
    }
    else if (historyFilter === '欠席') {
      filtered = participants.filter(p => p.attendance === '欠席');
    }
  }

  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-slate-400">該当なし</td></tr>';
    return;
  }

  let html = '';
  filtered.forEach((p, idx) => {
    const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50';
    const categoryClass = p.category === '会員' ? 'text-blue-600' :
                          p.category === 'ゲスト' ? 'text-green-600' : 'text-orange-600';

    // 出欠表示
    let attendanceHtml = '-';
    if (p.attendance === '出席') {
      attendanceHtml = '<span class="text-green-600 font-medium">✓</span>';
    } else if (p.attendance === '欠席') {
      attendanceHtml = '<span class="text-purple-600 font-medium">✗</span>';
    }

    html += `
      <tr class="${bgClass}">
        <td class="py-2 px-2 border border-slate-200 text-center text-slate-400">${idx + 1}</td>
        <td class="py-2 px-2 border border-slate-200">${p.name}</td>
        <td class="py-2 px-2 border border-slate-200 text-center ${categoryClass}">${p.category}</td>
        <td class="py-2 px-2 border border-slate-200">${p.affiliation || '-'}</td>
        <td class="py-2 px-2 border border-slate-200 text-center">${p.table || '-'}</td>
        <td class="py-2 px-2 border border-slate-200 text-center">${attendanceHtml}</td>
      </tr>
    `;
  });

  tbody.innerHTML = html;
}

// フィルタ切り替え
function filterHistory(filter) {
  historyFilter = filter;
  updateHistoryFilterButtons();
  if (historyData && historyData.participants) {
    renderHistoryTable(historyData.participants);
  }
}

// フィルタボタンのアクティブ状態を更新
function updateHistoryFilterButtons() {
  const buttons = document.querySelectorAll('.history-filter-btn');
  buttons.forEach(btn => {
    const btnFilter = btn.getAttribute('data-filter');
    if (btnFilter === historyFilter) {
      btn.classList.add('active', 'bg-slate-100');
    } else {
      btn.classList.remove('active', 'bg-slate-100');
    }
  });
}

// 履歴タブ初期化（タブ切り替え時に呼ばれる）
function initHistoryTab() {
  const select = document.getElementById('historyEventSelect');
  if (select && select.options.length <= 1) {
    loadEventKeyList();
  }
}

/** =========================================================
 *  役割分担編集（例会当日ページ内）
 * ======================================================= */
let roleAssignmentsData = [];  // 役割分担データを保持
let roleEventKey = '';  // 現在選択中の例会キー
let roleCandidates = [];  // 候補者リスト

// 役割編集フォームを読み込み
function loadRoleEditForm() {
  const container = document.getElementById('roleEditCards');
  if (container) {
    container.innerHTML = '<div class="col-span-full text-center text-slate-400 py-4">読み込み中...</div>';
  }

  console.log('[役割編集] データ読み込み開始...');

  // 1. 候補者リストを取得
  google.script.run
    .withSuccessHandler(candidatesResult => {
      console.log('[役割編集] 候補者:', candidatesResult);
      if (candidatesResult.success) {
        roleCandidates = candidatesResult.candidates;
        console.log('[役割編集] 候補者数:', roleCandidates.length);
      } else {
        roleCandidates = [];
      }

      // 2. 役割分担データを取得
      google.script.run
        .withSuccessHandler(result => {
          console.log('[役割編集] 役割分担データ:', result);
          if (result.success) {
            roleAssignmentsData = result.assignments;
            roleEventKey = result.eventKey;
            console.log('[役割編集] eventKey:', roleEventKey);
            console.log('[役割編集] roleAssignmentsData設定完了:', roleAssignmentsData.length, '件');
            console.log('[役割編集] roleAssignmentsDataのroleId一覧:', roleAssignmentsData.map(a => a.roleId));
            console.log('[役割編集] 担当設定済:', result.assignments.filter(a => a.assignee).map(a => `${a.roleId}=${a.assignee}`));
            renderRoleEditCards(result.assignments);
          } else {
            if (container) {
              container.innerHTML = `<div class="col-span-full text-center text-red-500 py-4">${result.message || 'エラー'}</div>`;
            }
          }
        })
        .withFailureHandler(err => {
          console.error('[役割編集] getRoleAssignments エラー:', err);
          if (container) {
            container.innerHTML = `<div class="col-span-full text-center text-red-500 py-4">エラー: ${err.message || err}</div>`;
          }
        })
        .getRoleAssignments('');
    })
    .withFailureHandler(err => {
      console.error('[役割編集] getRoleCandidates エラー:', err);
    })
    .getRoleCandidates();
}

// 役割編集カードを描画（プルダウン式・グループ横並び・モバイル最適化）
function renderRoleEditCards(assignments) {
  const container = document.getElementById('roleEditCards');
  if (!container) return;

  if (!assignments || assignments.length === 0) {
    container.innerHTML = '<div class="col-span-full text-center text-slate-400 py-6 text-base">役割データがありません</div>';
    return;
  }

  // プルダウンのオプションを作成（担当者に応じてselectedを付ける）
  function buildOptions(currentAssignee) {
    let html = `<option value=""${!currentAssignee ? ' selected' : ''}>-- 選択 --</option>`;

    // 候補者リストに現在の担当者がいるかチェック
    const candidateNames = roleCandidates.map(c => c.name);
    const assigneeInList = currentAssignee && candidateNames.includes(currentAssignee);

    // 候補者リストにない場合は先頭に追加
    if (currentAssignee && !assigneeInList) {
      html += `<option value="${escapeHtml(currentAssignee)}" selected>${escapeHtml(currentAssignee)}</option>`;
    }

    // 候補者リストのオプション
    roleCandidates.forEach(c => {
      const isSelected = currentAssignee === c.name;
      html += `<option value="${escapeHtml(c.name)}"${isSelected ? ' selected' : ''}>${escapeHtml(c.name)}</option>`;
    });

    return html;
  }

  // 役割順序・アイコンでグループ化
  const roleConfig = [
    { name: '統括', icon: '👑' },
    { name: 'PA', icon: '🎤' },
    { name: 'MC', icon: '🎙️' },
    { name: 'バッジ授与', icon: '🏅' },
    { name: '受付', icon: '📋' },
    { name: 'ゲスト誘導', icon: '🚶' },
    { name: '会員サポート', icon: '🤝' },
    { name: '名刺回収', icon: '💳' },
    { name: '撮影', icon: '📷' }
  ];
  const groupedRoles = {};

  assignments.forEach(a => {
    if (!groupedRoles[a.roleName]) {
      groupedRoles[a.roleName] = [];
    }
    groupedRoles[a.roleName].push(a);
  });

  let html = '';
  let rowIndex = 0;
  roleConfig.forEach(({ name: roleName, icon }) => {
    const roles = groupedRoles[roleName] || [];
    if (roles.length === 0) return;

    // 交互背景色
    const bgClass = rowIndex % 2 === 0 ? 'bg-slate-50' : 'bg-white';
    rowIndex++;

    // スマホ: 縦並び / PC: 横並び
    html += `<div class="rounded-xl border border-slate-200 ${bgClass} p-4 md:p-3">`;
    html += `<div class="flex flex-col md:flex-row md:items-center gap-3 md:gap-4">`;

    // 役割名ラベル（アイコン付き）
    html += `<div class="flex items-center gap-2 shrink-0 md:w-36">`;
    html += `<span class="text-xl md:text-lg">${icon}</span>`;
    html += `<span class="text-base md:text-sm font-bold text-slate-800">${roleName}</span>`;
    html += `</div>`;

    // プルダウン群（スマホ: 縦並び / PC: 横並び）
    html += `<div class="flex flex-col md:flex-row gap-2 md:gap-3 flex-1">`;

    roles.forEach((a, idx) => {
      console.log('[役割編集] select生成:', a.roleId, a.roleName, a.assignee);
      const borderColor = a.assignee ? 'border-green-500' : 'border-slate-300';
      const bgColor = a.assignee ? 'bg-green-50' : 'bg-white';
      const labelNum = roles.length > 1 ? `${idx + 1}` : '';
      const safeRoleId = a.roleId || '';

      html += `<div class="flex items-center gap-2 flex-1 min-w-0">`;
      if (labelNum) {
        html += `<span class="text-xs text-slate-400 w-4 shrink-0">${labelNum}</span>`;
      }
      html += `<select class="role-select w-full ${bgColor} px-3 py-3 md:py-2 border-2 ${borderColor} rounded-lg text-base md:text-sm font-medium focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 appearance-none" data-role-id="${safeRoleId}" data-role-name="${a.roleName}" onchange="updateRoleAssignment(this)">${buildOptions(a.assignee)}</select>`;
      html += `</div>`;
    });

    html += `</div>`;  // flex-1
    html += `</div></div>`;  // card
  });

  container.innerHTML = html;

  // ログ出力
  const assignedList = assignments.filter(a => a.assignee).map(a => `${a.roleName}=${a.assignee}`);
  console.log('[役割編集] 読み込み完了:', assignedList.length, '件', assignedList);
}

// 役割選択を更新
function updateRoleAssignment(selectEl) {
  console.log('[役割編集] selectEl:', selectEl);
  console.log('[役割編集] selectEl.outerHTML:', selectEl.outerHTML.substring(0, 300));
  const roleId = selectEl.getAttribute('data-role-id');
  const assignee = selectEl.value;

  console.log('[役割編集] 選択変更:', roleId, '→', assignee);
  console.log('[役割編集] 現在のroleAssignmentsData:', roleAssignmentsData.length, '件');

  // データ更新
  const assignment = roleAssignmentsData.find(a => a.roleId === roleId);
  if (assignment) {
    console.log('[役割編集] 更新前:', assignment.roleId, '=', assignment.assignee);
    assignment.assignee = assignee;
    console.log('[役割編集] 更新後:', assignment.roleId, '=', assignment.assignee);
  } else {
    console.log('[役割編集] 警告: roleId=' + roleId + ' がroleAssignmentsDataに見つかりません');
  }

  // プルダウンの見た目を更新
  if (assignee) {
    selectEl.classList.remove('bg-white', 'border-slate-300');
    selectEl.classList.add('bg-green-50', 'border-green-500');
  } else {
    selectEl.classList.remove('bg-green-50', 'border-green-500');
    selectEl.classList.add('bg-white', 'border-slate-300');
  }
}

// 役割分担を保存
function saveRoleAssignments() {
  if (!roleEventKey) {
    showRoleSaveMessage('例会が選択されていません', 'error');
    return;
  }

  const saveBtn = document.querySelector('button[onclick="saveRoleAssignments()"]');
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = '保存中...';
  }

  // 保存するデータをログ出力
  console.log('[役割保存] eventKey:', roleEventKey);
  console.log('[役割保存] roleAssignmentsData:', roleAssignmentsData);
  const assignedOnly = roleAssignmentsData.filter(a => a.assignee);
  console.log('[役割保存] 担当設定数:', assignedOnly.length, assignedOnly.map(a => `${a.roleId}=${a.assignee}`));

  const payload = {
    eventKey: roleEventKey,
    assignments: roleAssignmentsData.map(a => ({
      roleId: a.roleId,
      roleName: a.roleName,
      assignee: a.assignee || ''
    }))
  };

  console.log('[役割保存] payload:', payload);
  console.log('[役割保存] GAS呼び出し開始...');

  // eventKeyとassignmentsを別々に渡す
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('[役割保存] GAS成功:', result);
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = '💾 保存';
      }

      if (result.success) {
        showRoleSaveMessage(result.message, 'success');
      } else {
        showRoleSaveMessage(result.error || 'エラーが発生しました', 'error');
      }
    })
    .withFailureHandler(function(err) {
      console.error('[役割保存] GAS失敗:', err);
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = '💾 保存';
      }
      showRoleSaveMessage('エラー: ' + err, 'error');
    })
    .saveRoleAssignments(payload.eventKey, payload.assignments);
}

// 保存結果メッセージ表示
function showRoleSaveMessage(message, type) {
  const msgEl = document.getElementById('roleSaveMessage');
  if (!msgEl) return;

  msgEl.classList.remove('hidden', 'text-green-600', 'text-red-500');

  if (type === 'success') {
    msgEl.classList.add('text-green-600');
    msgEl.textContent = '✅ ' + message;
  } else {
    msgEl.classList.add('text-red-500');
    msgEl.textContent = '❌ ' + message;
  }

  // 3秒後に非表示
  setTimeout(() => {
    msgEl.classList.add('hidden');
  }, 3000);
}

// Enterキーでパスワード確認
document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    const modal = document.getElementById('salesPasswordModal');
    if (modal && !modal.classList.contains('hidden')) {
      verifySalesPassword();
    }
  }
});

/** =========================================================
 *  チェックイン機能
 * ======================================================= */

let checkinData = null;  // チェックイン状況データ
let checkinFilter = 'all';  // 現在のフィルタ

// チェックイン状況を取得
function loadCheckinStatus() {
  const memberList = document.getElementById('checkinMemberList');
  const otherList = document.getElementById('checkinOtherList');
  const guestList = document.getElementById('checkinGuestList');

  if (memberList) memberList.innerHTML = '<div class="text-center text-slate-400 py-4">読み込み中...</div>';
  if (otherList) otherList.innerHTML = '<div class="text-center text-slate-400 py-4">読み込み中...</div>';
  if (guestList) guestList.innerHTML = '<div class="text-center text-slate-400 py-4">読み込み中...</div>';

  google.script.run
    .withSuccessHandler(result => {
      if (result.success) {
        checkinData = result.data;
        renderCheckinStatus();
      } else {
        if (memberList) memberList.innerHTML = '<div class="text-center text-red-500 py-4">エラー: ' + (result.message || '取得失敗') + '</div>';
      }
    })
    .withFailureHandler(err => {
      if (memberList) memberList.innerHTML = '<div class="text-center text-red-500 py-4">エラー: ' + err + '</div>';
    })
    .getCheckinStatus();
}

// チェックイン状況を表示
function renderCheckinStatus() {
  if (!checkinData) return;

  // サマリー更新
  const summary = checkinData.summary || {};
  document.getElementById('checkinArrived').textContent = `${summary.checkedIn || 0}/${summary.total || 0}`;
  document.getElementById('checkinCancelled').textContent = summary.cancelled || 0;
  document.getElementById('checkinBadgeLent').textContent = summary.badgeLent || 0;
  document.getElementById('checkinBadgeNotReturned').textContent = summary.badgeNotReturned || 0;
  document.getElementById('checkinLastUpdate').textContent = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

  // フィルタリング
  const members = filterCheckinList(checkinData.members || []);
  const others = filterCheckinList(checkinData.otherVenue || []);
  const guests = filterCheckinList(checkinData.guests || []);

  // カウント更新
  document.getElementById('checkinMemberCount').textContent = `(${members.length}人)`;
  document.getElementById('checkinOtherCount').textContent = `(${others.length}人)`;
  document.getElementById('checkinGuestCount').textContent = `(${guests.length}人)`;

  // 会員リスト
  const memberList = document.getElementById('checkinMemberList');
  if (memberList) {
    memberList.innerHTML = members.length > 0
      ? members.map(p => renderCheckinCard(p, true)).join('')
      : '<div class="text-center text-slate-400 py-4">該当なし</div>';
  }

  // 他会場リスト
  const otherList = document.getElementById('checkinOtherList');
  if (otherList) {
    otherList.innerHTML = others.length > 0
      ? others.map(p => renderCheckinCard(p, true)).join('')
      : '<div class="text-center text-slate-400 py-4">該当なし</div>';
  }

  // ゲストリスト
  const guestList = document.getElementById('checkinGuestList');
  if (guestList) {
    guestList.innerHTML = guests.length > 0
      ? guests.map(p => renderCheckinCard(p, false)).join('')
      : '<div class="text-center text-slate-400 py-4">該当なし</div>';
  }
}

// フィルタリング
function filterCheckinList(list) {
  switch (checkinFilter) {
    case 'arrived':
      return list.filter(p => p.checkedIn);
    case 'notArrived':
      return list.filter(p => !p.checkedIn);
    case 'badgeNotReturned':
      return list.filter(p => p.badgeLent && !p.badgeReturned);
    default:
      return list;
  }
}

// チェックインカード生成（スマホ最適化版）
function renderCheckinCard(person, showBadge) {
  const checkedIn = person.checkedIn;
  const isCancelled = person.cancelled === true;

  // 状態別の背景色
  let cardBgColor = 'bg-white border-slate-200';
  let nameTextColor = 'text-slate-700';
  let statusIcon = '';

  if (isCancelled) {
    cardBgColor = 'bg-purple-50 border-purple-200';
    nameTextColor = 'text-purple-600 line-through';
    statusIcon = '<span class="text-purple-500">✗</span>';
  } else if (checkedIn) {
    cardBgColor = 'bg-emerald-50 border-emerald-200';
    nameTextColor = 'text-emerald-800';
    statusIcon = '<span class="text-emerald-500">✓</span>';
  }

  // 席バッジ
  const seatBadge = person.seat
    ? `<span class="text-xs px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-medium">${person.seat}</span>`
    : '';

  // チェックイン時刻
  const timeText = person.checkinTime
    ? `<span class="text-xs text-slate-400">${person.checkinTime}</span>`
    : '';

  // ボタン（状態別）
  let actionButton = '';
  if (isCancelled) {
    actionButton = `
      <button onclick="undoCancelCheckin(${person.rowIndex})"
        class="text-xs px-3 py-1.5 bg-slate-400 text-white rounded-lg font-medium">
        解除
      </button>`;
  } else if (checkedIn) {
    actionButton = `
      <button onclick="cancelManualCheckin(${person.rowIndex})"
        class="text-xs px-3 py-1.5 bg-slate-200 text-slate-600 rounded-lg font-medium">
        取消
      </button>`;
  } else {
    actionButton = `
      <button onclick="manualCheckin(${person.rowIndex})"
        class="text-xs px-4 py-1.5 bg-emerald-500 text-white rounded-lg font-medium shadow-sm">
        到着
      </button>
      <button onclick="markAsCancelled(${person.rowIndex})"
        class="text-xs px-3 py-1.5 bg-purple-100 text-purple-600 rounded-lg font-medium">
        欠席
      </button>`;
  }

  // バッジ欄（到着済みの会員・他会場のみ表示）
  let badgeSection = '';
  if (showBadge && checkedIn && !isCancelled) {
    const badgeLentChecked = person.badgeLent ? 'checked' : '';
    const badgeReturnedChecked = person.badgeReturned ? 'checked' : '';
    const badgeReturnedDisabled = !person.badgeLent ? 'disabled' : '';

    badgeSection = `
      <div class="flex items-center gap-4 mt-2 pt-2 border-t border-slate-100">
        <label class="flex items-center gap-1.5 text-xs text-slate-600">
          <input type="checkbox" ${badgeLentChecked}
            onchange="updateCheckinField(${person.rowIndex}, 'badgeLent', this.checked)"
            class="w-4 h-4 rounded border-slate-300 accent-blue-500" />
          バッジ貸出
        </label>
        <label class="flex items-center gap-1.5 text-xs ${person.badgeLent ? 'text-slate-600' : 'text-slate-300'}">
          <input type="checkbox" ${badgeReturnedChecked} ${badgeReturnedDisabled}
            onchange="updateCheckinField(${person.rowIndex}, 'badgeReturned', this.checked)"
            class="w-4 h-4 rounded border-slate-300 accent-emerald-500" />
          返却済
        </label>
        <input type="text" placeholder="領収書No" value="${person.receiptNo || ''}"
          onchange="updateCheckinField(${person.rowIndex}, 'receiptNo', this.value)"
          class="flex-1 max-w-[80px] text-xs px-2 py-1 border border-slate-200 rounded" />
      </div>`;
  }

  // 所属（長い場合は省略）
  const affiliationText = person.affiliation && person.affiliation !== '福岡飯塚'
    ? `<span class="text-xs text-slate-400 truncate max-w-[100px]">${person.affiliation}</span>`
    : '';

  return `
    <div class="checkin-card p-2.5 rounded-xl border ${cardBgColor} mb-1.5" data-checked="${checkedIn}" data-cancelled="${isCancelled}" data-row="${person.rowIndex}">
      <div class="flex items-center justify-between gap-2">
        <div class="flex items-center gap-2 min-w-0 flex-1">
          ${statusIcon}
          ${seatBadge}
          <span class="text-sm font-medium ${nameTextColor} truncate">${person.name}</span>
          ${affiliationText}
          ${timeText}
        </div>
        <div class="flex items-center gap-1.5 flex-shrink-0">
          ${actionButton}
        </div>
      </div>
      ${badgeSection}
    </div>
  `;
}

// フィルタ切り替え
function filterCheckin(filter) {
  checkinFilter = filter;

  // ボタンのアクティブ状態を更新
  document.querySelectorAll('.checkin-filter-btn').forEach(btn => {
    if (btn.dataset.filter === filter) {
      btn.classList.remove('border-slate-200', 'hover:bg-slate-50');
      btn.classList.add('active', 'border-teal-200', 'bg-teal-50', 'text-teal-700');
    } else {
      btn.classList.remove('active', 'border-teal-200', 'bg-teal-50', 'text-teal-700');
      btn.classList.add('border-slate-200', 'hover:bg-slate-50');
    }
  });

  renderCheckinStatus();
}

// チェックインフィールド更新
function updateCheckinField(rowIndex, field, value) {
  google.script.run
    .withSuccessHandler(result => {
      if (result.success) {
        // データをリロード
        refreshCheckinStatus();
      } else {
        alert('更新に失敗しました: ' + (result.message || '不明なエラー'));
      }
    })
    .withFailureHandler(err => {
      alert('エラー: ' + err);
    })
    .updateCheckinField(rowIndex, field, value);
}

// 手動チェックイン
function manualCheckin(rowIndex) {
  if (!confirm('このメンバーをチェックインしますか？')) return;

  google.script.run
    .withSuccessHandler(result => {
      if (result.success) {
        refreshCheckinStatus();
      } else {
        alert('チェックインに失敗しました: ' + (result.message || '不明なエラー'));
      }
    })
    .withFailureHandler(err => {
      alert('エラー: ' + err);
    })
    .manualCheckin(rowIndex);
}

// キャンセル（欠席）マーク
function markAsCancelled(rowIndex) {
  if (!confirm('このメンバーを欠席扱いにしますか？')) return;

  // UIを即座に更新（薄紫に）
  const card = document.querySelector(`.checkin-card[data-row="${rowIndex}"]`);
  if (card) {
    card.classList.remove('bg-white', 'border-slate-200', 'bg-emerald-50', 'border-emerald-200');
    card.classList.add('bg-purple-50', 'border-purple-200');
    card.dataset.cancelled = 'true';
  }

  google.script.run
    .withSuccessHandler(result => {
      if (result.success) {
        refreshCheckinStatus();
      } else {
        alert('キャンセルに失敗しました: ' + (result.message || '不明なエラー'));
        refreshCheckinStatus();
      }
    })
    .withFailureHandler(err => {
      alert('エラー: ' + err);
      refreshCheckinStatus();
    })
    .markCheckinCancelled(rowIndex, true);
}

// キャンセル（チェックイン済みからのキャンセル）
function cancelManualCheckin(rowIndex) {
  if (!confirm('このメンバーのチェックインをキャンセルしますか？')) return;

  google.script.run
    .withSuccessHandler(result => {
      if (result.success) {
        refreshCheckinStatus();
      } else {
        alert('キャンセルに失敗しました: ' + (result.message || '不明なエラー'));
      }
    })
    .withFailureHandler(err => {
      alert('エラー: ' + err);
    })
    .cancelCheckinByRow(rowIndex);
}

// キャンセル解除
function undoCancelCheckin(rowIndex) {
  if (!confirm('欠席を取り消しますか？')) return;

  google.script.run
    .withSuccessHandler(result => {
      if (result.success) {
        refreshCheckinStatus();
      } else {
        alert('取消解除に失敗しました: ' + (result.message || '不明なエラー'));
      }
    })
    .withFailureHandler(err => {
      alert('エラー: ' + err);
    })
    .markCheckinCancelled(rowIndex, false);
}

// チェックインデータ初期化（2段階確認）
function initCheckinData() {
  // 第1段階: 基本確認
  if (!confirm('⚠️ チェックインデータを初期化しますか？\n\n配席アーカイブから参加者情報をコピーします。')) return;

  // 第2段階: 最終確認（既存データ上書き警告）
  const finalConfirm = prompt(
    '【最終確認】\n\n' +
    '既存のチェックインデータは全て上書きされます。\n' +
    'チェックイン済み・バッジ貸出状況も消えます。\n\n' +
    '本当に実行する場合は「初期化」と入力してください:'
  );

  if (finalConfirm !== '初期化') {
    alert('初期化をキャンセルしました。');
    return;
  }

  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '初期化中...';

  google.script.run
    .withSuccessHandler(result => {
      btn.disabled = false;
      btn.textContent = '📥 データ初期化';
      if (result.success) {
        alert('✅ 初期化完了: ' + result.count + '件のデータをコピーしました');
        refreshCheckinStatus();
        // 管理メニューを閉じる
        document.querySelector('details')?.removeAttribute('open');
      } else {
        alert('初期化に失敗しました: ' + (result.message || '不明なエラー'));
      }
    })
    .withFailureHandler(err => {
      btn.disabled = false;
      btn.textContent = '📥 データ初期化';
      alert('エラー: ' + err);
    })
    .initCheckinData();
}

// 更新ボタン
function refreshCheckinStatus() {
  loadCheckinStatus();
}

/** =========================================================
 *  会員名簿編集機能
 * ======================================================= */

let memberEditData = [];  // 全会員データ
let memberTeams = [];     // チーム一覧
let memberBadges = [];    // バッジ一覧
let memberEditPassword = '';  // 認証済みパスワード
let pendingSaveData = null;   // 保存待ちデータ

// 会員一覧を取得
function loadMembersForEdit() {
  const grid = document.getElementById('memberCardGrid');
  if (grid) {
    grid.innerHTML = `
      <div class="member-loading">
        <div class="member-loading-spinner"></div>
        <p>会員データを読み込み中...</p>
      </div>
    `;
  }

  const showRetiredOnly = document.getElementById('memberShowRetiredOnly')?.checked || false;

  google.script.run
    .withSuccessHandler(result => {
      if (result.success) {
        memberEditData = result.members || [];
        memberTeams = result.teams || [];
        memberBadges = result.badges || [];
        updateMemberTeamFilter();
        filterMembers();
        // 会員数は退会者を除外して表示
        updateMemberCount();
      } else {
        if (grid) {
          grid.innerHTML = `<div class="member-empty"><div class="member-empty-icon">⚠️</div><p>エラー: ${result.message || '取得失敗'}</p></div>`;
        }
      }
    })
    .withFailureHandler(err => {
      if (grid) {
        grid.innerHTML = `<div class="member-empty"><div class="member-empty-icon">⚠️</div><p>エラー: ${err}</p></div>`;
      }
    })
    .getMembersForEdit({ showRetiredOnly: showRetiredOnly });
}

// チームフィルタのオプションを更新
function updateMemberTeamFilter() {
  const select = document.getElementById('memberTeamFilter');
  if (!select) return;

  let html = '<option value="">チーム: 全て</option>';
  html += '<option value="__unassigned__">未配属</option>';
  memberTeams.forEach(team => {
    html += `<option value="${escapeHtml(team)}">${escapeHtml(team)}</option>`;
  });
  select.innerHTML = html;
}

// 会員をフィルタして表示
function filterMembers() {
  const searchText = (document.getElementById('memberSearchInput')?.value || '').toLowerCase();
  const teamFilter = document.getElementById('memberTeamFilter')?.value || '';
  const badgeFilter = document.getElementById('memberBadgeFilter')?.value || '';
  const renewalFilter = document.getElementById('memberRenewalFilter')?.value || '';

  let filtered = memberEditData.filter(m => {
    // 検索テキスト
    if (searchText) {
      const target = (m.name + m.furigana + m.company).toLowerCase();
      if (target.indexOf(searchText) === -1) return false;
    }
    // チーム（未配属は空文字列で判定）
    if (teamFilter) {
      if (teamFilter === '__unassigned__') {
        if (m.team) return false; // チームが設定されていたら除外
      } else {
        if (m.team !== teamFilter) return false;
      }
    }
    // バッジ
    if (badgeFilter && m.badge !== badgeFilter) return false;
    // 更新月
    if (renewalFilter && m.renewalMonth !== renewalFilter) return false;
    return true;
  });

  renderMemberCards(filtered);
}

// 会員数を更新（退会者を除外）
function updateMemberCount() {
  const showRetiredOnly = document.getElementById('memberShowRetiredOnly')?.checked || false;
  if (showRetiredOnly) {
    // 退会者のみ表示モードの場合は退会者数を表示
    document.getElementById('memberCountDisplay').textContent = memberEditData.length + '（退会者）';
  } else {
    // 通常モードは現役会員数を表示
    const activeCount = memberEditData.filter(m => !m.retired && !m.isFromRetiredSheet).length;
    document.getElementById('memberCountDisplay').textContent = activeCount;
  }
}

// 会員カードを描画
function renderMemberCards(members) {
  const grid = document.getElementById('memberCardGrid');
  if (!grid) return;

  if (members.length === 0) {
    grid.innerHTML = `
      <div class="member-empty">
        <div class="member-empty-icon">👥</div>
        <p>該当する会員がいません</p>
      </div>
    `;
    return;
  }

  let html = '';
  members.forEach(m => {
    const badgeEmoji = getMemberBadgeEmoji(m.badge);
    const isRetiredSheet = m.isFromRetiredSheet === true;
    const retiredClass = (m.retired || isRetiredSheet) ? ' retired' : '';

    // 退会者シートからのデータは閲覧のみ
    const clickHandler = isRetiredSheet
      ? `showRetiredMemberInfo(${JSON.stringify(m).replace(/"/g, '&quot;')})`
      : `openMemberModal(${m.rowIndex})`;

    // メタ情報の表示（退会者は退会月を表示）
    const metaInfo = isRetiredSheet
      ? `<span>${m.team || '未配属'}</span><span>|</span><span style="color:#dc2626;">退会: ${m.retiredMonth || '-'}</span>`
      : `<span>${m.team || '未配属'}</span><span>|</span><span>更新: ${m.renewalMonth ? m.renewalMonth + '月' : '-'}</span>`;

    // 退会ラベル
    const retiredLabel = isRetiredSheet
      ? ' <span style="color:#dc2626;font-size:0.65rem;background:#fee2e2;padding:0 4px;border-radius:3px;">(退会者)</span>'
      : (m.retired ? ' <span style="color:#dc2626;font-size:0.65rem;">(退会)</span>' : '');

    // ボタン（退会者シートは閲覧ボタン）
    const buttonLabel = isRetiredSheet ? '詳細' : '編集';
    const buttonHandler = isRetiredSheet
      ? `event.stopPropagation(); showRetiredMemberInfo(${JSON.stringify(m).replace(/"/g, '&quot;')})`
      : `event.stopPropagation(); openMemberModal(${m.rowIndex})`;

    html += `
      <div class="member-edit-card${retiredClass}" onclick="${clickHandler}">
        <span class="member-card-badge">${badgeEmoji}</span>
        <div class="member-card-info">
          <div class="member-card-name">${escapeHtml(m.name)}${retiredLabel}</div>
          <div class="member-card-meta">${metaInfo}</div>
        </div>
        <button class="member-card-edit-btn" onclick="${buttonHandler}">${buttonLabel}</button>
      </div>
    `;
  });

  grid.innerHTML = html;
}

// バッジ絵文字を取得
function getMemberBadgeEmoji(badge) {
  switch (badge) {
    case 'ゴ': return '🥇';
    case '正': return '🔴';
    case '準': return '🟢';
    case '紫': return '🟣';
    case 'ダイヤ': return '💎';
    default: return '👤';
  }
}

// 退会者情報を表示（閲覧のみ）
function showRetiredMemberInfo(member) {
  const badgeName = {
    'ゴ': 'ゴールド',
    '正': '正会員',
    '準': '準会員',
    '紫': '紫バッジ',
    'ダイヤ': 'ダイヤモンド'
  }[member.badge] || member.badge || '不明';

  const info = `
【退会者情報】

氏名: ${member.name}
フリガナ: ${member.furigana || '-'}
バッジ: ${badgeName}
チーム: ${member.team || '-'}
会社名: ${member.company || '-'}
役職: ${member.position || '-'}
営業内容: ${member.business || '-'}

入会月: ${member.joinDate || '-'}
退会月: ${member.retiredMonth || '-'}
紹介者: ${member.introducer || '-'}
紹介数: ${member.referralCount || '-'}

※退会者シートのデータは閲覧のみです
  `.trim();

  alert(info);
}

// 編集モーダルを開く
function openMemberModal(rowIndex) {
  const modal = document.getElementById('memberModal');
  if (!modal) return;

  // チームセレクトボックスを更新
  const teamSelect = document.getElementById('memberEditTeam');
  if (teamSelect) {
    let html = '<option value="">未配属</option>';
    memberTeams.forEach(team => {
      html += `<option value="${escapeHtml(team)}">${escapeHtml(team)}</option>`;
    });
    teamSelect.innerHTML = html;
  }

  if (rowIndex === null) {
    // 新規追加モード
    document.getElementById('memberModalIcon').textContent = '➕';
    document.getElementById('memberModalTitle').textContent = '新規会員追加';
    document.getElementById('memberEditRowIndex').value = '';
    document.getElementById('memberEditId').value = '(自動採番)';
    document.getElementById('memberRetireSection').style.display = 'none';

    // フォームをクリア
    clearMemberForm();
  } else {
    // 編集モード
    document.getElementById('memberModalIcon').textContent = '✏️';
    document.getElementById('memberModalTitle').textContent = '会員情報編集';
    document.getElementById('memberEditRowIndex').value = rowIndex;
    document.getElementById('memberRetireSection').style.display = 'block';

    // データを取得してフォームにセット
    const member = memberEditData.find(m => m.rowIndex === rowIndex);
    if (member) {
      fillMemberForm(member);
    }
  }

  modal.classList.add('active');
}

// モーダルを閉じる
function closeMemberModal() {
  const modal = document.getElementById('memberModal');
  if (modal) {
    modal.classList.remove('active');
  }
}

// フォームをクリア（新規追加用にデフォルト値を設定）
function clearMemberForm() {
  document.getElementById('memberEditBadge').value = '';
  document.getElementById('memberEditName').value = '';
  document.getElementById('memberEditFurigana').value = '';
  document.getElementById('memberEditTeam').value = '';
  document.getElementById('memberEditAffiliation').value = '福岡飯塚'; // デフォルト所属
  document.getElementById('memberEditCompany').value = '';
  document.getElementById('memberEditPosition').value = '';
  document.getElementById('memberEditBusiness').value = '';
  document.getElementById('memberEditRole').value = '';
  document.getElementById('memberEditIntroducer').value = '';
  document.getElementById('memberEditReferralCount').value = '';
  document.getElementById('memberEditReferralActive').value = '';
  document.getElementById('memberEditAward').value = '';
  document.getElementById('memberEditPurpleBadge').value = '';
  document.getElementById('memberEditJoinDate').value = '';
  document.getElementById('memberEditRenewalMonth').value = '';
  document.getElementById('memberEditContinuedMonths').value = '';
  document.getElementById('memberEditCategory').value = '';
  document.getElementById('memberEditRetired').checked = false;
}

// フォームにデータをセット
function fillMemberForm(m) {
  document.getElementById('memberEditId').value = m.memberId || '';
  document.getElementById('memberEditBadge').value = m.badge || '';
  document.getElementById('memberEditName').value = m.name || '';
  document.getElementById('memberEditFurigana').value = m.furigana || '';
  document.getElementById('memberEditTeam').value = m.team || '';
  document.getElementById('memberEditAffiliation').value = m.affiliation || '';
  document.getElementById('memberEditCompany').value = m.company || '';
  document.getElementById('memberEditPosition').value = m.position || '';
  document.getElementById('memberEditBusiness').value = m.business || '';
  document.getElementById('memberEditRole').value = m.role || '';
  document.getElementById('memberEditIntroducer').value = m.introducer || '';
  document.getElementById('memberEditReferralCount').value = m.referralCount || '';
  document.getElementById('memberEditReferralActive').value = m.referralActive || '';
  document.getElementById('memberEditAward').value = m.award || '';
  document.getElementById('memberEditPurpleBadge').value = m.purpleBadge || '';
  document.getElementById('memberEditJoinDate').value = m.joinDate || '';
  document.getElementById('memberEditRenewalMonth').value = m.renewalMonth || '';
  document.getElementById('memberEditContinuedMonths').value = m.continuedMonths || '';
  document.getElementById('memberEditCategory').value = m.category || '';
  document.getElementById('memberEditRetired').checked = !!m.retired;
}

// フォームからデータを収集
function collectMemberFormData() {
  return {
    badge: document.getElementById('memberEditBadge').value,
    name: document.getElementById('memberEditName').value.trim(),
    furigana: document.getElementById('memberEditFurigana').value.trim(),
    team: document.getElementById('memberEditTeam').value,
    affiliation: document.getElementById('memberEditAffiliation').value.trim(),
    company: document.getElementById('memberEditCompany').value.trim(),
    position: document.getElementById('memberEditPosition').value.trim(),
    business: document.getElementById('memberEditBusiness').value.trim(),
    role: document.getElementById('memberEditRole').value.trim(),
    introducer: document.getElementById('memberEditIntroducer').value.trim(),
    referralCount: document.getElementById('memberEditReferralCount').value.trim(),
    referralActive: document.getElementById('memberEditReferralActive').value.trim(),
    award: document.getElementById('memberEditAward').value.trim(),
    purpleBadge: document.getElementById('memberEditPurpleBadge').value.trim(),
    joinDate: document.getElementById('memberEditJoinDate').value,
    renewalMonth: document.getElementById('memberEditRenewalMonth').value,
    continuedMonths: document.getElementById('memberEditContinuedMonths').value.trim(),
    category: document.getElementById('memberEditCategory').value.trim(),
    retired: document.getElementById('memberEditRetired').checked
  };
}

// 保存ボタン
function saveMember() {
  const data = collectMemberFormData();

  // バリデーション
  if (!data.name) {
    alert('氏名は必須です');
    return;
  }

  const rowIndex = document.getElementById('memberEditRowIndex').value;

  // 保存データを一時保存
  pendingSaveData = {
    rowIndex: rowIndex ? parseInt(rowIndex, 10) : null,
    data: data
  };

  // パスワードモーダルを開く
  openPasswordModal();
}

// パスワードモーダルを開く
function openPasswordModal() {
  const modal = document.getElementById('passwordModal');
  if (modal) {
    modal.classList.add('active');
    document.getElementById('memberPassword').value = '';
    document.getElementById('passwordError').classList.remove('show');
    document.getElementById('memberPassword').focus();
  }
}

// パスワードモーダルを閉じる
function closePasswordModal() {
  const modal = document.getElementById('passwordModal');
  if (modal) {
    modal.classList.remove('active');
  }
  pendingSaveData = null;
}

// パスワード確認
function confirmPassword() {
  const password = document.getElementById('memberPassword').value;
  const errorEl = document.getElementById('passwordError');

  if (!password) {
    errorEl.textContent = 'パスワードを入力してください';
    errorEl.classList.add('show');
    return;
  }

  // パスワード検証
  google.script.run
    .withSuccessHandler(result => {
      if (result.success) {
        memberEditPassword = password;
        closePasswordModal();
        executeSave();
      } else {
        errorEl.textContent = result.message || 'パスワードが違います';
        errorEl.classList.add('show');
      }
    })
    .withFailureHandler(err => {
      errorEl.textContent = 'エラー: ' + err;
      errorEl.classList.add('show');
    })
    .verifyMemberEditPassword(password);
}

// 実際の保存処理
function executeSave() {
  if (!pendingSaveData) return;

  const { rowIndex, data } = pendingSaveData;

  const saveBtn = document.querySelector('.member-btn-save');
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '保存中...';
  }

  if (rowIndex) {
    // 更新
    google.script.run
      .withSuccessHandler(result => {
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '💾 保存';
        }
        if (result.success) {
          alert('保存しました');
          closeMemberModal();
          loadMembersForEdit();
        } else {
          alert('エラー: ' + (result.message || '保存に失敗しました'));
        }
      })
      .withFailureHandler(err => {
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '💾 保存';
        }
        alert('エラー: ' + err);
      })
      .updateMember(rowIndex, data, memberEditPassword);
  } else {
    // 新規追加
    google.script.run
      .withSuccessHandler(result => {
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '💾 保存';
        }
        if (result.success) {
          alert('会員を追加しました（ID: ' + result.memberId + '）');
          closeMemberModal();
          loadMembersForEdit();
        } else {
          alert('エラー: ' + (result.message || '追加に失敗しました'));
        }
      })
      .withFailureHandler(err => {
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '💾 保存';
        }
        alert('エラー: ' + err);
      })
      .addMember(data, memberEditPassword);
  }

  pendingSaveData = null;
}

// 会員管理タブ初期化
function initMemberTab() {
  if (memberEditData.length === 0) {
    loadMembersForEdit();
  }
}

    </script>

<!-- ★配席表モーダル -->
<div id="seatingChartModal" class="seating-modal">
  <div class="seating-modal-overlay" onclick="closeSeatingChartModal()"></div>
  <div class="seating-modal-content">
    <div class="seating-modal-header">
      <h3 class="seating-modal-title">
        <span>🪑</span>
        <span id="seatingChartTitle">配席表</span>
      </h3>
      <button class="seating-modal-close" onclick="closeSeatingChartModal()">&times;</button>
    </div>
    <div class="seating-modal-body">
      <div id="seatingChartContent" class="seating-chart-container">
        <div class="seating-loading">配席データを読み込み中...</div>
      </div>
    </div>
    <div class="seating-modal-footer">
      <div class="seating-legend-item">
        <span class="seating-legend-dot" style="background: #f59e0b;"></span>
        <span>TM</span>
      </div>
      <div class="seating-legend-item">
        <span class="seating-legend-dot" style="background: #22c55e;"></span>
        <span>会員</span>
      </div>
      <div class="seating-legend-item">
        <span class="seating-legend-dot" style="background: #3b82f6;"></span>
        <span>ゲスト</span>
      </div>
      <div class="seating-legend-item">
        <span class="seating-legend-dot" style="background: #f97316;"></span>
        <span>他会場</span>
      </div>
    </div>
  </div>
</div>

<!-- ★パスワード入力モーダル -->
<div id="salesPasswordModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
  <!-- オーバーレイ -->
  <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeSalesPasswordModal()"></div>
  <!-- モーダル本体 -->
  <div class="relative bg-white rounded-xl shadow-xl p-6 w-80 max-w-[90vw]">
    <h3 class="text-lg font-semibold mb-4 text-center">🔐 パスワード入力</h3>
    <p class="text-sm text-slate-500 mb-4 text-center">
      個別売上を閲覧するにはパスワードが必要です
    </p>
    <input
      type="password"
      id="salesPasswordInput"
      placeholder="パスワード"
      class="w-full px-4 py-2 border border-slate-300 rounded-lg mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
    <div id="salesPasswordError" class="text-red-500 text-sm mb-3 text-center"></div>
    <div class="flex gap-2">
      <button
        onclick="closeSalesPasswordModal()"
        class="flex-1 px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition"
      >
        キャンセル
      </button>
      <button
        id="verifySalesPasswordBtn"
        onclick="verifySalesPassword()"
        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
      >
        確認
      </button>
    </div>
  </div>
</div>

<!-- ★例会アンケート送信管理モーダル -->
<div id="surveyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
  <!-- オーバーレイ -->
  <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeSurveyModal()"></div>
  <!-- モーダル本体（スマホ最適化） -->
  <div class="relative bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-hidden mx-4">
    <!-- ヘッダー -->
    <div class="bg-purple-600 text-white px-4 py-3 flex items-center justify-between">
      <h3 class="text-base font-semibold flex items-center gap-2">
        <span class="material-icons text-lg">assignment</span>
        例会アンケート送信
      </h3>
      <button onclick="closeSurveyModal()" class="text-white hover:bg-purple-700 rounded-full p-1 transition">
        <span class="material-icons">close</span>
      </button>
    </div>

    <!-- コンテンツ -->
    <div class="p-4 overflow-y-auto max-h-[calc(90vh-110px)]">
      <!-- イベント情報 -->
      <div class="mb-4">
        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
          <span class="material-icons text-purple-500 text-base">event</span>
          対象例会
        </h4>
        <div id="surveyEventInfo" class="bg-purple-50 rounded-lg p-3">
          <p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>
        </div>
      </div>

      <!-- 送信対象者セクション -->
      <div class="mb-4">
        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
          <span class="material-icons text-green-500 text-base">people</span>
          送信対象者
          <span id="surveyTargetCount" class="text-xs text-slate-400 font-normal ml-auto">(-名)</span>
        </h4>
        <div class="bg-slate-50 rounded-lg p-3">
          <!-- 全員選択 -->
          <div class="flex items-center gap-2 mb-3 pb-2 border-b border-slate-200">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="surveySelectAll" onchange="toggleSurveySelectAll()" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
              <span class="text-sm font-medium text-slate-700">全員選択</span>
            </label>
            <span id="surveySelectedCount" class="text-xs text-slate-400 ml-auto">選択: 0名</span>
          </div>
          <!-- 参加者リスト -->
          <div id="surveyParticipantsList" class="max-h-48 overflow-y-auto space-y-1">
            <p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>
          </div>
        </div>
      </div>

      <!-- LINE未登録者セクション -->
      <div class="mb-4">
        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
          <span class="material-icons text-amber-500 text-base">warning</span>
          LINE未登録（手動連絡）
        </h4>
        <div id="surveyNoLineMembers" class="bg-amber-50 rounded-lg p-3">
          <p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>
        </div>
      </div>

      <!-- メッセージ編集セクション -->
      <div class="mb-4">
        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
          <span class="material-icons text-blue-500 text-base">edit_note</span>
          <span>送信メッセージ</span>
          <button onclick="toggleSurveyMessageEdit()" id="surveyMessageEditToggle" class="ml-auto text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">
            <span class="material-icons text-sm">edit</span>
            編集
          </button>
        </h4>
        <div class="bg-slate-50 rounded-lg p-3">
          <!-- プレビュー表示（デフォルト） -->
          <div id="surveyMessagePreviewContainer">
            <div id="surveyMessagePreview" class="text-xs text-slate-600 whitespace-pre-wrap max-h-48 overflow-y-auto border border-slate-200 rounded p-3 bg-white">
              読み込み中...
            </div>
          </div>
          <!-- 編集モード（非表示） -->
          <div id="surveyMessageEditContainer" class="hidden">
            <textarea id="surveyMessageTextarea" class="w-full h-48 p-3 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-y font-mono" placeholder="メッセージを入力..."></textarea>
            <div class="flex flex-wrap gap-2 mt-2">
              <button onclick="applySurveyMessage()" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium rounded-lg transition flex items-center gap-1">
                <span class="material-icons text-sm">check</span>
                適用
              </button>
              <button onclick="resetSurveyMessageToDefault()" class="px-3 py-1.5 bg-slate-500 hover:bg-slate-600 text-white text-xs font-medium rounded-lg transition flex items-center gap-1">
                <span class="material-icons text-sm">refresh</span>
                デフォルトに戻す
              </button>
              <button onclick="toggleSurveyMessageEdit()" class="px-3 py-1.5 bg-slate-200 hover:bg-slate-300 text-slate-700 text-xs font-medium rounded-lg transition">
                キャンセル
              </button>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-2">※ <code class="bg-slate-200 px-1 rounded">{SURVEY_URL}</code> はアンケートURLに自動置換されます</p>
        </div>
      </div>

      <!-- 操作結果表示エリア -->
      <div id="surveyResult" class="text-sm"></div>
    </div>

    <!-- フッター -->
    <div class="bg-slate-50 px-4 py-3 flex flex-wrap gap-2 justify-end">
      <button onclick="executeSurveyDryRun()" id="surveyDryRunBtn" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition text-sm flex items-center gap-1">
        <span class="material-icons text-sm">preview</span>
        テスト実行
      </button>
      <button onclick="executeSurveySend()" id="surveySendBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm flex items-center gap-1">
        <span class="material-icons text-sm">send</span>
        送信する
      </button>
      <button onclick="closeSurveyModal()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition text-sm">
        閉じる
      </button>
    </div>
  </div>
</div>

<!-- ★出欠リマインド管理モーダル（自動送信設定UI） -->
<div id="reminderModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
  <!-- オーバーレイ -->
  <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeReminderModal()"></div>
  <!-- モーダル本体（スマホ最適化） -->
  <div class="relative bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-hidden mx-4">
    <!-- ヘッダー -->
    <div class="bg-blue-600 text-white px-4 py-3 flex items-center justify-between">
      <h3 class="text-base font-semibold flex items-center gap-2">
        <span class="material-icons text-lg">schedule_send</span>
        出欠リマインド管理
      </h3>
      <button onclick="closeReminderModal()" class="text-white hover:bg-blue-700 rounded-full p-1 transition">
        <span class="material-icons">close</span>
      </button>
    </div>

    <!-- コンテンツ -->
    <div class="p-4 overflow-y-auto max-h-[calc(90vh-110px)]">
      <!-- 次回送信予定セクション -->
      <div class="mb-5">
        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
          <span class="material-icons text-blue-500 text-base">event</span>
          次回送信予定
        </h4>
        <div id="reminderNextSchedule" class="bg-blue-50 rounded-lg p-4">
          <p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>
        </div>
      </div>

      <!-- 配信メッセージ編集セクション -->
      <div class="mb-5">
        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
          <span class="material-icons text-green-500 text-base">edit_note</span>
          <span>配信メッセージ</span>
          <button onclick="toggleMessageEdit()" id="messageEditToggle" class="ml-auto text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">
            <span class="material-icons text-sm">edit</span>
            編集
          </button>
        </h4>
        <div class="bg-slate-50 rounded-lg p-3">
          <!-- プレビュー表示（デフォルト） -->
          <div id="reminderMessagePreviewContainer">
            <div id="reminderMessagePreview" class="text-xs text-slate-600 whitespace-pre-wrap max-h-48 overflow-y-auto border border-slate-200 rounded p-3 bg-white">
              読み込み中...
            </div>
          </div>
          <!-- 編集モード（非表示） -->
          <div id="reminderMessageEditContainer" class="hidden">
            <textarea id="reminderMessageTextarea" class="w-full h-64 p-3 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y font-mono" placeholder="メッセージテンプレートを入力..."></textarea>
            <div class="flex flex-wrap gap-2 mt-2">
              <button onclick="saveReminderMessage()" id="saveMessageBtn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition flex items-center gap-1">
                <span class="material-icons text-sm">save</span>
                保存
              </button>
              <button onclick="resetReminderMessageToDefault()" class="px-3 py-1.5 bg-slate-500 hover:bg-slate-600 text-white text-xs font-medium rounded-lg transition flex items-center gap-1">
                <span class="material-icons text-sm">refresh</span>
                デフォルトに戻す
              </button>
              <button onclick="toggleMessageEdit()" class="px-3 py-1.5 bg-slate-200 hover:bg-slate-300 text-slate-700 text-xs font-medium rounded-lg transition">
                キャンセル
              </button>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-2">※ <code class="bg-slate-200 px-1 rounded">{{eventDate}}</code> と <code class="bg-slate-200 px-1 rounded">{{deadline}}</code> は自動で置換されます</p>
        </div>
      </div>

      <!-- LINE未登録者セクション -->
      <div class="mb-4">
        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
          <span class="material-icons text-amber-500 text-base">warning</span>
          LINE未登録（手動連絡）
        </h4>
        <div id="reminderNoLineMembers" class="bg-amber-50 rounded-lg p-3">
          <p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>
        </div>
      </div>

      <!-- 操作結果表示エリア -->
      <div id="reminderResult" class="text-sm"></div>

      <!-- 自動送信設定セクション（折りたたみ） -->
      <details class="mt-4">
        <summary class="text-sm font-semibold text-slate-500 cursor-pointer flex items-center gap-2 hover:text-slate-700">
          <span class="material-icons text-base">settings</span>
          自動送信設定
        </summary>
        <div id="reminderTriggerStatus" class="bg-orange-50 rounded-lg p-4 mt-2">
          <p class="text-slate-400 text-center py-2 text-sm">読み込み中...</p>
        </div>
      </details>
    </div>

    <!-- フッター -->
    <div class="bg-slate-50 px-4 py-3 flex justify-end">
      <button onclick="closeReminderModal()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition text-sm">
        閉じる
      </button>
    </div>
  </div>
</div>

<!-- 改善リクエストモーダル -->
<div id="requestModal" class="request-modal">
  <div class="request-modal-overlay" onclick="closeRequestModal()"></div>
  <div class="request-modal-content">
    <div class="request-modal-title">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      改善リクエスト
    </div>
    <div class="request-form-group">
      <label class="request-form-label">カテゴリ</label>
      <select id="requestCategory" class="request-form-select">
        <option value="バグ報告">バグ報告</option>
        <option value="機能要望">機能要望</option>
        <option value="改善提案">改善提案</option>
        <option value="その他">その他</option>
      </select>
    </div>
    <div class="request-form-group">
      <label class="request-form-label">内容</label>
      <textarea id="requestContent" class="request-form-textarea" rows="5" placeholder="リクエスト内容を入力してください"></textarea>
      <p id="requestError" class="request-form-error">内容を入力してください</p>
    </div>
    <div class="request-modal-buttons">
      <button class="request-btn-cancel" onclick="closeRequestModal()">キャンセル</button>
      <button id="requestSubmitBtn" class="request-btn-submit" onclick="submitRequest()">送信</button>
    </div>
  </div>
</div>

<script>
function showRequestToast(message, type) {
  var toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = 'position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);padding:0.75rem 1.5rem;border-radius:8px;font-size:0.875rem;font-weight:500;z-index:9999;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;'
    + (type === 'error' ? 'background:#dc2626;' : 'background:#0d9488;');
  document.body.appendChild(toast);
  setTimeout(function() { toast.style.opacity = '0'; }, 2500);
  setTimeout(function() { toast.remove(); }, 2800);
}

function openRequestModal() {
  document.getElementById('requestModal').classList.add('active');
  document.getElementById('requestContent').value = '';
  document.getElementById('requestError').classList.remove('show');
  document.getElementById('requestSubmitBtn').disabled = false;
  document.getElementById('requestSubmitBtn').textContent = '送信';
}

function closeRequestModal() {
  document.getElementById('requestModal').classList.remove('active');
}

function submitRequest() {
  const category = document.getElementById('requestCategory').value;
  const content = document.getElementById('requestContent').value.trim();
  const errorEl = document.getElementById('requestError');
  const submitBtn = document.getElementById('requestSubmitBtn');

  if (!content) {
    errorEl.classList.add('show');
    return;
  }
  errorEl.classList.remove('show');

  submitBtn.disabled = true;
  submitBtn.textContent = '送信中...';

  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.success) {
        closeRequestModal();
        showRequestToast('リクエストを送信しました', 'success');
      } else {
        submitBtn.disabled = false;
        submitBtn.textContent = '送信';
        showRequestToast(result && result.error ? result.error : '送信に失敗しました', 'error');
      }
    })
    .withFailureHandler(function(err) {
      submitBtn.disabled = false;
      submitBtn.textContent = '送信';
      showRequestToast('送信中にエラーが発生しました', 'error');
    })
    .submitSystemRequest({ category: category, content: content });
}
</script>

</body>
</html>
