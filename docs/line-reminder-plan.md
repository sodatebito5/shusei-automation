# LINE出欠リマインダー送信システム - 実装計画

## 概要

月末に翌月例会の出欠未回答者へLINEリマインダーを自動送信する機能を追加。

## 修正対象ファイル

| ファイル | 変更内容 |
|----------|----------|
| `gas/attendance/attendance.gs` | 関数追加・メニュー拡張 |
| 設定シート（Googleスプレッドシート） | J2セル（回答期限）追加 |

---

## 実装内容

### 1. 追加する定数（attendance.gs冒頭）

```javascript
const MEMBER_MASTER_SHEET_NAME = '会員名簿マスター';
const LINE_MESSAGE_LIMIT = 200;  // LINE無料枠
```

### 2. 追加する関数

| 関数名 | 用途 |
|--------|------|
| `getNextEventInfo_()` | 翌月例会情報取得（eventKey, 開催日, 回答期限） |
| `getUnrespondedMembers_(eventKey)` | 未回答者リスト取得（LINE ID有りのみ） |
| `buildReminderMessage_(eventDate, deadline)` | メッセージ生成 |
| `sendAttendanceReminder()` | 本番送信（トリガー/メニュー用） |
| `sendAttendanceReminderDryRun()` | テスト実行（送信なし） |

### 3. 処理フロー

```
[月末トリガー or メニュー]
    ↓
[getNextEventInfo_()] ← 設定シート F2, G2, J2
    ↓
[getUnrespondedMembers_(eventKey)]
  ├─ 会員名簿マスター（C列氏名, P列userId）
  └─ 出欠状況（自動）（B列eventKey, C列userId）
    ↓
[buildReminderMessage_()]
    ↓
[pushLineMessage() × N回] ← 100ms間隔
    ↓
[管理者へ結果通知]
```

### 4. メニュー拡張（onOpen）

```
管理者専用メニュー
├─ 式次第を更新
├─ 未回答者は誰だ
├─ ─────────────
├─ リマインダー送信（テスト）  ← 新規
└─ リマインダー送信（本番）    ← 新規
```

### 5. 設定シート変更

- **J2セル**: 回答期限（Date型）
  - 空欄の場合は開催日前日を自動計算

### 6. トリガー設定（GASエディタで手動）

- 関数: `sendAttendanceReminder`
- タイプ: 月ベースのタイマー
- 日: 月末
- 時刻: 9:00〜10:00

---

## メッセージテンプレート

```
【出欠回答のお願い】

いつもお世話になっております。
守成クラブ福岡飯塚 事務局です。

※本メッセージと行き違いで
　すでにご回答済みの場合は
　何卒ご容赦ください。

次回例会の出欠につきまして、
まだご回答をいただいておりません。

━━━━━━━━━━━━━━━━━━
■ 例会日程
　{自動挿入: M月d日（E）}

■ 回答期限
　{自動挿入: M月d日（E）}

■ ご注意
　期限を過ぎますと
　自動的に「出席」扱いとなります。

　その後のキャンセルには
　キャンセル料 4,000円が発生いたします。
━━━━━━━━━━━━━━━━━━

画面下部のリッチメニューより
「例会出欠」ボタンを押して
ご回答をお願いいたします。

よろしくお願いいたします。
```

---

## 実装ステップ

1. 定数追加
2. ヘルパー関数追加（`getNextEventInfo_`, `getUnrespondedMembers_`, `buildReminderMessage_`）
3. メイン関数追加（`sendAttendanceReminder`, `sendAttendanceReminderDryRun`）
4. `onOpen()` メニュー拡張
5. 設定シートにJ2（回答期限）を追加
6. ドライランでテスト
7. 本番テスト（自分宛に1通）
8. GASエディタでトリガー設定

---

## 検証方法

1. **ドライラン確認**
   - スプレッドシート → 管理者専用 → リマインダー送信（テスト）
   - 未回答者数とリストが正しいことを確認

2. **本番テスト**
   - 少人数の状態でリマインダー送信（本番）を実行
   - 自分のLINEにメッセージが届くことを確認
   - 管理者への結果通知を確認

3. **トリガー確認**
   - GASエディタでトリガー設定後、実行履歴を確認

---

## 注意事項

- LINE無料枠は月200通（超過時は有料プラン検討）
- 既存の`pushLineMessage()`関数をそのまま再利用
- API制限対策で100ms間隔で送信
