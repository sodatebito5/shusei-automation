<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>売上報告</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      margin: 0; padding: 16px; background: #ffffff;
      -webkit-text-size-adjust: 100%;
    }
    .card {
      border: 1px solid #e5e7eb; border-radius: 14px; padding: 18px;
      max-width: 640px; margin: 0 auto;
      background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .note { font-size: 12px; color: #6b7280; margin: 0 0 12px; }
    .row { display: grid; gap: 10px; margin-bottom: 14px; }
    label { font-size: 14px; color: #374151; }
    input, select {
      width: 100%; max-width: 100%;
      padding: 12px 12px;
      border: 1px solid #d1d5db; border-radius: 10px;
      font-size: 16px; background: #fff;
      appearance: none; -webkit-appearance: none;
      line-height: 1.3;
    }
    input[type="date"] { padding-right: 36px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 420px) { .grid-2 { grid-template-columns: 1fr; } }
    .btn { width: 100%; padding: 14px; border: 0; border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; }
    .btn-primary { background: #06c755; color: #fff; }
    .btn-ghost { background: #f3f4f6; color: #111827; }
    .btn + .btn { margin-top: 8px; }
    #status { margin-top: 6px; min-height: 22px; }
    .ok { color: #0a7f3f; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; white-space: pre-line; }
    
    /* ★ 完了画面用スタイル追加 */
    .hidden { display: none; }
    .complete-screen {
      text-align: center;
      padding: 40px 20px;
    }
    .complete-screen h2 {
      font-size: 24px;
      color: #06c755;
      margin: 0 0 12px;
    }
    .complete-screen p {
      font-size: 14px;
      color: #6b7280;
      margin: 0 0 24px;
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- ★ フォーム画面 -->
    <div id="formScreen">
      <h1>売上報告フォーム</h1>
      <p class="note">必要項目を入力してください。</p>

      <div class="row">
        <label>報告日 <span class="note">（自動で本日が入ります。空でも送信可）</span></label>
        <input type="date" id="report_date" />
      </div>

      <div class="row">
        <label style="font-weight:700">成約・売上</label>
        <div class="grid-2">
          <div class="row" style="margin:0">
            <label>成約件数</label>
            <input type="number" inputmode="numeric" id="deals_count" placeholder="例：1" />
          </div>
          <div class="row" style="margin:0">
            <label>売上金額（円）</label>
            <input type="number" inputmode="numeric" id="sales_amount" placeholder="例：30000" />
          </div>
        </div>
      </div>

      <div class="row">
        <label style="font-weight:700">例会関連</label>
      </div>

      <div class="row">
        <label>次回同席希望（名前） <span class="note">複数はカンマ区切りOK</span></label>
        <input type="text" id="join_next_seat" placeholder="例：田中太郎, 山田花子" />
      </div>

      <div class="row">
        <label>入会して欲しい業種 <span class="note">カンマ区切りOK</span></label>
        <input type="text" id="desired_industry" placeholder="例：建設, 介護, 士業" />
      </div>

      <div class="row">
        <label>次回ゲスト紹介ありますか？</label>
        <select id="next_guest">
          <option value="">選択してください</option>
          <option value="あり">あり</option>
          <option value="なし">なし</option>
        </select>
      </div>

      <div class="row">
        <button class="btn btn-primary" id="submitBtn">送信する</button>
        <button class="btn btn-ghost" id="closeBtn">閉じる</button>
      </div>

      <div id="status"></div>
    </div>

    <!-- ★ 完了画面（最初は非表示） -->
    <div id="completeScreen" class="complete-screen hidden">
      <h2>売上報告完了！</h2>
      <p>報告内容をシートに反映しました。</p>
      <button class="btn btn-primary" id="closeCompleteBtn">閉じる</button>
    </div>
  </div>

<script>
/* ===== LIFF / GAS 設定 ===== */
const LIFF_ID      = '2008299790-J3WnAP3j';
const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw_K0031SKFJbEeaG0OUYqW4grvWNnQ5briAdAvDlKpvrcB5Uek5h-SxtxxC9qdqDPC2w/exec';
const API_KEY      = 'shusei_2025_secret_1016';

const setStatus = (msg, err=false) => {
  document.getElementById('status').innerHTML = err
    ? `<span class="err">${msg}</span>`
    : `<span class="ok">${msg}</span>`;
};

/* 本日を端末ローカルタイムで自動入力 */
function setTodayLocal() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  document.getElementById('report_date').value = `${y}-${m}-${day}`;
}

/* ★ 画面切り替え関数 */
function showCompleteScreen() {
  document.getElementById('formScreen').classList.add('hidden');
  document.getElementById('completeScreen').classList.remove('hidden');
}

/* LIFF初期化 */
async function init() {
  try {
    setTodayLocal();

    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login({ scope: ['openid','profile'] }); return; }

    try { window.__lineProfile = await liff.getProfile(); } catch (e) {}

    document.getElementById('submitBtn').addEventListener('click', submit);
    
    // ★ 両方の閉じるボタンにイベント設定
    document.getElementById('closeBtn').addEventListener('click', closeLiff);
    document.getElementById('closeCompleteBtn').addEventListener('click', closeLiff);
  } catch (e) {
    setStatus('初期化エラー：' + String(e), true);
  }
}

/* ★ 閉じる処理 */
function closeLiff() {
  if (liff.isInClient()) {
    liff.closeWindow();
  } else {
    window.close();
  }
}

/* 送信処理 */
async function submit() {
  const btn = document.getElementById('submitBtn');
  try {
    btn.disabled = true;
    setStatus('送信中...'); // ★ ローディング表示

    const p = window.__lineProfile || {};
    const payload = {
      api_key: API_KEY,
      line_user_id: p.userId || '',
      display_name: p.displayName || '',
      report_date: (document.getElementById('report_date').value || '').trim(),
      deals_count: (document.getElementById('deals_count').value || '').trim(),
      sales_amount: (document.getElementById('sales_amount').value || '').trim(),
      join_next_seat: (document.getElementById('join_next_seat').value || '').trim(),
      desired_industry: (document.getElementById('desired_industry').value || '').trim(),
      next_guest: (document.getElementById('next_guest').value || '').trim()
    };

    const res = await fetch(GAS_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });

    let text = '', data = null;
    try { text = await res.text(); data = JSON.parse(text); } catch (_) {}

    if (res.ok && data && data.ok) {
      // ★ 成功時は完了画面に切り替え
      showCompleteScreen();
    } else {
      setStatus('送信失敗：' + (data?.error || text || `HTTP ${res.status}`), true);
    }
  } catch (e) {
    setStatus('通信エラー：' + String(e), true);
  } finally {
    btn.disabled = false;
  }
}

init();
</script>
</body>
</html>