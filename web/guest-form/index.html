<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ゲスト申請フォーム</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN",
                   "Yu Gothic", sans-serif;
      background: #f7f7f7;
    }
    .card {
      max-width: 640px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }
    .subtitle {
      font-size: 12px;
      color: #666;
      margin-bottom: 16px;
    }
    label {
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin: 12px 0 4px;
    }
    .required-badge {
      display: inline-block;
      margin-left: 6px;
      padding: 0 6px;
      font-size: 10px;
      border-radius: 8px;
      background: #ef4444;
      color: #fff;
    }
    .optional-badge {
      display: inline-block;
      margin-left: 6px;
      padding: 0 6px;
      font-size: 10px;
      border-radius: 8px;
      background: #e5e7eb;
      color: #374151;
    }
    select, input[type="text"], textarea, input[type="file"] {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #d4d4d4;
      outline: none;
    }
    select:focus,
    input:focus,
    textarea:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 1px rgba(22,163,74,0.15);
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .checkbox-group {
      margin-top: 8px;
      padding: 8px 10px;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
      font-size: 12px;
      line-height: 1.4;
    }
    .checkbox-row input {
      margin-top: 0;
    }
    .checkbox-row label {
      flex: 1;
    }

    .helper {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    .btn {
      width: 100%;
      margin-top: 20px;
      padding: 10px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 999px;
      background: #16a34a;
      color: #fff;
      cursor: pointer;
    }
    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .status {
      margin-top: 12px;
      font-size: 13px;
    }
    .status.ok { color: #16a34a; }
    .status.err { color: #dc2626; }

    .hidden { display: none; }

    #done-card {
      text-align: center;
    }
    .done-title {
      font-size: 22px;
      font-weight: 700;
      color: #16a34a;
      margin-bottom: 12px;
    }
    .done-message {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 20px;
    }
    .btn-secondary {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 999px;
      background: #e5e7eb;
      color: #111827;
      cursor: pointer;
      margin-top: 12px;
    }

    .upload-block {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    .upload-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .preview-img {
      max-width: 100%;
      max-height: 150px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>

<body>
  <!-- -------------- ページ1：入力フォーム -------------- -->
  <div class="card" id="form-card">
    <h1>ゲスト申請フォーム</h1>
    <div class="subtitle">
      福岡飯塚会場のゲスト申請フォームです。<br>
      必須項目の入力とチェック項目への同意が必要です。
    </div>

    <label>
      1. どの例会
      <span class="required-badge">必須</span>
    </label>
    <select id="event-select">
      <option value="">選択してください</option>
    </select>
    <div class="helper" id="event-helper"></div>

    <label>
      2. ゲスト氏名
      <span class="required-badge">必須</span>
    </label>
    <input id="guest-name" />

    <label>
      3. ゲスト氏名フリガナ
      <span class="required-badge">必須</span>
    </label>
    <input id="guest-kana" placeholder="ヤマダ タロウ" />

    <label>
      4. 会社名
      <span class="required-badge">必須</span>
    </label>
    <input id="company" placeholder="株式会社〇〇" />

    <label>
      5. 役職（肩書き）
      <span class="required-badge">必須</span>
    </label>
    <input id="title" placeholder="代表取締役 / 部長 など" />

    <input id="introducer" type="hidden" />

    <label>
      6. 営業内容
      <span class="required-badge">必須</span>
    </label>
    <textarea id="business" placeholder="事業内容をご記入ください。"></textarea>

    <label>
      申請前に以下内容にチェックしてください。
      <span class="required-badge">必須</span>
    </label>

    <div class="checkbox-group">
      <div class="checkbox-row">
        <input type="checkbox" id="chk-1" />
        <label for="chk-1">お連れするゲストさんに決済権はありますか？</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="chk-2" />
        <label for="chk-2">
          政治的・宗教的・非社会的な活動を目的とした入会は不可である旨説明しましたか？
        </label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="chk-3" />
        <label for="chk-3">同一人物のゲスト参加は1回のみである旨説明しましたか？</label>
      </div>
    </div>

    <button id="to-card-page-btn" class="btn" disabled>
      名刺添付画面に進む
    </button>
  </div>

  <!-- -------------- ページ2：名刺添付 -------------- -->
  <div class="card hidden" id="card-card">
    <h1>名刺の添付</h1>
    <div class="subtitle">
      表面は必須、裏面は任意です。<br>
      撮影または画像ファイルで添付してください。
    </div>

    <div class="upload-block">
      <div class="upload-label-row">
        <span>表面</span>
        <span class="required-badge">必須</span>
      </div>
      <input id="card-front" type="file" accept="image/*" />
      <div id="card-front-preview" class="helper"></div>
    </div>

    <div class="upload-block">
      <div class="upload-label-row">
        <span>裏面</span>
        <span class="optional-badge">任意</span>
      </div>
      <input id="card-back" type="file" accept="image/*" />
      <div id="card-back-preview" class="helper"></div>
    </div>

    <button id="submit-btn" class="btn" disabled>
      ゲストを申請します
    </button>
    <div id="status" class="status"></div>

    <button id="back-to-form-btn" class="btn-secondary" type="button">
      入力画面に戻る
    </button>
  </div>

  <!-- -------------- 完了画面 -------------- -->
  <div class="card hidden" id="done-card">
    <div class="done-title">ゲスト申請完了！</div>

    <p class="done-message">
      役員にて協議いたします。<br>
      結果をお知らせするまでお待ちください。
    </p>

    <button id="close-btn" class="btn-secondary">閉じる</button>
  </div>

  <!-- -------------- JS -------------- -->
  <script>
    const LIFF_ID = '2008498539-Ak3Vxy1X';

    const GAS_ENDPOINT_URL =
'https://script.google.com/macros/s/AKfycbxvtSiPkQSl1Gf3Xc8bQsUeBnrw6NT8QYQZbMYBISENkTB9ahk16GPcevEW_bNVpEYq/exec';

    const $ = (id) => document.getElementById(id);
    let lineUserId = '';
    let lineDisplayName = '';

    // 名刺Base64データ
    let cardFrontBase64 = '';
    let cardBackBase64 = '';

    /* --- ファイルをBase64に変換 --- */
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /* --- 例会日を計算（2月のみ第1水曜、それ以外は第2水曜） --- */
function getMeetingWednesday(year, monthIndex) {
  const first = new Date(year, monthIndex, 1);
  const diff = (3 - first.getDay() + 7) % 7;
  
  // 2月（monthIndex = 1）は第1水曜日
  if (monthIndex === 1) {
    return new Date(year, monthIndex, 1 + diff);
  }
  
  // それ以外は第2水曜日
  return new Date(year, monthIndex, 1 + diff + 7);
}

    /* --- プルダウン設定 --- */
    function setupEventSelect() {
      const select = $('event-select');
      const helper = $('event-helper');

      const today = new Date();
      let year = today.getFullYear();
      let month = today.getMonth();

      let startOffset = 0;
      if (getMeetingWednesday(year, month) < new Date(year, month, today.getDate())) {
        startOffset = 1;
      }

      for (let i = startOffset; i <= startOffset + 2; i++) {
        const m = month + i;
        const y = year + Math.floor(m / 12);
        const mi = (m + 12) % 12;
        const d = getMeetingWednesday(y, mi);

        const labelMonth = mi + 1;
        const dateStr = `${y}年${labelMonth}月${d.getDate()}日（水）`;
        const label = `${dateStr} ${labelMonth}月例会`;
        const value = `${y}年${labelMonth}月例会`;

        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = label;
        select.appendChild(opt);
      }

      helper.textContent = '※ 福岡飯塚会場（第2水曜日）／最大2ヶ月先まで選択可能';
    }

    /* --- 名刺（表面）変更時 --- */
    async function onCardFrontChange() {
      const input = $('card-front');
      const preview = $('card-front-preview');

      if (input.files && input.files[0]) {
        const file = input.files[0];
        preview.innerHTML = `選択中：${file.name}`;
        
        try {
          cardFrontBase64 = await fileToBase64(file);
          const img = document.createElement('img');
          img.src = cardFrontBase64;
          img.className = 'preview-img';
          preview.appendChild(img);
        } catch (e) {
          console.error('Base64変換エラー', e);
          cardFrontBase64 = '';
        }
      } else {
        preview.innerHTML = '';
        cardFrontBase64 = '';
      }
      validateStep2();
    }

    /* --- 名刺（裏面）変更時 --- */
    async function onCardBackChange() {
      const input = $('card-back');
      const preview = $('card-back-preview');

      if (input.files && input.files[0]) {
        const file = input.files[0];
        preview.innerHTML = `選択中：${file.name}`;
        
        try {
          cardBackBase64 = await fileToBase64(file);
          const img = document.createElement('img');
          img.src = cardBackBase64;
          img.className = 'preview-img';
          preview.appendChild(img);
        } catch (e) {
          console.error('Base64変換エラー', e);
          cardBackBase64 = '';
        }
      } else {
        preview.innerHTML = '';
        cardBackBase64 = '';
      }
    }

    /* --- 入力チェック（ページ1） --- */
    function validateStep1() {
      const ok =
        $('event-select').value &&
        $('guest-name').value.trim() &&
        $('guest-kana').value.trim() &&
        $('company').value.trim() &&
        $('title').value.trim() &&
        $('business').value.trim() &&
        $('chk-1').checked &&
        $('chk-2').checked &&
        $('chk-3').checked;

      $('to-card-page-btn').disabled = !ok;
    }

    /* --- 入力チェック（ページ2） --- */
    function validateStep2() {
      const ok = cardFrontBase64 !== '';
      $('submit-btn').disabled = !ok;
    }

    /* --- 送信 --- */
async function onSubmit() {
  $('submit-btn').disabled = true;
  $('status').textContent = '送信中です…';
  $('status').className = 'status';

  const payload = {
    mode: 'guest',
    eventKey: $('event-select').value,
    name: $('guest-name').value.trim(),
    kana: $('guest-kana').value.trim(),
    company: $('company').value.trim(),
    title: $('title').value.trim(),
    business: $('business').value.trim(),
    lineUserId: lineUserId,
    displayName: lineDisplayName,
    introducer: $('introducer').value.trim(),
    cardFront: cardFrontBase64,
    cardBack: cardBackBase64
  };

  try {
    const res = await fetch(GAS_ENDPOINT_URL, {
      method: 'POST',
      body: JSON.stringify(payload)  // ← headersなし！
    });

        const text = await res.text();
        console.log('GAS res status=', res.status, 'body=', text);

        let json = null;
        try {
          json = JSON.parse(text);
        } catch (e) {}

        if (!res.ok || (json && json.success === false)) {
          const msg = (json && json.error) || ('サーバーエラー: ' + res.status);
          $('status').textContent = msg;
          $('status').className = 'status err';
          $('submit-btn').disabled = false;
          return;
        }

        $('form-card').classList.add('hidden');
        $('card-card').classList.add('hidden');
        $('done-card').classList.remove('hidden');
      } catch (e) {
        console.error('fetch error', e);
        $('status').textContent = '通信エラーが発生しました。';
        $('status').className = 'status err';
        $('submit-btn').disabled = false;
      }
    }

    /* --- 閉じるボタン --- */
    function onClose() {
      if (liff.isInClient()) {
        liff.closeWindow();
      } else {
        window.close();
      }
    }

    /* --- LIFF 初期化 --- */
    async function initLiff() {
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      lineDisplayName = profile.displayName || '';
      $('introducer').value = lineDisplayName;

      try {
        const ctx = liff.getContext();
        if (ctx && ctx.userId) lineUserId = ctx.userId;
      } catch {}

      validateStep1();
    }

    /* --- 初期化 --- */
    document.addEventListener('DOMContentLoaded', () => {
      setupEventSelect();
      initLiff();

      [
        'event-select',
        'guest-name',
        'guest-kana',
        'company',
        'title',
        'business',
        'chk-1',
        'chk-2',
        'chk-3'
      ].forEach(id => {
        const el = $(id);
        if (!el) return;
        const evt = (el.type === 'checkbox' || el.tagName === 'SELECT') ? 'change' : 'input';
        el.addEventListener(evt, validateStep1);
      });

      $('to-card-page-btn').addEventListener('click', () => {
        $('form-card').classList.add('hidden');
        $('card-card').classList.remove('hidden');
      });

      $('back-to-form-btn').addEventListener('click', () => {
        $('card-card').classList.add('hidden');
        $('form-card').classList.remove('hidden');
      });

      $('card-front').addEventListener('change', onCardFrontChange);
      $('card-back').addEventListener('change', onCardBackChange);

      $('submit-btn').addEventListener('click', onSubmit);
      $('close-btn').addEventListener('click', onClose);
    });
  </script>
</body>
</html>